<!DOCTYPE html>
<html>
<head>
    <title>Audio Generation Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1f2937; color: white; }
        .step { margin: 20px 0; padding: 15px; background: #374151; border-radius: 8px; }
        .step h3 { color: #3b82f6; margin-top: 0; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        .story-content { background: #111827; padding: 15px; border-radius: 5px; font-size: 14px; line-height: 1.6; white-space: pre-line; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #065f46; border: 1px solid #10b981; }
        .error { background: #7f1d1d; border: 1px solid #ef4444; }
        .warning { background: #78350f; border: 1px solid #f59e0b; }
        input[type="password"] { width: 300px; padding: 8px; margin: 5px; border: 1px solid #6b7280; border-radius: 4px; background: #374151; color: white; }
    </style>
</head>
<body>
    <h1>üéµ Audio Generation Debug Test</h1>
    
    <div class="step">
        <h3>Step 1: API Key Configuration</h3>
        <p>Enter your OpenAI API key to test audio generation:</p>
        <input type="password" id="apiKey" placeholder="sk-..." />
        <button onclick="testApiKey()">Test API Key</button>
        <div id="apiResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Test Story Content</h3>
        <p>Sample story with dialogue for testing:</p>
        <div class="story-content" id="testStory">Sarah walked into the coffee shop nervously.

"Welcome to Moonlight Caf√©," called out the barista. "What can I get you today?"

"I'll have a large coffee, black," Sarah replied, scanning the room.

A tall man approached her table. "Sarah? I'm Agent Johnson. We need to talk."

"About what exactly?" Sarah asked, her voice trembling.

"The files you discovered," Johnson said quietly. "They're more important than you realize."
        </div>
        <button onclick="testDialogueExtraction()">Test Dialogue Extraction</button>
        <div id="dialogueResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="step">
        <h3>Step 3: Direct OpenAI TTS Test</h3>
        <p>Test direct API call to OpenAI TTS service:</p>
        <button onclick="testDirectTTS()" id="ttsBtn" disabled>Test TTS API Call</button>
        <div id="ttsResult" class="result" style="display: none;"></div>
        <audio id="testAudio" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
    </div>
    
    <div class="step">
        <h3>Step 4: Full Pipeline Test</h3>
        <p>Test the complete multi-voice generation pipeline:</p>
        <button onclick="openMainApp()" style="background: #059669;">Open Main App for Full Test</button>
        <p class="text-sm text-gray-400">Use the story content above in the main application.</p>
    </div>

    <script>
        let currentApiKey = '';
        
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('apiResult');
            
            if (!apiKey) {
                showResult('apiResult', 'Please enter an API key', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showResult('apiResult', 'Invalid API key format. Should start with "sk-"', 'error');
                return;
            }
            
            currentApiKey = apiKey;
            
            // Test API key by making a simple request
            try {
                showResult('apiResult', 'Testing API key...', 'warning');
                
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    showResult('apiResult', '‚úÖ API key is valid!', 'success');
                    document.getElementById('ttsBtn').disabled = false;
                } else {
                    const error = await response.text();
                    showResult('apiResult', `‚ùå API key validation failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                showResult('apiResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        function testDialogueExtraction() {
            const content = document.getElementById('testStory').textContent;
            
            // Simple dialogue extraction test
            const dialoguePattern = /"([^"]+)"/g;
            const matches = [...content.matchAll(dialoguePattern)];
            
            if (matches.length > 0) {
                const dialogues = matches.map(match => match[1]);
                showResult('dialogueResult', `‚úÖ Found ${dialogues.length} dialogue segments:\\n${dialogues.map((d, i) => `${i+1}. "${d}"`).join('\\n')}`, 'success');
            } else {
                showResult('dialogueResult', '‚ùå No dialogue found in test content', 'error');
            }
        }
        
        async function testDirectTTS() {
            if (!currentApiKey) {
                showResult('ttsResult', 'Please test API key first', 'error');
                return;
            }
            
            const testText = "Hello, this is a test of the OpenAI text-to-speech system.";
            
            try {
                showResult('ttsResult', 'Generating test audio...', 'warning');
                
                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1-hd',
                        input: testText,
                        voice: 'alloy',
                        response_format: 'mp3'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const audio = document.getElementById('testAudio');
                    audio.src = audioUrl;
                    audio.style.display = 'block';
                    
                    showResult('ttsResult', `‚úÖ Audio generated successfully! Size: ${blob.size} bytes. Play audio below.`, 'success');
                } else {
                    const error = await response.text();
                    showResult('ttsResult', `‚ùå TTS API failed: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                showResult('ttsResult', `‚ùå TTS generation error: ${error.message}`, 'error');
            }
        }
        
        function openMainApp() {
            window.open('../index.html', '_blank');
        }
        
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>