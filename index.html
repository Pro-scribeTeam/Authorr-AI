<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTHORR AI - AI-Powered Audiobook Creation Platform</title>
    <meta name="description" content="Create professional audiobooks with AI-powered writing, chapter generation, and text-to-speech narration. AUTHORR AI - Your complete audiobook creation solution.">
    <meta name="keywords" content="audiobook creation, AI writing, text to speech, book generation, storytelling, AI narration">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* AUTHORR AI Brand Colors - Cyan, Silver, Black, White */
        :root {
          --brand-cyan: #78e3fe;
          --brand-cyan-hover: #5dd8fc;
          --brand-silver: #C0C0C0;
          --brand-black: #000000;
          --brand-white: #FFFFFF;
          --brand-cyan-glow: 0 0 15px rgba(120, 227, 254, 0.6), 0 0 30px rgba(120, 227, 254, 0.3);
          --brand-silver-glow: 0 0 10px rgba(192, 192, 192, 0.8), 0 0 20px rgba(192, 192, 192, 0.4);
        }
        
        .authorr-brand-text {
          background: linear-gradient(135deg, #78e3fe, #5dd8fc);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          text-shadow: 0 0 10px rgba(120, 227, 254, 0.3);
          font-weight: 800;
          letter-spacing: 0.05em;
        }
        
        .logo-image {
          filter: drop-shadow(0 0 10px rgba(120, 227, 254, 0.4));
          animation: logoPulse 3s ease-in-out infinite alternate;
        }
        
        @keyframes logoPulse {
          0% { filter: drop-shadow(0 0 10px rgba(120, 227, 254, 0.4)); }
          100% { filter: drop-shadow(0 0 15px rgba(120, 227, 254, 0.6)); }
        }
        
        /* AI Writing Tools Button Styling - BLACK BACKGROUND, WHITE TEXT, GOLD GLOW */
        .ai-writing-tool-btn {
          background: #000000 !important;
          color: #ffffff !important;
          border: 2px solid #ffd700 !important;
          box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3) !important;
          font-weight: 600;
          transition: all 0.3s ease;
        }
        
        .ai-writing-tool-btn:hover {
          background: #1a1a1a !important;
          border-color: #ffed4a !important;
          box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 0 30px rgba(255, 215, 0, 0.4) !important;
          transform: translateY(-1px);
        }
        
        /* Chapter Editing Tools Styling */
        .tool-btn {
          background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
          color: #e2e8f0 !important;
          border: 1px solid #475569 !important;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
          font-weight: 500;
          transition: all 0.3s ease;
          position: relative;
        }
        
        .tool-btn:hover {
          background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%) !important;
          border-color: #0284c7 !important;
          box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4) !important;
          transform: translateY(-1px);
          color: #ffffff !important;
        }
        
        .tool-info {
          position: absolute;
          top: -8px;
          right: -8px;
          width: 16px;
          height: 16px;
          background: #3b82f6;
          color: white;
          border-radius: 50%;
          font-size: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: help;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .tool-info:hover {
          background: #1d4ed8;
          transform: scale(1.1);
        }
        
        /* Theme Support */
        .theme-light {
          --bg-primary: #ffffff;
          --bg-secondary: #f8fafc;
          --text-primary: #1a202c;
          --text-secondary: #4a5568;
          --border-color: #e2e8f0;
        }
        
        .theme-dark {
          --bg-primary: #1a202c;
          --bg-secondary: #2d3748;
          --text-primary: #ffffff;
          --text-secondary: #cbd5e0;
          --border-color: #4a5568;
        }
        
        body {
          background-color: var(--bg-primary);
          color: var(--text-primary);
        }
        
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background-color: var(--bg-secondary); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Navigation Styling */
        .nav-item {
          color: white !important;
          border: 2px solid transparent;
          transition: all 0.3s ease;
        }
        
        .nav-item:hover, .nav-item.active {
          border-color: var(--brand-cyan);
          box-shadow: var(--brand-cyan-glow);
          background: rgba(120, 227, 254, 0.1);
        }
        
        /* Glow Effects */
        .cyan-glow { box-shadow: var(--brand-cyan-glow); }
        .silver-glow { box-shadow: var(--brand-silver-glow); }
        
        /* Form Enhancements */
        .form-field {
          border: 2px solid var(--border-color);
          transition: all 0.3s ease;
        }
        
        .form-field:focus {
          border-color: var(--brand-cyan);
          box-shadow: 0 0 10px rgba(120, 227, 254, 0.3);
          outline: none;
        }
        
        /* Button Styles */
        .btn-primary {
          background: linear-gradient(135deg, var(--brand-cyan), var(--brand-cyan-hover));
          color: white;
          border: none;
          transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: var(--brand-cyan-glow);
        }
        
        .btn-secondary {
          background: var(--brand-silver);
          color: var(--brand-black);
          border: 2px solid var(--brand-silver);
          transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
          background: transparent;
          color: var(--brand-silver);
          box-shadow: var(--brand-silver-glow);
        }
        
        /* Loading Animation */
        .loading-spinner {
          border: 3px solid rgba(120, 227, 254, 0.3);
          border-radius: 50%;
          border-top: 3px solid var(--brand-cyan);
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Book Flipping Animation */
        .book-loader {
          position: relative;
          width: 80px;
          height: 60px;
          margin: 0 auto;
        }
        
        .book-pages {
          position: absolute;
          width: 100%;
          height: 100%;
          background: linear-gradient(45deg, var(--brand-cyan), var(--brand-silver));
          border-radius: 4px;
          transform-origin: left center;
          animation: flip-pages 2s ease-in-out infinite;
        }
        
        .book-pages:nth-child(1) { animation-delay: 0s; z-index: 3; }
        .book-pages:nth-child(2) { animation-delay: 0.4s; z-index: 2; }
        .book-pages:nth-child(3) { animation-delay: 0.8s; z-index: 1; }
        
        .book-spine {
          position: absolute;
          left: -2px;
          top: 0;
          width: 4px;
          height: 100%;
          background: var(--brand-gold);
          border-radius: 2px;
          z-index: 4;
        }
        
        @keyframes flip-pages {
          0%, 20% {
            transform: rotateY(0deg);
            opacity: 1;
          }
          50% {
            transform: rotateY(-90deg);
            opacity: 0.7;
          }
          80%, 100% {
            transform: rotateY(-180deg);
            opacity: 0.3;
          }
        }
        
        .loading-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 16px;
        }
        
        /* Word Count Display */
        .word-count {
          position: absolute;
          bottom: 10px;
          right: 15px;
          background: rgba(120, 227, 254, 0.1);
          color: var(--brand-cyan);
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
        }
        
        /* Editable Elements */
        .editable-title:focus, .editable-summary:focus {
          background-color: rgba(120, 227, 254, 0.1) !important;
          border-radius: 4px;
          padding: 2px;
          outline: 2px solid var(--brand-cyan);
        }
        
        /* Chapter Status */
        .chapter-status {
          font-size: 10px;
          margin-top: 4px;
          padding: 2px 6px;
          border-radius: 12px;
          text-align: center;
        }
        
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
        .status-generating { background: rgba(251, 191, 36, 0.2); color: #d97706; }
        .status-complete { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
        
        /* Error States */
        .error-border { border-color: #ef4444 !important; }
        .error-text { color: #ef4444; }
        
        /* Success States */
        .success-border { border-color: #10b981 !important; }
        .success-text { color: #10b981; }
        
        /* Sound Wave Animation */
        .sound-wave-container {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
          background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(34, 197, 94, 0.1));
          border-radius: 12px;
          border: 1px solid rgba(6, 182, 212, 0.3);
          width: fit-content;
          margin: 0 auto;
        }
        
        .sound-wave {
          display: flex;
          align-items: center;
          gap: 4px;
        }
        
        .wave-bar {
          width: 8px;
          height: 20px;
          background: linear-gradient(to top, #06b6d4, #10b981);
          border-radius: 4px;
          animation: wave 1.5s ease-in-out infinite;
          transform-origin: bottom;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { animation-delay: 0.3s; }
        .wave-bar:nth-child(7) { animation-delay: 0.2s; }
        .wave-bar:nth-child(8) { animation-delay: 0.1s; }
        
        @keyframes wave {
          0%, 100% { 
            transform: scaleY(1);
            background: linear-gradient(to top, #06b6d4, #10b981);
          }
          50% { 
            transform: scaleY(3);
            background: linear-gradient(to top, #0891b2, #059669, #10b981);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
          }
        }
        
        /* Cloning Station Effects */
        .cloning-station {
          position: relative;
          overflow: hidden;
        }
        
        .cloning-station::before {
          content: '';
          position: absolute;
          top: -2px;
          left: -2px;
          right: -2px;
          bottom: -2px;
          background: linear-gradient(45deg, transparent, rgba(6, 182, 212, 0.3), transparent, rgba(16, 185, 129, 0.3), transparent);
          border-radius: 14px;
          animation: borderGlow 3s linear infinite;
          z-index: -1;
        }
        
        /* Silver Glow for Cloning Sections */
        .cloning-section-silver {
          box-shadow: 0 0 10px rgba(192, 192, 192, 0.3), 0 0 20px rgba(192, 192, 192, 0.1);
          transition: box-shadow 0.3s ease;
        }
        
        .cloning-section-silver:hover {
          box-shadow: 0 0 15px rgba(192, 192, 192, 0.5), 0 0 30px rgba(192, 192, 192, 0.2);
        }
        
        @keyframes borderGlow {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* Recording Sound Wave Animation */
        .recording-wave-container {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 10px;
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
          border-radius: 8px;
          border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .recording-wave {
          display: flex;
          align-items: center;
          gap: 2px;
        }
        
        .recording-bar {
          width: 4px;
          height: 10px;
          background: linear-gradient(to top, #ef4444, #f59e0b);
          border-radius: 2px;
          animation: recordingWave 0.8s ease-in-out infinite;
        }
        
        .recording-bar:nth-child(1) { animation-delay: 0s; }
        .recording-bar:nth-child(2) { animation-delay: 0.1s; }
        .recording-bar:nth-child(3) { animation-delay: 0.2s; }
        .recording-bar:nth-child(4) { animation-delay: 0.1s; }
        .recording-bar:nth-child(5) { animation-delay: 0s; }
        
        @keyframes recordingWave {
          0%, 100% { 
            height: 10px;
            background: linear-gradient(to top, #ef4444, #f59e0b);
          }
          50% { 
            height: 25px;
            background: linear-gradient(to top, #dc2626, #d97706, #f59e0b);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
          }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .mobile-stack { flex-direction: column; }
          .mobile-full { width: 100%; }
          .mobile-text-sm { font-size: 14px; }
          .sound-wave-container { padding: 15px; }
          .wave-bar { width: 6px; height: 16px; }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Navigation -->
    <nav class="bg-black border-b-2 border-cyan-400 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <img src="https://page.gensparksite.com/v1/base64_upload/5ec0a971230da95148e537dd473d0fb1" alt="AUTHORR AI Logo" class="w-12 h-12 logo-image">
                    <h1 class="text-3xl font-bold authorr-brand-text">AUTHORR AI</h1>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <button onclick="showPage('dashboard')" class="nav-item px-4 py-2 rounded-lg font-semibold active">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </button>
                    <button onclick="showPage('workspace')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-edit mr-2"></i>Workspace
                    </button>
                    <button onclick="showPage('narration')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-microphone mr-2"></i>Narration
                    </button>
                    <button onclick="showPage('covers')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-image mr-2"></i>Covers
                    </button>
                    <button onclick="showPage('export')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="showPage('config')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-cog mr-2"></i>Config
                    </button>
                </div>
                <button onclick="toggleTheme()" class="text-cyan-400 hover:text-cyan-300 text-xl">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
        <div class="container mx-auto px-4 py-8">
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <div class="flex justify-center items-center mb-6">
                    <img src="https://page.gensparksite.com/v1/base64_upload/5ec0a971230da95148e537dd473d0fb1" alt="AUTHORR AI Logo" class="w-20 h-20 logo-image mr-4">
                    <h1 class="text-6xl font-bold authorr-brand-text">AUTHORR AI</h1>
                </div>
                <p class="text-xl text-theme-secondary mb-8 max-w-3xl mx-auto">
                    Transform your stories into professional audiobooks with AI-powered writing, chapter generation, 
                    and high-quality text-to-speech narration. Create, edit, and publish audiobooks in minutes.
                </p>
                <button onclick="showPage('workspace')" class="btn-primary px-8 py-4 rounded-lg text-lg font-semibold">
                    <i class="fas fa-rocket mr-2"></i>Start Creating Your Audiobook
                </button>
            </div>

            <!-- Features Grid -->
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">AI-Powered Writing</h3>
                    <p class="text-theme-secondary">
                        Generate engaging chapters, stories, and content with advanced GPT-4o-mini integration. 
                        Choose from multiple genres, tones, and writing styles.
                    </p>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">Professional Narration</h3>
                    <p class="text-theme-secondary">
                        Convert your text to high-quality speech with OpenAI's TTS-1-HD. Choose from 6 professional 
                        voices including Alloy, Echo, Fable, Onyx, Nova, and Shimmer.
                    </p>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-image"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">AI Book Covers</h3>
                    <p class="text-theme-secondary">
                        Generate stunning book covers with DALL-E 3 in HD quality (1024x1792). 
                        Create professional artwork that matches your story's theme.
                    </p>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="grid md:grid-cols-4 gap-6 mb-12">
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">25</div>
                    <div class="text-theme-secondary">Max Chapters</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">3000</div>
                    <div class="text-theme-secondary">Max Words/Chapter</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">6</div>
                    <div class="text-theme-secondary">AI Voices</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">∞</div>
                    <div class="text-theme-secondary">Possibilities</div>
                </div>
            </div>

            <!-- Quick Start Guide -->
            <div class="bg-theme-secondary p-8 rounded-xl border-2 border-theme">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-play-circle text-cyan-400 mr-2"></i>
                    Quick Start Guide
                </h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">1</div>
                        <h3 class="font-semibold mb-2">Plan Your Story</h3>
                        <p class="text-sm text-theme-secondary">Choose genre, set chapter count, and define your story parameters</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">2</div>
                        <h3 class="font-semibold mb-2">Generate Content</h3>
                        <p class="text-sm text-theme-secondary">Use AI writing tools to create engaging chapters and storylines</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">3</div>
                        <h3 class="font-semibold mb-2">Create Narration</h3>
                        <p class="text-sm text-theme-secondary">Convert to speech with professional AI voices and generate covers</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">4</div>
                        <h3 class="font-semibold mb-2">Export & Publish</h3>
                        <p class="text-sm text-theme-secondary">Download your complete audiobook and share with the world</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace Page -->
    <div id="workspace" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-edit text-cyan-400 mr-3"></i>
                    Audiobook Workspace
                </h1>
                <button onclick="showPage('narration')" id="continueToNarration" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-arrow-right mr-2"></i>Continue to Narration
                </button>
            </div>

            <!-- Story Planning Form -->
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <!-- Left Column: Story Parameters -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-cogs text-cyan-400 mr-2"></i>
                        Story Parameters
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Book Title</label>
                            <input type="text" id="bookTitle" placeholder="Enter your book title" 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Chapter Selection</label>
                                <select id="chapterCount" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="3">3 Chapters</option>
                                    <option value="5">5 Chapters</option>
                                    <option value="7">7 Chapters</option>
                                    <option value="10" selected>10 Chapters</option>
                                    <option value="15">15 Chapters</option>
                                    <option value="20">20 Chapters</option>
                                    <option value="25">25 Chapters</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2">Words per Chapter</label>
                                <select id="wordsPerChapter" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="250">250 words (~1 min audio)</option>
                                    <option value="500">500 words (~2 min audio)</option>
                                    <option value="750">750 words (~3 min audio)</option>
                                    <option value="1000" selected>1000 words (~4 min audio)</option>
                                    <option value="1250">1250 words (~5 min audio)</option>
                                    <option value="1500">1500 words (~6 min audio)</option>
                                    <option value="2000">2000 words (~8 min audio)</option>
                                    <option value="2500">2500 words (~10 min audio)</option>
                                    <option value="3000">3000 words (~12 min audio)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Genre & Subgenre</label>
                            <select id="genre" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="fiction-literary">Fiction - Literary</option>
                                <option value="fiction-mystery">Fiction - Mystery/Thriller</option>
                                <option value="fiction-romance">Fiction - Romance</option>
                                <option value="fiction-scifi">Fiction - Science Fiction</option>
                                <option value="fiction-fantasy">Fiction - Fantasy</option>
                                <option value="fiction-horror">Fiction - Horror</option>
                                <option value="fiction-historical">Fiction - Historical</option>
                                <option value="nonfiction-biography">Non-Fiction - Biography</option>
                                <option value="nonfiction-selfhelp">Non-Fiction - Self-Help</option>
                                <option value="nonfiction-business">Non-Fiction - Business</option>
                                <option value="nonfiction-history">Non-Fiction - History</option>
                                <option value="children-adventure">Children's - Adventure</option>
                                <option value="children-educational">Children's - Educational</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Tone & Voice</label>
                            <select id="tone" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="professional">Professional</option>
                                <option value="casual">Casual & Conversational</option>
                                <option value="dramatic">Dramatic & Intense</option>
                                <option value="humorous">Humorous & Light</option>
                                <option value="inspiring">Inspiring & Motivational</option>
                                <option value="mysterious">Mysterious & Suspenseful</option>
                                <option value="romantic">Romantic & Emotional</option>
                                <option value="educational">Educational & Informative</option>
                                <option value="adventurous">Adventurous & Exciting</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Story Outline</label>
                            <div class="relative">
                                <textarea id="storyOutline" placeholder="Describe your story concept, main characters, and plot outline..." 
                                          class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-24 resize-none"></textarea>
                                <div class="absolute bottom-2 right-3 text-xs text-cyan-400 bg-black bg-opacity-50 px-2 py-1 rounded">
                                    <span id="outlineWordCount">0 words</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="generateChapterPlan()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                            <i class="fas fa-magic mr-2"></i>Generate Chapter Plan
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Chapter Plan -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-list-ol text-cyan-400 mr-2"></i>
                            Chapter Plan
                        </h2>
                        <div class="flex space-x-2">
                            <button onclick="generateAllChapters()" id="generateAllBtn" class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold" disabled>
                                <i class="fas fa-bolt mr-1"></i>Generate All Chapters
                            </button>
                            <button onclick="combineAllChapters()" id="combineAllBtn" class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold" disabled>
                                <i class="fas fa-book mr-1"></i>Combine All
                            </button>
                        </div>
                    </div>
                    
                    <div id="chapterPlan" class="space-y-3 h-80 overflow-y-auto">
                        <div class="text-center text-theme-secondary py-8">
                            <i class="fas fa-lightbulb text-4xl mb-3 opacity-50"></i>
                            <p>Generate a chapter plan to get started</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Text Editor Section -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">
                        <i class="fas fa-pen-fancy text-cyan-400 mr-2"></i>
                        Story Editor
                    </h2>
                    <div class="flex items-center space-x-3">
                        <div class="word-count" id="wordCount">0 words</div>
                        <button onclick="undoEdit()" id="undoBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        <button onclick="redoEdit()" id="redoBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            <i class="fas fa-redo"></i> Redo
                        </button>
                        <button onclick="saveStory()" id="saveBtn" class="btn-primary px-3 py-1 rounded text-sm">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
                
                <div class="relative mb-4">
                    <textarea id="storyEditor" placeholder="Start writing your story here, or use the AI writing tools to generate content..." 
                              class="w-full px-4 py-3 rounded-lg form-field bg-theme-primary text-theme-primary h-96 resize-none"></textarea>
                </div>

                <!-- Chapter-by-Chapter Editing Tools -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-cyan-400">
                            <i class="fas fa-tools mr-2"></i>Chapter Editing Tools
                        </h3>
                        <div class="text-xs text-theme-secondary">Work on one chapter at a time</div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 p-4 bg-theme-primary rounded-lg border border-theme">
                        <!-- Row 1 -->
                        <div class="relative">
                            <button onclick="plotHoleDetector()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-search mr-1"></i>Plot Hole Detector
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Finds gaps or mistakes in the story that don't make sense and shows you how to fix them."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="characterArcDesigner()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-user-edit mr-1"></i>Character Arc Designer
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Helps shape how your character changes from the beginning of the story to the end."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="toneShifter()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-palette mr-1"></i>Tone Shifter
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Adjusts the mood and style of your writing so it feels consistent and matches your target audience."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="conflictIntensifier()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-fire mr-1"></i>Conflict Intensifier
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Adds more tension and drama to your story by making sure characters' goals and obstacles clash strongly."></i>
                        </div>
                        
                        <!-- Row 2 -->
                        <div class="relative">
                            <button onclick="dialogueEnhancer()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-comments mr-1"></i>Dialogue Enhancer
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Makes conversations between characters sound more real, engaging, and filled with hidden meaning."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="symbolismSuggester()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-gem mr-1"></i>Symbolism Suggester
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Suggests meaningful symbols or motifs that give your story extra depth and layers of meaning."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="metaphorGenerator()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-feather-alt mr-1"></i>Metaphor Generator
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Creates fresh, vivid comparisons that make your descriptions more powerful and memorable."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="themeTracker()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-compass mr-1"></i>Theme Tracker
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Keeps your story's big idea or moral consistent and visible throughout the book."></i>
                        </div>
                        
                        <!-- Row 3 -->
                        <div class="relative">
                            <button onclick="emotionalResonanceChecker()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-heart mr-1"></i>Emotional Resonance
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Makes sure readers feel the emotions you want them to feel at the right time in the story."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="redHerringGenerator()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-mask mr-1"></i>Red Herring Generator
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Adds clever misdirections in mystery or thriller stories to keep readers guessing without cheating."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="pacingBalancer()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-tachometer-alt mr-1"></i>Pacing Balancer
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Controls the speed and rhythm of your story so it never feels too slow or rushed."></i>
                        </div>
                        
                        <div class="relative">
                            <button onclick="subtextBuilder()" class="tool-btn w-full px-3 py-2 rounded text-sm font-medium">
                                <i class="fas fa-layer-group mr-1"></i>Subtext Builder
                            </button>
                            <i class="fas fa-info-circle tool-info" title="Helps characters say one thing but mean another, adding layers of hidden meaning to dialogue."></i>
                        </div>
                    </div>
                </div>

                <!-- Forensic AI Detection Section -->
                <div class="mb-6">
                    <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-purple-400">
                                <i class="fas fa-microscope mr-2"></i>Forensic AI Detection
                            </h3>
                            <div class="flex space-x-2">
                                <button onclick="undoEdit()" class="btn-secondary px-3 py-1 rounded text-xs">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                                <button onclick="redoEdit()" class="btn-secondary px-3 py-1 rounded text-xs">
                                    <i class="fas fa-redo"></i> Redo
                                </button>
                            </div>
                        </div>
                        
                        <p class="text-sm text-theme-secondary mb-3">Detailed stylistic and forensic breakdown of text for AI authorship likelihood.</p>
                        
                        <div class="flex gap-3 flex-wrap">
                            <div class="relative">
                                <button onclick="forensicAIDetection()" class="btn-primary px-4 py-2 rounded font-medium">
                                    <i class="fas fa-search-plus mr-2"></i>Analyze Text
                                </button>
                                <i class="fas fa-info-circle tool-info" title="Performs statistical analysis to determine AI likelihood score using perplexity, burstiness, and lexical variance measurements."></i>
                            </div>
                            
                            <div class="relative">
                                <button onclick="humanizeText()" class="btn-secondary px-4 py-2 rounded font-medium" id="humanizeBtn">
                                    <i class="fas fa-user-edit mr-2"></i>Humanization
                                </button>
                                <i class="fas fa-info-circle tool-info" title="Rewrites text to sound more natural and human-like, reducing AI detection scores while preserving meaning and style."></i>
                            </div>
                            
                            <div class="relative">
                                <button onclick="reanalyzeText()" class="btn-secondary px-4 py-2 rounded font-medium" id="reanalyzeBtn" disabled style="opacity: 0.5;">
                                    <i class="fas fa-sync mr-2"></i>Reanalyze
                                </button>
                                <i class="fas fa-info-circle tool-info" title="Performs a new AI detection analysis on the current text to check improvement after changes."></i>
                            </div>
                        </div>
                        
                        <!-- Analysis Results Area -->
                        <div id="forensicResults" class="mt-4 hidden">
                            <div class="bg-gray-800 p-4 rounded border border-gray-600">
                                <pre id="forensicOutput" class="text-sm text-gray-300 whitespace-pre-wrap"></pre>
                            </div>
                        </div>
                        
                        <!-- Humanization Results Area -->
                        <div id="humanizationResults" class="mt-4 hidden">
                            <div class="bg-gray-800 p-4 rounded border border-gray-600">
                                <pre id="humanizationOutput" class="text-sm text-gray-300 whitespace-pre-wrap"></pre>
                            </div>
                        </div>

                        <!-- Continue to Narration Button -->
                        <div class="mt-6 text-center">
                            <button onclick="showPage('narration')" class="btn-glow bg-cyan-600 hover:bg-cyan-500 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                                <i class="fas fa-microphone mr-2"></i>Continue to Narration
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Narration Page -->
    <div id="narration" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-microphone text-cyan-400 mr-3"></i>
                    Audio Narration
                </h1>
                <button onclick="showPage('export')" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-download mr-2"></i>Export Audiobook
                </button>
            </div>

            <!-- Animated Sound Wave -->
            <div class="sound-wave-container mb-8">
                <div class="sound-wave">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Voice Selection & Controls -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-volume-up text-cyan-400 mr-2"></i>
                        Voice & Audio Settings
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Voice Actors</label>
                            <select id="voiceSelection" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="alloy">Alloy - Balanced, Clear</option>
                                <option value="echo">Echo - Male, Authoritative</option>
                                <option value="fable">Fable - Warm, Storytelling</option>
                                <option value="onyx">Onyx - Deep, Professional</option>
                                <option value="nova">Nova - Female, Engaging</option>
                                <option value="shimmer">Shimmer - Soft, Gentle</option>
                            </select>
                            <button onclick="previewSelectedVoice()" class="btn-secondary w-full mt-2 py-2 rounded-lg text-sm">
                                <i class="fas fa-play mr-2"></i>Preview Voice
                            </button>
                            <div id="voicePreviewPlayer" class="hidden mt-2">
                                <audio controls class="w-full">
                                    <source id="voicePreviewSource" src="" type="audio/mpeg">
                                </audio>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Speech Rate</label>
                                <select id="speechRate" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="0.75">Slow (0.75x)</option>
                                    <option value="1.0" selected>Normal (1.0x)</option>
                                    <option value="1.25">Fast (1.25x)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2">Audio Format</label>
                                <select id="audioFormat" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="mp3" selected>MP3 (Recommended)</option>
                                    <option value="opus">OPUS (High Quality)</option>
                                    <option value="aac">AAC (Apple Compatible)</option>
                                    <option value="flac">FLAC (Lossless)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Preview Text</label>
                            <textarea id="previewText" placeholder="Enter text to preview the selected voice..." 
                                      class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-20 resize-none"></textarea>
                        </div>
                        
                        <button onclick="previewVoice()" class="btn-secondary w-full py-2 rounded-lg font-semibold">
                            <i class="fas fa-play mr-2"></i>Preview Voice
                        </button>
                        
                        <div class="border-t border-theme pt-4">
                            <button onclick="generateNarration()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                                <i class="fas fa-microphone mr-2"></i>Generate Full Narration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dialogue-Specific Voice Assignment -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-users text-purple-400 mr-2"></i>
                        Dialogue Voice Assignment
                    </h2>
                    
                    <div class="space-y-4">
                        <p class="text-sm text-theme-secondary">
                            Assign different voices to characters in your story for dynamic narration.
                        </p>
                        
                        <!-- Content Status Indicator -->
                        <div id="contentStatusIndicator" class="bg-theme-primary p-3 rounded-lg border border-theme">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div id="contentStatusIcon" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                    <span class="text-sm font-medium">Story Content Status:</span>
                                </div>
                                <button onclick="refreshContentStatus()" class="text-xs text-cyan-400 hover:text-cyan-300">
                                    <i class="fas fa-sync mr-1"></i>Refresh
                                </button>
                            </div>
                            <div id="contentStatusText" class="text-xs text-theme-secondary mt-1">
                                Checking for story content...
                            </div>
                            <div id="contentPreviewToggle" class="mt-2 hidden">
                                <button onclick="toggleContentPreview()" class="text-xs text-cyan-400 hover:text-cyan-300">
                                    <i class="fas fa-eye mr-1"></i>Preview Content
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content Preview (Hidden by default) -->
                        <div id="contentPreview" class="hidden bg-theme-primary p-3 rounded-lg border border-theme">
                            <div class="flex items-center justify-between mb-2">
                                <h5 class="text-sm font-medium text-cyan-400">Content Preview:</h5>
                                <button onclick="toggleContentPreview()" class="text-xs text-theme-secondary">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="contentPreviewText" class="text-xs text-theme-secondary max-h-32 overflow-y-auto bg-theme-secondary p-2 rounded font-mono">
                                <!-- Content preview will appear here -->
                            </div>
                        </div>
                        
                        <button onclick="scanForDialogue()" class="btn-secondary w-full py-2 rounded-lg font-semibold">
                            <i class="fas fa-search mr-2"></i>Scan Story for Dialogue
                        </button>
                        
                        <!-- Dialogue Assignment Results -->
                        <div id="dialogueAssignments" class="hidden">
                            <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                                <h4 class="font-semibold mb-3 text-cyan-400">Character Voice Assignments</h4>
                                <div id="characterVoiceList" class="space-y-3">
                                    <!-- Characters will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Dialogue Preview -->
                        <div id="dialoguePreview" class="hidden">
                            <div class="bg-theme-primary p-4 rounded-lg border border-theme max-h-60 overflow-y-auto">
                                <h4 class="font-semibold mb-3 text-green-400">Found Dialogue Sections</h4>
                                <div id="dialogueList" class="space-y-2">
                                    <!-- Dialogue will be populated here -->
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-theme pt-4">
                            <button onclick="generateMultiVoiceNarration()" id="multiVoiceBtn" class="btn-primary w-full py-3 rounded-lg font-semibold" disabled>
                                <i class="fas fa-theater-masks mr-2"></i>Generate Multi-Voice Narration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- High-Tech Voice Cloning Station -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme cloning-station">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-dna text-cyan-400 mr-2 animate-pulse"></i>
                        Voice Cloning Station
                    </h2>
                    
                    <div class="space-y-6">
                        <div class="bg-theme-primary p-4 rounded-lg border border-cyan-500">
                            <div class="flex items-center mb-2">
                                <div class="w-3 h-3 rounded-full bg-green-400 mr-2 animate-pulse"></div>
                                <span class="text-sm font-semibold text-cyan-400">Neural Voice Matrix</span>
                            </div>
                            <p class="text-xs text-theme-secondary mb-3">Upload voice samples to create custom AI narrator profiles</p>
                        </div>
                        
                        <!-- Audio Upload Section -->
                        <div class="border-2 border-gray-400 p-4 rounded-lg text-center hover:border-gray-300 transition-colors cursor-pointer cloning-section-silver" 
                             ondrop="handleVoiceDrop(event)" ondragover="allowDrop(event)" onclick="document.getElementById('voiceUpload').click()">
                            <i class="fas fa-microphone text-gray-300 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-300">Drag & drop audio files or click to browse</p>
                            <input type="file" id="voiceUpload" accept=".mp3,.wav,.m4a" multiple class="hidden">
                        </div>
                        
                        <!-- Text Input Section -->
                        <div class="border-2 border-gray-400 p-4 rounded-lg hover:border-gray-300 transition-colors cloning-section-silver" 
                             ondrop="handleTextDrop(event)" ondragover="allowDrop(event)">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-file-text text-gray-300 mr-2"></i>
                                <span class="text-sm font-semibold text-gray-300">Text Input & Preview</span>
                            </div>
                            <textarea id="cloneTextInput" placeholder="Drag & drop text files here or type/paste your text for voice cloning preview..." 
                                      class="w-full px-3 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-20 resize-none text-sm"></textarea>
                            <div class="flex justify-between items-center mt-2 text-xs text-theme-secondary">
                                <span id="textCharCount">0 characters</span>
                                <button onclick="previewCloneText()" class="btn-secondary px-3 py-1 rounded text-xs">
                                    <i class="fas fa-play mr-1"></i>Preview
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recording Section -->
                        <div class="border-2 border-red-500 p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <i class="fas fa-record-vinyl text-red-400 mr-2"></i>
                                    <span class="text-sm font-semibold text-red-400">Live Recording</span>
                                </div>
                                <div id="recordingIndicator" class="hidden flex items-center">
                                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"></div>
                                    <span class="text-xs text-red-400">Recording...</span>
                                </div>
                            </div>
                            
                            <!-- Mini Recording Sound Wave -->
                            <div id="recordingWave" class="hidden recording-wave-container mb-3">
                                <div class="recording-wave">
                                    <div class="recording-bar"></div>
                                    <div class="recording-bar"></div>
                                    <div class="recording-bar"></div>
                                    <div class="recording-bar"></div>
                                    <div class="recording-bar"></div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button id="recordBtn" onclick="startRecording()" class="bg-red-500 hover:bg-red-600 text-black flex-1 py-2 rounded-lg text-sm font-semibold transition-colors">
                                    <i class="fas fa-microphone mr-1 text-black"></i>Record
                                </button>
                                <button id="stopBtn" onclick="stopRecording()" disabled class="btn-secondary flex-1 py-2 rounded-lg text-sm opacity-50">
                                    <i class="fas fa-stop mr-1"></i>Stop
                                </button>
                            </div>
                            
                            <div id="recordedAudio" class="hidden mt-3">
                                <audio controls class="w-full">
                                    <source id="recordedAudioSource" src="" type="audio/wav">
                                </audio>
                            </div>
                        </div>
                    </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold">Clone Quality</span>
                                <div class="flex space-x-1">
                                    <div class="w-2 h-4 bg-green-400 rounded animate-pulse"></div>
                                    <div class="w-2 h-4 bg-green-400 rounded animate-pulse" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-4 bg-yellow-400 rounded animate-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="w-2 h-4 bg-gray-600 rounded"></div>
                                    <div class="w-2 h-4 bg-gray-600 rounded"></div>
                                </div>
                            </div>
                            
                            <select id="cloneModel" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="enhanced">Enhanced Neural Model</option>
                                <option value="standard">Standard Clone</option>
                                <option value="premium">Premium Voice Synthesis</option>
                            </select>
                        </div>
                        
                        <button onclick="initiateVoiceClone()" class="btn-primary w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500">
                            <i class="fas fa-flask mr-2"></i>Initialize Voice Clone
                        </button>
                        
                        <div id="cloningProgress" class="hidden mt-4">
                            <div class="bg-theme-primary p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-cyan-400">Neural Processing...</span>
                                    <span class="text-xs text-theme-secondary" id="cloningPercent">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="cloningBar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audio Progress & Results -->
            <div class="mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-headphones text-cyan-400 mr-2"></i>
                    Narration Progress
                </h2>
                
                <div id="narrationProgress" class="hidden">
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Generating Audio...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3">
                            <div id="progressBar" class="bg-cyan-400 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div id="audioResults" class="space-y-4">
                    <!-- Generated audio files will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Book Covers Page -->
    <div id="covers" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-image text-cyan-400 mr-3"></i>
                AI Book Cover Generator
            </h1>

            <!-- Platform Dimension Templates -->
            <div class="mb-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-ruler text-cyan-400 mr-2"></i>
                    Platform Dimension Templates
                </h2>
                <div class="grid md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <button onclick="selectPlatformTemplate('audible')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-amazon text-orange-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Audible</div>
                            <div class="text-xs text-theme-secondary">2400×2400px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('spotify')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-spotify text-green-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Spotify</div>
                            <div class="text-xs text-theme-secondary">3000×3000px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('apple')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-apple text-gray-300 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Apple</div>
                            <div class="text-xs text-theme-secondary">3000×3000px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('google')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-google text-blue-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Google Play</div>
                            <div class="text-xs text-theme-secondary">2400×2400px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('overdrive')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fas fa-book text-purple-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">OverDrive</div>
                            <div class="text-xs text-theme-secondary">1800×2700px</div>
                        </div>
                    </button>
                </div>
                <div class="mt-4 text-sm text-theme-secondary">
                    <i class="fas fa-info-circle mr-2"></i>
                    Click a platform to auto-configure dimensions and optimization settings
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Cover Design Panel -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-palette text-cyan-400 mr-2"></i>
                        Design Your Cover
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Platform</label>
                                <select id="selectedPlatform" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="universal">Universal (Square)</option>
                                    <option value="audible">Audible (2400×2400)</option>
                                    <option value="spotify">Spotify (3000×3000)</option>
                                    <option value="apple">Apple Podcasts (3000×3000)</option>
                                    <option value="google">Google Play (2400×2400)</option>
                                    <option value="overdrive">OverDrive (1800×2700)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Cover Style</label>
                                <select id="coverStyle" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="modern">Modern & Clean</option>
                                    <option value="classic">Classic Literature</option>
                                    <option value="mysterious">Dark & Mysterious</option>
                                    <option value="romantic">Romantic & Elegant</option>
                                    <option value="fantasy">Fantasy Adventure</option>
                                    <option value="scifi">Sci-Fi Futuristic</option>
                                    <option value="horror">Horror & Thriller</option>
                                    <option value="children">Children's Colorful</option>
                                    <option value="business">Professional Business</option>
                                    <option value="memoir">Personal Memoir</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Book Title</label>
                            <input type="text" id="coverTitle" placeholder="Enter your book title..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Author Name</label>
                            <input type="text" id="coverAuthor" placeholder="Enter author name..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Subtitle (Optional)</label>
                            <input type="text" id="coverSubtitle" placeholder="Enter subtitle if any..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Visual Description</label>
                            <textarea id="coverDescription" placeholder="Describe the visual elements, mood, colors, and style for your book cover. Be specific about imagery, atmosphere, and design elements..." 
                                      class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-32 resize-none"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Primary Color</label>
                                <input type="color" id="primaryColor" value="#06b6d4" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Accent Color</label>
                                <input type="color" id="accentColor" value="#10b981" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Text Color</label>
                                <input type="color" id="textColor" value="#ffffff" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Image Quality</label>
                                <select id="imageQuality" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="standard">Standard (1024×1024)</option>
                                    <option value="hd" selected>HD (1792×1024)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Art Style</label>
                                <select id="artStyle" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="photorealistic">Photorealistic</option>
                                    <option value="digital-art">Digital Art</option>
                                    <option value="illustration">Illustration</option>
                                    <option value="painting">Oil Painting</option>
                                    <option value="minimalist">Minimalist</option>
                                    <option value="vintage">Vintage</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="generateAICover()" class="btn-primary w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500">
                            <i class="fas fa-magic mr-2"></i>Generate Cover
                        </button>
                    </div>
                </div>
                
                <!-- Cover Preview Panel -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-eye text-cyan-400 mr-2"></i>
                        Cover Preview & Variations
                    </h2>
                    
                    <div id="coverPreviewPanel">
                        <div class="bg-theme-primary border-2 border-dashed border-theme rounded-lg p-8 mb-4 text-center" id="placeholderPreview">
                            <i class="fas fa-image text-6xl text-theme-secondary mb-4"></i>
                            <p class="text-theme-secondary">Generate your AI cover to see preview</p>
                            <p class="text-xs text-theme-secondary mt-2">Dimensions will adjust based on selected platform</p>
                        </div>
                        
                        <div id="coverPreview" class="hidden">
                            <div class="text-center mb-4">
                                <div class="inline-block relative">
                                    <img id="generatedCover" src="" alt="Generated Book Cover" class="max-w-full h-auto rounded-lg shadow-lg border-2 border-theme">
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded" id="dimensionDisplay">
                                        2400×2400px
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex justify-center space-x-2">
                                    <button onclick="regenerateAICover()" class="btn-secondary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-sync mr-1"></i>Regenerate
                                    </button>
                                    <button onclick="createVariations()" class="btn-secondary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-clone mr-1"></i>Variations
                                    </button>
                                    <button onclick="downloadCover()" class="btn-primary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="downloadForPlatform('print')" class="btn-secondary w-full py-2 rounded text-xs">
                                        <i class="fas fa-print mr-1"></i>Print Ready
                                    </button>
                                    <button onclick="downloadForPlatform('web')" class="btn-secondary w-full py-2 rounded text-xs">
                                        <i class="fas fa-globe mr-1"></i>Web Optimized
                                    </button>
                                </div>
                                
                                <button onclick="setCoverAsMain()" class="btn-primary w-full py-2 rounded text-sm">
                                    <i class="fas fa-check mr-1"></i>Use as Main Cover
                                </button>
                            </div>
                        </div>
                        
                        <!-- Cover Variations -->
                        <div id="coverVariations" class="hidden mt-6">
                            <h3 class="text-lg font-semibold mb-4">AI Generated Variations</h3>
                            <div class="grid grid-cols-2 gap-4" id="variationsGrid">
                                <!-- Variations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Generation Progress -->
            <div id="coverGenerationProgress" class="hidden mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-magic text-cyan-400 mr-2 animate-spin"></i>
                    AI Cover Generation in Progress
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm" id="generationStep">Analyzing design preferences...</span>
                        <div class="w-6 h-6 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    
                    <div class="w-full bg-theme-primary rounded-full h-3">
                        <div id="coverProgressBar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <div class="text-xs text-theme-secondary text-center">
                        <div id="progressMessage">Processing with OpenAI DALL-E API...</div>
                        <div class="mt-1">High-quality generation typically takes 10-30 seconds</div>
                    </div>
                </div>
            </div>

            <!-- Platform Requirements Info -->
            <div class="mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                    Platform Requirements & Guidelines
                </h3>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-400 mb-2"><i class="fab fa-amazon mr-1"></i> Audible</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 2400×2400px minimum</li>
                            <li>• Square aspect ratio</li>
                            <li>• RGB color space</li>
                            <li>• Text must be readable at 150px</li>
                        </ul>
                    </div>
                    
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-green-400 mb-2"><i class="fab fa-spotify mr-1"></i> Spotify</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 3000×3000px recommended</li>
                            <li>• Square format required</li>
                            <li>• High contrast text</li>
                            <li>• No promotional text</li>
                        </ul>
                    </div>
                    
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-300 mb-2"><i class="fab fa-apple mr-1"></i> Apple</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 3000×3000px minimum</li>
                            <li>• Square aspect ratio</li>
                            <li>• 72 DPI minimum</li>
                            <li>• Clear, legible text</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Page -->
    <div id="export" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-download text-cyan-400 mr-3"></i>
                Export Your Audiobook
            </h1>

            <!-- Export Options -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-file-archive text-cyan-400 mr-2"></i>
                        Package Options
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Complete Audiobook Package</h3>
                                <button class="btn-primary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">All audio files, cover image, and metadata in ZIP format</p>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Audio Files Only</h3>
                                <button class="btn-secondary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">MP3 files for each chapter</p>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Text Manuscript</h3>
                                <button class="btn-secondary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">Complete story text in DOC/PDF format</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-share-alt text-cyan-400 mr-2"></i>
                        Publishing Options
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Audible Ready</h3>
                            <p class="text-sm text-theme-secondary mb-3">Format optimized for Audible submission</p>
                            <button class="btn-primary px-4 py-1 rounded text-sm w-full">Prepare for Audible</button>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Podcast Format</h3>
                            <p class="text-sm text-theme-secondary mb-3">Individual episodes with RSS feed</p>
                            <button class="btn-secondary px-4 py-1 rounded text-sm w-full">Generate Podcast</button>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">YouTube Series</h3>
                            <p class="text-sm text-theme-secondary mb-3">Video format with static cover image</p>
                            <button class="btn-secondary px-4 py-1 rounded text-sm w-full">Create Video Series</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Summary -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                    Project Summary
                </h2>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportChapterCount">10</div>
                        <div class="text-sm text-theme-secondary">Chapters</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportTotalWords">10,000</div>
                        <div class="text-sm text-theme-secondary">Total Words</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportDuration">~2.5 hours</div>
                        <div class="text-sm text-theme-secondary">Audio Duration</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Page -->
    <div id="config" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-cog text-cyan-400 mr-3"></i>
                Configuration & Settings
            </h1>

            <!-- API Configuration -->
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-key text-cyan-400 mr-2"></i>
                        API Configuration
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">OpenAI API Key</label>
                            <input type="password" id="openaiKey" placeholder="sk-..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                            <p class="text-xs text-theme-secondary mt-1">Required for AI writing and narration features</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">ElevenLabs API Key</label>
                            <input type="password" id="elevenlabsKey" placeholder="Enter your ElevenLabs API key..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                            <p class="text-xs text-theme-secondary mt-1">Optional: Enables advanced voice cloning and additional voices</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Model Selection</label>
                            <select id="modelSelection" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="gpt-4o-mini" selected>GPT-4o-mini (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5-turbo (Faster)</option>
                                <option value="gpt-4">GPT-4 (Premium)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="testApiConnection()" class="btn-primary w-full py-2 rounded-lg font-semibold">
                                <i class="fas fa-wifi mr-2"></i>Test API Connection
                            </button>
                            <button onclick="saveSettings()" class="btn-secondary w-full py-2 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-palette text-cyan-400 mr-2"></i>
                        Appearance Settings
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Theme</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setTheme('light')" class="p-3 rounded-lg border-2 border-theme bg-white text-black">
                                    <i class="fas fa-sun mb-1"></i><br>Light
                                </button>
                                <button onclick="setTheme('dark')" class="p-3 rounded-lg border-2 border-theme bg-gray-800 text-white">
                                    <i class="fas fa-moon mb-1"></i><br>Dark
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Font Size</label>
                            <select id="fontSize" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Auto-save</label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoSave" checked class="mr-2">
                                <span>Automatically save work every 30 seconds</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About & Help -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-info text-cyan-400 mr-2"></i>
                    About AUTHORR AI
                </h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold mb-2">Platform Information</h3>
                        <ul class="text-sm space-y-1 text-theme-secondary">
                            <li>• Version: 2.5 Fixed Platform</li>
                            <li>• AI Model: GPT-4o-mini with TTS-1-HD</li>
                            <li>• Voice Options: 6 Professional AI Voices</li>
                            <li>• Image Generation: DALL-E 3 HD Quality</li>
                            <li>• Max Chapters: 25 per audiobook</li>
                            <li>• Max Words: 3,000 per chapter</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold mb-2">Support & Resources</h3>
                        <div class="space-y-2">
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-book mr-1"></i>User Guide
                            </button>
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-video mr-1"></i>Video Tutorials
                            </button>
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-life-ring mr-1"></i>Contact Support
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-theme-secondary p-8 rounded-xl border-2 border-cyan-400 text-center">
            <div class="loading-content">
                <div class="book-loader">
                    <div class="book-spine"></div>
                    <div class="book-pages"></div>
                    <div class="book-pages"></div>
                    <div class="book-pages"></div>
                </div>
                <div class="loading-spinner mx-auto" style="display: none;"></div>
            </div>
            <p id="loadingText" class="text-lg font-semibold">Processing...</p>
        </div>
    </div>

    <script>
        // Global State Management
        let currentPage = 'dashboard';
        let storyData = {
            title: '',
            chapters: [],
            currentChapter: 0,
            settings: {
                chapterCount: 10,
                wordsPerChapter: 1000,
                genre: 'fiction-literary',
                tone: 'professional'
            }
        };
        
        // History management for undo/redo
        let editHistory = [];
        let historyIndex = -1;
        const maxHistorySize = 50;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateWordCount();
            setupAutoSave();
            
            // Initialize undo/redo system
            const editor = document.getElementById('storyEditor');
            if (editor) {
                // Save initial state
                saveEditState();
                
                // Auto-save on content changes (debounced)
                let saveTimeout;
                editor.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveEditState();
                    }, 1000); // Save after 1 second of no typing
                });
            }
            
            // Initialize button states
            updateUndoRedoButtons();
        });
        
        // Page Navigation
        function showPage(pageId, clickEvent = null) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            }
            
            currentPage = pageId;
            
            // Transfer story data when navigating to narration
            if (pageId === 'narration') {
                transferStoryToNarration();
            }
        }
        
        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.classList.contains('theme-light')) {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('theme-dark');
                body.classList.add('theme-light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }
        
        function setTheme(theme) {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.className = `theme-${theme}`;
            themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('theme', theme);
        }
        
        function loadSettings() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Load API key if saved
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('openaiKey').value = apiKey;
            }
        }
        
        // Story Generation Functions
        async function generateChapterPlan() {
            const title = document.getElementById('bookTitle').value;
            const chapterCount = parseInt(document.getElementById('chapterCount').value);
            const wordsPerChapter = parseInt(document.getElementById('wordsPerChapter').value);
            const genre = document.getElementById('genre').value;
            const tone = document.getElementById('tone').value;
            const outline = document.getElementById('storyOutline').value;
            
            if (!title || !outline) {
                alert('Please enter a book title and story outline.');
                return;
            }
            
            showLoading('Generating comprehensive chapter plan...');
            
            try {
                // Enhanced AI API call simulation for chapter planning
                const chapterPlan = await simulateEnhancedChapterGeneration(title, chapterCount, genre, tone, outline);
                displayEnhancedChapterPlan(chapterPlan);
                
                // Update story data
                storyData.title = title;
                storyData.settings = { chapterCount, wordsPerChapter, genre, tone, outline };
                storyData.chapters = chapterPlan.map(chapter => ({ ...chapter, content: '' }));
                
                document.getElementById('generateAllBtn').disabled = false;
                hideLoading();
            } catch (error) {
                console.error('Chapter generation error:', error);
                alert('Failed to generate chapter plan. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedChapterGeneration(title, chapterCount, genre, tone, outline) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2500));
            
            const chapters = [];
            const detailedSummaries = generateDetailedSummaries(genre, tone, outline, chapterCount);
            const chapterTitles = generateChapterTitles(genre, chapterCount);
            
            for (let i = 1; i <= chapterCount; i++) {
                chapters.push({
                    number: i,
                    title: `Chapter ${i}: ${chapterTitles[i-1]}`,
                    summary: detailedSummaries[i-1],
                    wordTarget: parseInt(document.getElementById('wordsPerChapter').value),
                    editable: true,
                    status: 'ready'
                });
            }
            return chapters;
        }
        
        function generateDetailedSummaries(genre, tone, outline, chapterCount) {
            const summaries = {
                'fiction-mystery': [
                    'Introduce the detective protagonist and establish the mysterious crime that will drive the investigation forward. Set the scene and atmosphere.',
                    'The first clues emerge as the detective begins interviewing witnesses and examining evidence. Red herrings and false leads create complexity.',
                    'A breakthrough occurs when a crucial piece of evidence is discovered, but it only deepens the mystery and raises more disturbing questions.',
                    'The investigation takes a dangerous turn as someone attempts to stop the detective, suggesting the killer is still active and watching.',
                    'All the pieces of the puzzle begin to come together in a shocking revelation that changes everything the detective thought they knew.',
                    'The final confrontation between detective and killer, with the truth finally revealed and justice served in a dramatic climax.',
                    'Epilogue: The aftermath of the case and how the events have permanently changed both the detective and the community.',
                ],
                'fiction-romance': [
                    'The meet-cute: Two characters encounter each other in an unexpected and memorable way, with instant chemistry despite initial resistance.',
                    'Growing attraction develops despite external obstacles and personal misunderstandings that seem to keep them apart.',
                    'A moment of deep emotional connection brings them closer together, revealing vulnerable sides of both characters.',
                    'Major conflict arises - external pressures or internal fears threaten to tear the couple apart just as love begins to bloom.',
                    'The dark moment when all seems lost and true love appears impossible due to circumstances beyond their control.',
                    'The grand romantic gesture and heartfelt confession that overcomes all obstacles and wins back their one true love.',
                    'Happy ending with the couple united, planning their future together, and having grown as individuals through their journey.',
                ],
                'fiction-fantasy': [
                    'The ordinary world before magic enters the protagonist\'s life. Establish the character\'s mundane existence and hidden potential.',
                    'The call to adventure arrives when magical forces thrust the hero into an extraordinary quest they cannot refuse.',
                    'Meeting magical allies and discovering ancient powers or prophecies that reveal the true scope of the hero\'s destiny.',
                    'The first major challenge tests the hero\'s newfound abilities against dark forces, with mixed success and important lessons.',
                    'The ultimate confrontation with the primary antagonist in an epic battle between good and evil that will determine the fate of the realm.',
                    'Victory is achieved, but at great personal cost. The hero must make difficult sacrifices to save others and fulfill their destiny.',
                    'Return to the ordinary world, forever changed by the magical journey. The hero integrates their experiences into a new life.',
                ],
                'fiction-scifi': [
                    'Establish the futuristic or alien setting while introducing the protagonist and the scientific/technological premise.',
                    'The discovery or invention that changes everything, setting the main technological conflict into motion.',
                    'Exploring the implications and consequences of the new technology or alien contact on society and individuals.',
                    'Rising conflict as the protagonist must navigate political, ethical, or survival challenges in this new reality.',
                    'The climactic confrontation where science, technology, or first contact reaches a critical turning point.',
                    'Resolution of the technological crisis with wisdom gained about progress, humanity, or our place in the universe.',
                    'New equilibrium: How the world has changed and what the future now holds for humanity.',
                ]
            };
            
            const defaultSummaries = [
                'Setting the scene and introducing the main characters in their world, establishing the tone and central premise.',
                'The inciting incident occurs, disrupting the status quo and setting the main plot into unstoppable motion.',
                'Rising action as characters face their first major challenges, revealing personality and building relationships.',
                'Complications arise that deepen the conflict, raise the stakes, and test character resolve and relationships.',
                'The climax arrives - the turning point where everything hangs in the balance and characters face their greatest test.',
                'Falling action begins as the main conflict moves toward resolution and characters deal with consequences.',
                'Resolution and conclusion, tying up loose ends, showing character growth, and providing satisfying closure.',
            ];
            
            const genreSummaries = summaries[genre] || defaultSummaries;
            
            // Extend or customize summaries to match chapter count
            const result = [];
            for (let i = 0; i < chapterCount; i++) {
                if (i < genreSummaries.length) {
                    result.push(genreSummaries[i]);
                } else {
                    // Generate additional summaries for longer books
                    const baseIndex = i % genreSummaries.length;
                    result.push(`Chapter ${i + 1}: Continuing the ${genre.replace('-', ' ')} narrative with ${tone} tone, building toward the climactic conclusion.`);
                }
            }
            
            return result;
        }
        
        function generateChapterTitles(genre, chapterCount) {
            const titleTemplates = {
                'fiction-mystery': [
                    'The Crime Scene', 'First Clues', 'Witnesses Speak', 'Hidden Motives', 'False Leads', 
                    'Breaking Point', 'The Truth Emerges', 'Final Confrontation', 'Justice Served'
                ],
                'fiction-romance': [
                    'Unexpected Encounter', 'Growing Attraction', 'First Kiss', 'Complications', 
                    'Heartbreak', 'Realization', 'Grand Gesture', 'Forever Together'
                ],
                'fiction-fantasy': [
                    'The Calling', 'Into the Unknown', 'Ancient Powers', 'Dark Forces', 
                    'The Prophecy', 'Final Battle', 'Victory\'s Price', 'New Dawn'
                ],
                'fiction-scifi': [
                    'Discovery', 'First Contact', 'New Worlds', 'Alien Minds', 
                    'Technology\'s Edge', 'The Singularity', 'Evolution', 'Future Awakens'
                ]
            };
            
            const defaultTitles = [
                'Beginning', 'Rising Action', 'Development', 'Complication', 
                'Climax', 'Resolution', 'Conclusion'
            ];
            
            const titles = titleTemplates[genre] || defaultTitles;
            const result = [];
            
            for (let i = 0; i < chapterCount; i++) {
                if (i < titles.length) {
                    result.push(titles[i]);
                } else {
                    result.push(`Part ${i + 1}`);
                }
            }
            
            return result;
        }
        
        function displayEnhancedChapterPlan(chapters) {
            const planContainer = document.getElementById('chapterPlan');
            planContainer.innerHTML = chapters.map(chapter => `
                <div class="border border-theme p-3 rounded-lg bg-theme-primary" id="chapter-${chapter.number}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-sm editable-title" 
                            contenteditable="true" 
                            onblur="updateChapterTitle(${chapter.number}, this.textContent)"
                            data-original="${chapter.title}">${chapter.title}</h3>
                        <div class="flex space-x-1">
                            <button onclick="editChapter(${chapter.number})" class="btn-secondary px-2 py-1 rounded text-xs" title="Edit Chapter">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="generateSingleChapter(${chapter.number})" class="btn-primary px-2 py-1 rounded text-xs" title="Generate Story">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-theme-secondary mb-2 editable-summary" 
                       contenteditable="true" 
                       onblur="updateChapterSummary(${chapter.number}, this.textContent)"
                       data-original="${chapter.summary}">${chapter.summary}</p>
                    <div class="text-xs text-cyan-400 mb-1">Target: ${chapter.wordTarget} words</div>
                    <div class="chapter-status status-${chapter.status} text-xs" id="chapter-status-${chapter.number}">
                        Ready to generate story content
                    </div>
                </div>
            `).join('');
        }
        
        function updateChapterTitle(chapterNum, newTitle) {
            const chapterIndex = chapterNum - 1;
            if (storyData.chapters[chapterIndex]) {
                storyData.chapters[chapterIndex].title = newTitle.trim();
                console.log(`Updated chapter ${chapterNum} title:`, newTitle);
                showStatusMessage(`Chapter ${chapterNum} title updated`);
            }
        }
        
        function updateChapterSummary(chapterNum, newSummary) {
            const chapterIndex = chapterNum - 1;
            if (storyData.chapters[chapterIndex]) {
                storyData.chapters[chapterIndex].summary = newSummary.trim();
                console.log(`Updated chapter ${chapterNum} summary:`, newSummary);
                showStatusMessage(`Chapter ${chapterNum} summary updated`);
            }
        }
        
        function editChapter(chapterNum) {
            try {
                const chapterDiv = document.getElementById(`chapter-${chapterNum}`);
                if (!chapterDiv) {
                    showNotification(`Chapter ${chapterNum} not found`, 'error');
                    return;
                }
                
                const titleEl = chapterDiv.querySelector('.editable-title');
                const summaryEl = chapterDiv.querySelector('.editable-summary');
                
                if (!titleEl || !summaryEl) {
                    showNotification('Chapter elements not found', 'error');
                    return;
                }
                
                // Highlight for editing
                titleEl.focus();
                titleEl.style.backgroundColor = 'rgba(120, 227, 254, 0.1)';
                summaryEl.style.backgroundColor = 'rgba(120, 227, 254, 0.1)';
                
                // Show edit instruction
                showNotification(`Editing Chapter ${chapterNum} - Click outside when done`, 'info');
                
                // Remove highlight after editing
                setTimeout(() => {
                    titleEl.style.backgroundColor = '';
                    summaryEl.style.backgroundColor = '';
                }, 5000);
                
            } catch (error) {
                console.error('Edit chapter error:', error);
                showNotification('Failed to edit chapter', 'error');
            }
        }
        
        async function generateAllChapters() {
            if (!storyData.chapters || storyData.chapters.length === 0) {
                showNotification('Please generate a chapter plan first.', 'error');
                return;
            }
            
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }
            
            showNotification('Generating all chapter content...', 'info');
            
            try {
                let allContent = '';
                let successCount = 0;
                
                for (let i = 0; i < storyData.chapters.length; i++) {
                    const chapter = storyData.chapters[i];
                    const chapterNumber = chapter.number || (i + 1);
                    
                    showNotification(`Generating Chapter ${chapterNumber} of ${storyData.chapters.length}...`, 'info');
                    
                    try {
                        // Generate content for this chapter
                        await generateChapterContent(chapterNumber);
                        
                        // Get the generated content from the chapter
                        const chapterContent = chapter.content || '';
                        if (chapterContent.trim()) {
                            allContent += `\n\n=== Chapter ${chapterNumber}: ${chapter.title || 'Untitled'} ===\n\n${chapterContent}`;
                            successCount++;
                            
                            // Update chapter status with actual word count
                            updateChapterStatus(chapterNumber, 'complete', `Story complete (${countWords(chapterContent)} words)`);
                            showNotification(`Chapter ${chapterNumber} generated successfully (${countWords(chapterContent)} words)`, 'success');
                        } else {
                            updateChapterStatus(chapterNumber, 'error', 'Failed to generate');
                            showNotification(`Chapter ${chapterNumber}: No content generated`, 'warning');
                        }
                    } catch (chapterError) {
                        console.error(`Error generating chapter ${chapterNumber}:`, chapterError);
                        updateChapterStatus(chapterNumber, 'error', 'Generation failed');
                        showNotification(`Failed to generate Chapter ${chapterNumber}: ${chapterError.message}`, 'error');
                        // Continue with next chapter instead of stopping
                    }
                    
                    // Small delay between chapters to prevent rate limiting
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Add all content to Story Editor if any was generated
                if (allContent.trim()) {
                    addToStoryEditor(allContent.trim());
                    showNotification(`Successfully generated ${successCount}/${storyData.chapters.length} chapters! Content added to Story Editor.`, 'success');
                } else {
                    showNotification('No content was generated for any chapters. Please check your API key and try again.', 'error');
                }
                
            } catch (error) {
                console.error('Chapter generation error:', error);
                showNotification(`Failed to generate all chapters: ${error.message}`, 'error');
            }
        }
        
        function updateChapterStatus(chapterNum, status, message) {
            const statusEl = document.getElementById(`chapter-status-${chapterNum}`);
            if (statusEl) {
                statusEl.className = `chapter-status status-${status} text-xs`;
                statusEl.textContent = message;
            }
        }
        
        // Add content to Story Editor
        function addToStoryEditor(content) {
            const editor = document.getElementById('storyEditor');
            if (editor) {
                if (editor.value.trim()) {
                    editor.value += '\n\n' + content;
                } else {
                    editor.value = content;
                }
                
                // Update word count if function exists
                if (typeof updateWordCount === 'function') {
                    updateWordCount();
                }
                
                // Switch to workspace to show the editor
                showPage('workspace');
                
                // Scroll to editor
                setTimeout(() => {
                    editor.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }
        
        async function generateSingleChapter(chapterNumber) {
            const chapterIndex = chapterNumber - 1;
            if (!storyData.chapters[chapterIndex]) return '';
            
            const chapter = storyData.chapters[chapterIndex];
            
            try {
                updateChapterStatus(chapterNumber, 'generating', 'Creating story content...');
                
                // Enhanced content generation
                const content = await simulateEnhancedContentGeneration(chapter, storyData.settings);
                storyData.chapters[chapterIndex].content = content;
                
                // If this is the current chapter being viewed, update editor
                if (storyData.currentChapter === chapterIndex) {
                    document.getElementById('storyEditor').value = content;
                    updateWordCount();
                    saveToHistory();
                }
                
                updateChapterStatus(chapterNumber, 'complete', `Complete (${countWords(content)} words)`);
                return content;
                
            } catch (error) {
                console.error('Single chapter generation error:', error);
                updateChapterStatus(chapterNumber, 'ready', 'Error - Ready to retry');
                throw error;
            }
        }
        
        async function simulateEnhancedContentGeneration(chapter, settings) {
            // Simulate AI API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const { title, summary, wordTarget } = chapter;
            const { genre, tone } = settings;
            
            // Generate more realistic content based on chapter info
            let content = `${title}\n\n`;
            
            // Generate introduction
            content += generateChapterIntroduction(summary, genre, tone) + '\n\n';
            
            // Calculate paragraphs needed (aim for 150-200 words per paragraph)
            const wordsPerParagraph = 150;
            const paragraphCount = Math.ceil(wordTarget / wordsPerParagraph);
            
            // Generate main content paragraphs
            for (let i = 0; i < paragraphCount - 1; i++) {
                content += generateContentParagraph(genre, tone, summary, i + 1) + '\n\n';
            }
            
            // Generate conclusion paragraph
            content += generateChapterConclusion(summary, genre, tone);
            
            return content.trim();
        }
        
        function generateChapterIntroduction(summary, genre, tone) {
            const intros = {
                'fiction-mystery': [
                    'The morning mist hung heavy over the crime scene as Detective Morrison arrived, coffee still steaming in her hand. What she was about to discover would change everything she thought she knew about this case.',
                    'The call came at 3:47 AM, jarring Detective Chen from a restless sleep. Another body had been found, and the pattern was becoming disturbingly clear.',
                    'Something was wrong with this picture. Detective Rodriguez stood at the edge of the scene, her trained eye catching details that others had missed.'
                ],
                'fiction-romance': [
                    'Sarah had always believed that love at first sight was a myth—until she walked into that coffee shop on a rainy Tuesday morning and saw him.',
                    'The wedding invitation fell from Emma\'s hands like autumn leaves, each word on the elegant cardstock a reminder of what she had lost.',
                    'Marcus had sworn off relationships after his last heartbreak, but when she smiled at him across the bookstore aisle, all his carefully built walls began to crumble.'
                ]
            };
            
            const defaultIntros = [
                'The chapter begins with our protagonist facing a new challenge that will test their resolve and change their perspective.',
                'As events unfold, the characters find themselves in a situation that demands courage and quick thinking.',
                'The story takes an unexpected turn as hidden truths begin to surface and relationships are put to the test.'
            ];
            
            const genreIntros = intros[genre] || defaultIntros;
            return genreIntros[Math.floor(Math.random() * genreIntros.length)];
        }
        
        function generateContentParagraph(genre, tone, summary, position) {
            const paragraphs = {
                'fiction-mystery': [
                    'The evidence pointed in multiple directions, each clue seeming to contradict the last. The detective methodically examined each piece, knowing that somewhere in this puzzle lay the truth.',
                    'Witnesses provided conflicting accounts, their memories clouded by fear and confusion. Separating fact from fiction would require patience and skill.',
                    'A breakthrough came from an unexpected source—a detail so small that others had overlooked it entirely. Sometimes the smallest threads unravel the biggest mysteries.',
                    'The investigation took a darker turn as threats began to surface. Someone was desperate to keep these secrets buried, but the truth had a way of demanding to be heard.'
                ],
                'fiction-romance': [
                    'Their conversations flowed like music, each word building a bridge between two hearts that had been waiting to find each other.',
                    'The obstacles seemed insurmountable—family expectations, career demands, and the fear of vulnerability all conspired to keep them apart.',
                    'In quiet moments together, they discovered that love wasn\'t just about grand gestures but about the small, tender moments that made life meaningful.',
                    'Misunderstandings clouded their judgment, and pride kept them from speaking the words that could heal the growing distance between them.'
                ]
            };
            
            const defaultParagraphs = [
                'The characters navigated through challenges that tested their beliefs and forced them to grow beyond their comfort zones.',
                'Relationships deepened and evolved as trust was built through shared experiences and mutual support during difficult times.',
                'Conflicts arose that revealed the true nature of each character, showing both their strengths and their vulnerabilities.',
                'Resolution began to emerge as the characters learned to work together and understand each other\'s perspectives.'
            ];
            
            const genreParagraphs = paragraphs[genre] || defaultParagraphs;
            return genreParagraphs[position % genreParagraphs.length];
        }
        
        function generateChapterConclusion(summary, genre, tone) {
            const conclusions = {
                'fiction-mystery': [
                    'As the chapter drew to a close, one crucial question remained unanswered, its significance growing like a shadow over the investigation.',
                    'The detective gathered the pieces of evidence, each one forming part of a larger picture that was finally beginning to emerge from the darkness.',
                    'With new leads to follow and fresh determination, the investigation moved forward, bringing both hope and trepidation for what lay ahead.'
                ],
                'fiction-romance': [
                    'As they parted ways that evening, both carried with them a new understanding of what their hearts truly desired.',
                    'The chapter ended with a promise—spoken or unspoken—that their story was far from over.',
                    'Love had planted seeds in their hearts, and though challenges lay ahead, they both sensed that something beautiful was beginning to grow.'
                ]
            };
            
            const defaultConclusions = [
                'The chapter concluded with new possibilities on the horizon and a sense that the characters had grown from their experiences.',
                'As events came to a temporary resolution, the stage was set for even greater challenges and opportunities ahead.',
                'The story paused here, but the journey continued, with each character carrying forward the lessons learned and the bonds formed.'
            ];
            
            const genreConclusions = conclusions[genre] || defaultConclusions;
            return genreConclusions[Math.floor(Math.random() * genreConclusions.length)];
        }
        
        // Enhanced AI Writing Tools
        async function expandStory() {
            const editor = document.getElementById('storyEditor');
            const selectedText = getSelectedText(editor);
            const currentText = selectedText || editor.value;
            
            if (!currentText.trim()) {
                alert('Please enter some text or select text to expand.');
                return;
            }
            
            showLoading('Expanding story with rich details...');
            
            try {
                const expandedText = await simulateEnhancedExpansion(currentText);
                
                if (selectedText) {
                    replaceSelectedText(editor, expandedText);
                } else {
                    editor.value = expandedText;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Story expanded successfully!');
            } catch (error) {
                console.error('Story expansion error:', error);
                alert('Failed to expand story. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedExpansion(text) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const expansions = [
                '\n\nThe atmosphere grew thick with anticipation as details previously hidden began to emerge. Every shadow seemed to hold secrets, every whisper carried weight that would influence the events to come.',
                '\n\nCharacter motivations deepened as their past experiences shaped their current actions. The complexity of human emotion painted layers of meaning into every gesture and spoken word.',
                '\n\nThe setting came alive with sensory details—the way light filtered through windows, the sound of footsteps on different surfaces, the subtle scents that triggered powerful memories.',
                '\n\nDialogue revealed subtext as characters said one thing while meaning another. The space between words held as much significance as the words themselves.'
            ];
            
            return text + expansions[Math.floor(Math.random() * expansions.length)];
        }
        
        async function improveStory() {
            const editor = document.getElementById('storyEditor');
            const selectedText = getSelectedText(editor);
            const currentText = selectedText || editor.value;
            
            if (!currentText.trim()) {
                alert('Please enter some text or select text to improve.');
                return;
            }
            
            showLoading('Enhancing story quality and flow...');
            
            try {
                const improvedText = await simulateEnhancedImprovement(currentText);
                
                if (selectedText) {
                    replaceSelectedText(editor, improvedText);
                } else {
                    editor.value = improvedText;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Story improved with enhanced writing!');
            } catch (error) {
                console.error('Story improvement error:', error);
                alert('Failed to improve story. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedImprovement(text) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            // Enhanced text improvement simulation
            return text.replace(/\b(said)\b/g, 'declared')
                      .replace(/\b(went)\b/g, 'proceeded')
                      .replace(/\b(good)\b/g, 'excellent')
                      .replace(/\b(bad)\b/g, 'troubling')
                      .replace(/\b(big)\b/g, 'substantial')
                      .replace(/\b(small)\b/g, 'delicate');
        }
        
        async function addDialogue() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Crafting meaningful dialogue...');
            
            try {
                const dialogue = await simulateEnhancedDialogue();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + dialogue + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                // Position cursor after inserted dialogue
                editor.selectionStart = editor.selectionEnd = insertionPoint + dialogue.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Dialogue added with character depth!');
            } catch (error) {
                console.error('Dialogue generation error:', error);
                alert('Failed to add dialogue. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedDialogue() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const dialogues = [
                '"I never thought I\'d see you again," she whispered, her voice carrying years of unspoken emotion.\n\nHis eyes softened as he replied, "Some connections transcend time and distance. I\'ve been waiting for this moment."',
                '"The truth isn\'t always what we want to hear," the mentor said, choosing each word carefully.\n\n"But it\'s what I need to know," the student responded with newfound determination. "I\'m ready for whatever comes next."',
                '"This changes everything we thought we knew," the detective muttered, studying the evidence.\n\n"Maybe that\'s exactly what we needed," her partner replied. "Sometimes you have to break the old patterns to see clearly."'
            ];
            return dialogues[Math.floor(Math.random() * dialogues.length)];
        }
        
        async function addDescription() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Adding vivid descriptive passages...');
            
            try {
                const description = await simulateEnhancedDescription();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + description + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + description.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Rich descriptions added to enhance atmosphere!');
            } catch (error) {
                console.error('Description generation error:', error);
                alert('Failed to add description. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedDescription() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const descriptions = [
                'The library stood like a cathedral of knowledge, its towering shelves casting long shadows in the afternoon light. Dust particles danced in golden beams, and the musty scent of aged paper whispered stories of countless readers who had walked these halls before.',
                'Rain drummed against the windows with increasing intensity, each drop creating rivulets that distorted the city lights beyond. The storm seemed to mirror the turbulence in her heart as she faced the decision that would change everything.',
                'The old mansion creaked with the weight of its secrets, every floorboard a potential betrayer of footsteps. Moonlight filtered through heavy curtains, painting silver patterns on walls that had witnessed decades of human drama.',
                'The market bustled with life—vendors calling their wares, children weaving between stalls, and the rich aroma of spices creating an intoxicating blend that spoke of distant lands and ancient traditions.'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }
        
        async function createTransition() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Creating smooth narrative transitions...');
            
            try {
                const transition = await simulateEnhancedTransition();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + transition + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + transition.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Smooth transition created to connect story elements!');
            } catch (error) {
                console.error('Transition generation error:', error);
                alert('Failed to create transition. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedTransition() {
            await new Promise(resolve => setTimeout(resolve, 1200));
            const transitions = [
                'Time seemed to fold in on itself as the significance of recent events began to crystallize. What had seemed like separate incidents now revealed themselves as pieces of a larger, more complex puzzle.',
                'The following days blurred together in a cascade of revelations and realizations. Each new discovery built upon the last, creating momentum that carried the story forward with unstoppable force.',
                'As the sun set on that momentous day, a new chapter began—one that would test everything the characters thought they knew about themselves and each other.',
                'The shift was subtle at first, like the changing of seasons. But as hours turned to days, it became clear that nothing would ever be quite the same again.'
            ];
            return transitions[Math.floor(Math.random() * transitions.length)];
        }
        
        async function addConflict() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Introducing compelling conflict elements...');
            
            try {
                const conflict = await simulateEnhancedConflict();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + conflict + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + conflict.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Compelling conflict added to drive the narrative!');
            } catch (error) {
                console.error('Conflict generation error:', error);
                alert('Failed to add conflict. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedConflict() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const conflicts = [
                'An unexpected message arrived that challenged everything they believed about the situation. The implications were staggering, forcing them to question not just their assumptions, but their fundamental understanding of what was at stake.',
                'Long-buried tensions finally erupted to the surface, creating fractures in relationships that had seemed unshakeable. Trust, once broken, would not be easily repaired—if it could be repaired at all.',
                'The deadline loomed like a storm on the horizon, and with each passing hour, the options grew fewer and the consequences more severe. Difficult choices lay ahead, and there was no guarantee that everyone would emerge unscathed.',
                'Hidden agendas came to light, revealing that allies might be enemies and enemies might hold the key to salvation. In this new landscape of shifting loyalties, navigation required both courage and cunning.'
            ];
            return conflicts[Math.floor(Math.random() * conflicts.length)];
        }
        
        // ============ NEW CHAPTER EDITING TOOLS ============
        
        async function plotHoleDetector() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to analyze for plot holes. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Analyzing ${storyData.chapters.length} chapters for plot holes across the entire story...` :
                'Analyzing story logic and continuity...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const analysis = await callOpenAI([
                    {
                        role: "system",
                        content: "You are an investigative story analyst who cross-checks logic, causality, continuity, stakes, and character motivation across an entire story. Identify gaps or mistakes that don't make sense and provide specific suggestions on how to fix them. Pay special attention to consistency across multiple chapters."
                    },
                    {
                        role: "user", 
                        content: `Analyze this complete story for plot holes, logical inconsistencies, and continuity errors across all chapters. Provide specific feedback and actionable suggestions:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Plot analysis complete - check suggestions below!', 'success');
                displayToolResult('Plot Hole Detection Analysis', analysis);
                
            } catch (error) {
                console.error('Plot hole detection error:', error);
                hideLoading();
                showNotification('Failed to analyze plot holes. Please check your API key and try again.', 'error');
            }
        }
        
        async function characterArcDesigner() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to enhance character development. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Designing character arcs across ${storyData.chapters.length} chapters...` :
                'Designing character development arc...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const enhancement = await callOpenAI([
                    {
                        role: "system",
                        content: "You are a developmental editor specializing in internal character change (positive, negative, or flat arcs) across complete stories. Analyze character development throughout the entire narrative and provide suggestions for meaningful character growth from beginning to end."
                    },
                    {
                        role: "user",
                        content: `Analyze and enhance the character development throughout this complete story. Suggest specific improvements for character growth, internal conflict, and meaningful change across all chapters:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Character arc enhancements ready!', 'success');
                displayToolResult('Character Arc Design', enhancement);
                
            } catch (error) {
                console.error('Character arc error:', error);
                hideLoading();
                showNotification('Failed to enhance character arc. Please try again.', 'error');
            }
        }
        
        async function toneShifter() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to adjust tone and style. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Analyzing and adjusting tone consistency across ${storyData.chapters.length} chapters...` :
                'Analyzing and adjusting tone consistency...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const adjusted = await callOpenAI([
                    {
                        role: "system",
                        content: "You are a stylist who can diagnose current tone and retarget it. Adjust mood and style for consistency and target audience appropriateness."
                    },
                    {
                        role: "user",
                        content: `Analyze the current tone throughout this complete story and suggest adjustments for consistency and target audience. Focus on maintaining tone across all chapters:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, adjusted);
                } else {
                    editor.value = adjusted;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Tone successfully adjusted for consistency!', 'success');
                
            } catch (error) {
                console.error('Tone shift error:', error);
                hideLoading();
                showNotification('Failed to adjust tone. Please try again.', 'error');
            }
        }
        
        async function conflictIntensifier() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to intensify conflict. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Intensifying conflict and raising stakes across ${storyData.chapters.length} chapters...` :
                'Intensifying conflict and raising stakes...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const intensified = await callOpenAI([
                    {
                        role: "system",
                        content: "You raise friction at macro and micro levels without melodrama. Add tension and drama by making characters' goals and obstacles clash more strongly."
                    },
                    {
                        role: "user",
                        content: `Intensify the conflict throughout this complete story. Add more tension without being melodramatic. Make goals and obstacles clash more strongly across all chapters:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, intensified);
                } else {
                    editor.value = intensified;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Conflict successfully intensified!', 'success');
                
            } catch (error) {
                console.error('Conflict intensifier error:', error);
                hideLoading();
                showNotification('Failed to intensify conflict. Please try again.', 'error');
            }
        }
        
        async function dialogueEnhancer() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to enhance dialogue. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Enhancing dialogue with subtext and authenticity across ${storyData.chapters.length} chapters...` :
                'Enhancing dialogue with subtext and authenticity...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const enhanced = await callOpenAI([
                    {
                        role: "system",
                        content: "You are a dialogue punch-up artist specializing in subtext, voice distinction, compression, and plausibility. Make conversations sound more real, engaging, and filled with hidden meaning."
                    },
                    {
                        role: "user",
                        content: `Enhance the dialogue throughout this complete story to be more real, engaging, and layered with subtext. Improve voice distinction and compress unnecessary words across all chapters:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, enhanced);
                } else {
                    editor.value = enhanced;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Dialogue enhanced with natural flow and subtext!', 'success');
                
            } catch (error) {
                console.error('Dialogue enhancer error:', error);
                hideLoading();
                showNotification('Failed to enhance dialogue. Please try again.', 'error');
            }
        }
        
        async function symbolismSuggester() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to add symbolic depth. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Curating meaningful symbols and motifs across ${storyData.chapters.length} chapters...` :
                'Curating meaningful symbols and motifs...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const suggestions = await callOpenAI([
                    {
                        role: "system",
                        content: "You curate a coherent symbol system aligned to theme, character arcs, and setting. Suggest meaningful symbols or motifs that give stories extra depth and layers of meaning."
                    },
                    {
                        role: "user",
                        content: `Analyze this complete story and suggest specific symbols, motifs, or symbolic elements that would add depth and meaning throughout all chapters. Provide both suggestions and examples of how to incorporate them:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Symbolism suggestions generated!', 'success');
                displayToolResult('Symbolism & Motif Suggestions', suggestions);
                
            } catch (error) {
                console.error('Symbolism suggester error:', error);
                hideLoading();
                showNotification('Failed to generate symbolism suggestions. Please try again.', 'error');
            }
        }
        
        async function metaphorGenerator() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to enhance with metaphors. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Generating fresh, vivid metaphors across ${storyData.chapters.length} chapters...` :
                'Generating fresh, vivid metaphors...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const enhanced = await callOpenAI([
                    {
                        role: "system",
                        content: "You generate fresh, precise figurative language matching POV, tone, and genre. Create vivid comparisons that make descriptions more powerful and memorable."
                    },
                    {
                        role: "user",
                        content: `Enhance this complete story with fresh, vivid metaphors and figurative language throughout all chapters. Make descriptions more powerful and memorable:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, enhanced);
                } else {
                    editor.value = enhanced;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Text enhanced with vivid metaphors!', 'success');
                
            } catch (error) {
                console.error('Metaphor generator error:', error);
                hideLoading();
                showNotification('Failed to generate metaphors. Please try again.', 'error');
            }
        }
        
        async function themeTracker() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to analyze themes. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Tracking thematic consistency across ${storyData.chapters.length} chapters...` :
                'Tracking thematic consistency...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const analysis = await callOpenAI([
                    {
                        role: "system",
                        content: "You ensure thematic questions are dramatized and echoed consistently. Keep the story's big idea or moral consistent and visible throughout the book."
                    },
                    {
                        role: "user",
                        content: `Analyze this complete story for thematic elements and consistency across all chapters. Identify the main themes and suggest how to strengthen or maintain thematic coherence throughout:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Theme analysis complete!', 'success');
                displayToolResult('Theme Tracking Analysis', analysis);
                
            } catch (error) {
                console.error('Theme tracker error:', error);
                hideLoading();
                showNotification('Failed to analyze themes. Please try again.', 'error');
            }
        }
        
        async function emotionalResonanceChecker() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to check emotional resonance. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Calibrating emotional resonance across ${storyData.chapters.length} chapters...` :
                'Calibrating emotional resonance...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const analysis = await callOpenAI([
                    {
                        role: "system",
                        content: "You calibrate character feelings vs reader emotions. Ensure readers feel the emotions you want them to feel at the right time in the story."
                    },
                    {
                        role: "user",
                        content: `Analyze the emotional resonance of this complete story across all chapters. How will readers feel throughout? Are character emotions clearly conveyed? Suggest improvements for emotional impact:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Emotional resonance analysis complete!', 'success');
                displayToolResult('Emotional Resonance Check', analysis);
                
            } catch (error) {
                console.error('Emotional resonance error:', error);
                hideLoading();
                showNotification('Failed to check emotional resonance. Please try again.', 'error');
            }
        }
        
        async function redHerringGenerator() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to add mystery elements. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Designing fair-play misdirection across ${storyData.chapters.length} chapters...` :
                'Designing fair-play misdirection...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const suggestions = await callOpenAI([
                    {
                        role: "system",
                        content: "You design fair-play misdirection for mystery/thriller stories. Add clever misdirections that keep readers guessing without cheating."
                    },
                    {
                        role: "user",
                        content: `Analyze this complete story and suggest red herrings or misdirection elements for mystery/thriller across all chapters. Ensure they're fair-play and don't cheat the reader:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Red herring suggestions ready!', 'success');
                displayToolResult('Red Herring & Misdirection Ideas', suggestions);
                
            } catch (error) {
                console.error('Red herring generator error:', error);
                hideLoading();
                showNotification('Failed to generate red herrings. Please try again.', 'error');
            }
        }
        
        async function pacingBalancer() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to balance pacing. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Regulating story rhythm and pacing across ${storyData.chapters.length} chapters...` :
                'Regulating story rhythm and pacing...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const balanced = await callOpenAI([
                    {
                        role: "system",
                        content: "You regulate rhythm at global, scene, and line levels. Control the speed and rhythm of stories so they never feel too slow or rushed."
                    },
                    {
                        role: "user",
                        content: `Analyze and adjust the pacing of this complete story across all chapters. Ensure it flows well and doesn't feel rushed or dragging throughout:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, balanced);
                } else {
                    editor.value = balanced;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Pacing successfully balanced!', 'success');
                
            } catch (error) {
                console.error('Pacing balancer error:', error);
                hideLoading();
                showNotification('Failed to balance pacing. Please try again.', 'error');
            }
        }
        
        async function subtextBuilder() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to add subtext. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Converting to layered interactions with subtext across ${storyData.chapters.length} chapters...` :
                'Converting to layered interactions with subtext...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const enhanced = await callOpenAI([
                    {
                        role: "system",
                        content: "You convert on-the-nose exchanges into layered interactions. Help characters say one thing but mean another, adding layers of hidden meaning to dialogue."
                    },
                    {
                        role: "user",
                        content: `Add subtext and layers throughout this complete story. Make characters say one thing but mean another across all chapters. Convert direct statements into more nuanced, layered communication:\n\n${allChaptersText}`
                    }
                ]);
                
                if (getSelectedText(editor)) {
                    replaceSelectedText(editor, enhanced);
                } else {
                    editor.value = enhanced;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showNotification('Subtext and layers successfully added!', 'success');
                
            } catch (error) {
                console.error('Subtext builder error:', error);
                hideLoading();
                showNotification('Failed to build subtext. Please try again.', 'error');
            }
        }
        
        // ============ FORENSIC AI DETECTION & HUMANIZATION ============
        
        async function forensicAIDetection() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to analyze. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Performing forensic AI detection analysis across ${storyData.chapters.length} chapters...` :
                'Performing forensic AI detection analysis...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const analysis = await callOpenAI([
                    {
                        role: "system",
                        content: `You are an AI authorship detection specialist. You must combine statistical-style analysis (similar to Quill/GPTZero) with detailed forensic reasoning to determine the likelihood that a piece of text was AI-generated.

Follow these steps:

1. **Initial Read-Through**
   - Read the text in full before analyzing.
   - Get a general impression of tone, flow, and content.

2. **Statistical-Style Scoring**
   - Estimate **Perplexity**: Rate how predictable the text is on a scale from 0 (very random) to 100 (extremely predictable).
   - Estimate **Burstiness**: Rate variation in sentence length/complexity from 0 (very uniform) to 100 (very varied).
   - Measure **Lexical Variance**: Rate the diversity of vocabulary from 0 (very repetitive) to 100 (very diverse).
   - Flag repetitive n-grams or recurring exact phrases.

3. **Forensic-Style Analysis**
   Identify and explain:
   - Signs of AI authorship:
     * Overly balanced tone and structure.
     * Generic statements lacking specific, verifiable detail.
     * Excessive grammatical precision without human-like irregularities.
     * Mechanical transitions or "list-like" flow.
   - Signs of human authorship:
     * Authentic personal details or anecdotes.
     * Emotional nuance, contradictions, or spontaneity.
     * Minor errors or idiosyncratic phrasing.

4. **Hybrid Conclusion**
   - Provide a combined **AI Likelihood Score** (0–100%) that factors in both statistical and forensic observations.
   - Explain the reasoning: cite specific sentences or patterns.
   - Give a confidence level (High/Medium/Low).
   - If uncertainty is high, recommend further verification.

**Output Format:**
---
📊 **Statistical Indicators**
- Perplexity: [xx/100]
- Burstiness: [xx/100] 
- Lexical Variance: [xx/100]
- Repeated n-grams: [list]

🔍 **Forensic Observations**
- Indicators Suggesting AI: [bullet list]
- Indicators Suggesting Human: [bullet list]
- Key Evidence: [paragraph citing examples]

📈 **Conclusion**
- AI Likelihood Score: [xx%]
- Confidence Level: [High/Medium/Low]
- Recommendation: [short statement]
---`
                    },
                    {
                        role: "user",
                        content: allChaptersText
                    }
                ]);
                
                hideLoading();
                
                // Extract AI likelihood score
                const scoreMatch = analysis.match(/AI Likelihood Score:\s*(\d+)%/);
                const aiScore = scoreMatch ? parseInt(scoreMatch[1]) : 50;
                
                // Display enhanced results with score
                displayForensicResults(analysis, aiScore);
                
                // Enable buttons based on score
                updateForensicButtons(aiScore);
                
                showNotification(`Forensic AI analysis complete! Score: ${aiScore}%`, 'success');
                
            } catch (error) {
                console.error('Forensic AI detection error:', error);
                hideLoading();
                showNotification('Failed to perform AI detection analysis. Please check your API key and try again.', 'error');
            }
        }
        
        async function humanizeText() {
            const allChaptersText = getAllChaptersText();
            
            if (!allChaptersText.trim()) {
                showNotification('Please have story content to humanize. Generate chapters or write content first.', 'warning');
                return;
            }
            
            const chapterInfo = hasMultipleChapters() ? 
                `Humanizing text while preserving meaning across ${storyData.chapters.length} chapters...` :
                'Humanizing text while preserving meaning...';
            
            showLoading(chapterInfo, 'book');
            
            try {
                const humanized = await callOpenAI([
                    {
                        role: "system",
                        content: `You are a writing humanization expert. Your task is to rewrite the complete story to make it feel more human-like without altering core meaning.

When activated:
1. Maintain the original meaning and factual accuracy across all chapters.
2. Add human-like characteristics:
   - Minor imperfections and sentence variety.
   - More natural transitions between thoughts and chapters.
   - Occasional colloquial expressions or idiomatic phrases (if context-appropriate).
   - Inclusion of concrete, sensory, or emotionally nuanced details.
3. Break overly uniform sentence structures.
4. Adjust vocabulary to feel contextually authentic, not overly formal unless required.
5. Ensure the tone matches the intended audience throughout.
6. Maintain chapter structure and formatting.

Provide only the humanized version without any comparison or analysis.`
                    },
                    {
                        role: "user",
                        content: `Please humanize this complete story to make it feel more natural and human-written while preserving the core meaning and chapter structure:\n\n${allChaptersText}`
                    }
                ]);
                
                hideLoading();
                showNotification('Text humanization complete!', 'success');
                
                // Show humanized result with save/keep options
                displayHumanizationResult(humanized, allChaptersText);
                
                // Scroll to results
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('Humanization error:', error);
                hideLoading();
                showNotification('Failed to humanize text. Please check your API key and try again.', 'error');
            }
        }
        
        function displayHumanizationResult(humanizedText, originalText) {
            // Create a modal to show the result
            const resultModal = document.createElement('div');
            resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-theme-secondary p-6 rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto border-2 border-theme m-4';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">
                        <i class="fas fa-magic mr-2"></i>Humanized Text Result
                    </h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-theme-secondary hover:text-red-400 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                        <h4 class="text-lg font-semibold text-theme-primary mb-2">Humanized Version:</h4>
                        <div class="text-theme-primary whitespace-pre-wrap max-h-96 overflow-y-auto p-3 bg-gray-800 rounded border">${humanizedText}</div>
                    </div>
                    
                    <div class="flex gap-3 justify-center">
                        <button id="saveHumanizedBtn" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button id="keepOriginalBtn" class="btn-secondary px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-undo mr-2"></i>Keep Original
                        </button>
                    </div>
                    
                    <div class="text-center text-sm text-theme-secondary">
                        <i class="fas fa-info-circle mr-1"></i>
                        You can manually run Forensic AI Detection after saving to check if the AI percentage improved.
                    </div>
                </div>
            `;
            
            resultModal.appendChild(modalContent);
            document.body.appendChild(resultModal);
            
            // Add event listeners for the buttons
            document.getElementById('saveHumanizedBtn').addEventListener('click', () => {
                saveHumanizedText(humanizedText);
                resultModal.remove();
            });
            
            document.getElementById('keepOriginalBtn').addEventListener('click', () => {
                showNotification('Original text kept - no changes made.', 'info');
                resultModal.remove();
            });
        }
        
        function saveHumanizedText(humanizedText) {
            // Parse the humanized text back into chapters if multiple chapters exist
            if (hasMultipleChapters()) {
                const chapterSections = humanizedText.split(/===\s*Chapter\s*\d+.*?===/g).filter(section => section.trim());
                
                if (chapterSections.length > 0) {
                    // Update the chapters in storyData
                    storyData.chapters.forEach((chapter, index) => {
                        if (chapterSections[index]) {
                            chapter.content = chapterSections[index].trim();
                        }
                    });
                    
                    // Update the current editor if viewing a chapter
                    const editor = document.getElementById('storyEditor');
                    if (editor && storyData.currentChapter < storyData.chapters.length) {
                        editor.value = storyData.chapters[storyData.currentChapter].content || '';
                    }
                    
                    updateWordCount();
                    showNotification('Humanized text saved successfully across all chapters!', 'success');
                } else {
                    // Fallback: treat as single content
                    const editor = document.getElementById('storyEditor');
                    if (editor) {
                        editor.value = humanizedText;
                        updateWordCount();
                    }
                    showNotification('Humanized text saved successfully!', 'success');
                }
            } else {
                // Single content update
                const editor = document.getElementById('storyEditor');
                if (editor) {
                    editor.value = humanizedText;
                    updateWordCount();
                }
                showNotification('Humanized text saved successfully!', 'success');
            }
            
            // Save to history for undo functionality
            saveToHistory();
        }
        
        function displayForensicResults(analysis, aiScore) {
            const resultsDiv = document.getElementById('forensicResults');
            
            // Determine score color and recommendation
            let scoreColor, recommendation, icon;
            if (aiScore >= 70) {
                scoreColor = 'text-red-400';
                recommendation = 'High AI likelihood - Humanization strongly recommended';
                icon = '🤖';
            } else if (aiScore >= 40) {
                scoreColor = 'text-yellow-400';
                recommendation = 'Moderate AI likelihood - Consider humanization';
                icon = '⚠️';
            } else {
                scoreColor = 'text-green-400';
                recommendation = 'Low AI likelihood - Appears human-written';
                icon = '✅';
            }
            
            resultsDiv.className = 'mt-4';
            resultsDiv.innerHTML = `
                <div class="bg-theme-primary p-6 rounded-lg border border-theme">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-purple-400">
                            <i class="fas fa-microscope mr-2"></i>Forensic Analysis Results
                        </h4>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${scoreColor}">${icon} ${aiScore}%</div>
                            <div class="text-xs text-theme-secondary">AI Likelihood</div>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-3 rounded ${aiScore >= 70 ? 'bg-red-900 bg-opacity-20 border border-red-600' : 
                                                    aiScore >= 40 ? 'bg-yellow-900 bg-opacity-20 border border-yellow-600' : 
                                                    'bg-green-900 bg-opacity-20 border border-green-600'}">
                        <div class="font-medium ${scoreColor} mb-1">Assessment:</div>
                        <div class="text-sm">${recommendation}</div>
                    </div>
                    
                    <div class="bg-theme-secondary p-4 rounded border border-theme">
                        <pre class="text-sm text-theme-primary whitespace-pre-wrap">${analysis}</pre>
                    </div>
                </div>
            `;
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function updateForensicButtons(aiScore) {
            const humanizeBtn = document.getElementById('humanizeBtn');
            const reanalyzeBtn = document.getElementById('reanalyzeBtn');
            
            // Enable humanization based on AI score
            if (aiScore >= 30) {
                humanizeBtn.disabled = false;
                humanizeBtn.style.opacity = '1';
            } else {
                humanizeBtn.disabled = true;
                humanizeBtn.style.opacity = '0.5';
            }
            
            // Always enable reanalyze after first analysis
            reanalyzeBtn.disabled = false;
            reanalyzeBtn.style.opacity = '1';
        }

        function reanalyzeText() {
            showNotification('🔄 Performing new analysis on current text...', 'info');
            forensicAIDetection();
        }

        // ============ UTILITY FUNCTIONS FOR TOOLS ============
        
        async function callOpenAI(messages) {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                throw new Error('OpenAI API key not configured');
            }
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: messages,
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenAI API Error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function displayToolResult(title, content) {
            // Create a modal or result display
            const resultModal = document.createElement('div');
            resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-theme-secondary p-6 rounded-lg max-w-4xl max-h-[80vh] overflow-y-auto border-2 border-theme';
            
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">${title}</h3>
                    <button class="close-modal text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="bg-theme-primary p-4 rounded border border-theme">
                    <pre class="text-sm text-theme-primary whitespace-pre-wrap">${content}</pre>
                </div>
                <div class="flex justify-between mt-4">
                    <div class="text-xs text-theme-secondary">
                        💡 <strong>Tip:</strong> Copy suggestions for manual review or apply them automatically
                    </div>
                    <div class="flex space-x-3">
                        <button class="close-modal btn-gray px-4 py-2 rounded">
                            <i class="fas fa-times mr-1"></i>Close
                        </button>
                        <button class="copy-suggestions btn-secondary px-4 py-2 rounded">
                            <i class="fas fa-copy mr-1"></i>Copy Suggestions
                        </button>
                        <button class="apply-changes btn-primary px-4 py-2 rounded">
                            <i class="fas fa-magic mr-1"></i>Apply Changes
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            modalContent.querySelector('.close-modal').addEventListener('click', () => {
                resultModal.remove();
            });
            
            modalContent.querySelector('.copy-suggestions').addEventListener('click', () => {
                copyAnalysis(title, content);
            });
            
            modalContent.querySelector('.apply-changes').addEventListener('click', () => {
                applyToolChanges(title, content, resultModal);
            });
            
            resultModal.appendChild(modalContent);
            document.body.appendChild(resultModal);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Result copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function copyAnalysis(title, content) {
            const textToCopy = `${title}\n${'='.repeat(title.length)}\n\n${content}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('📋 Analysis copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function saveEditState() {
            const editor = document.getElementById('storyEditor');
            if (editor && editor.value !== (editHistory[historyIndex] || '')) {
                // Remove future history if we're not at the end
                if (historyIndex < editHistory.length - 1) {
                    editHistory = editHistory.slice(0, historyIndex + 1);
                }
                
                // Add new state
                editHistory.push(editor.value);
                historyIndex++;
                
                // Limit history size
                if (editHistory.length > 50) {
                    editHistory.shift();
                    historyIndex--;
                }
                
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            const undoBtns = document.querySelectorAll('button[onclick="undoEdit()"]');
            const redoBtns = document.querySelectorAll('button[onclick="redoEdit()"]');
            
            undoBtns.forEach(btn => {
                btn.disabled = historyIndex <= 0;
                btn.style.opacity = historyIndex <= 0 ? '0.5' : '1';
            });
            
            redoBtns.forEach(btn => {
                btn.disabled = historyIndex >= editHistory.length - 1;
                btn.style.opacity = historyIndex >= editHistory.length - 1 ? '0.5' : '1';
            });
        }
        
        function updateHistoryButtons() {
            const undoBtns = document.querySelectorAll('[onclick="undoEdit()"]');
            const redoBtns = document.querySelectorAll('[onclick="redoEdit()"]');
            
            undoBtns.forEach(btn => {
                btn.disabled = historyIndex <= 0;
                btn.style.opacity = historyIndex <= 0 ? '0.5' : '1';
            });
            
            redoBtns.forEach(btn => {
                btn.disabled = historyIndex >= editHistory.length - 1;
                btn.style.opacity = historyIndex >= editHistory.length - 1 ? '0.5' : '1';
            });
        }

        async function applyToolChanges(title, suggestions, modal) {
            const editor = document.getElementById('storyEditor');
            const selectedText = getSelectedText(editor);
            const currentText = selectedText || editor.value;
            
            if (!currentText.trim()) {
                showNotification('No text to apply changes to', 'warning');
                return;
            }

            const confirmed = confirm(`Apply AI suggestions from "${title}" to your text?\n\nThis will modify your content based on the analysis.`);
            if (!confirmed) return;

            // Save current state before making changes
            saveEditState();

            showLoading('Applying AI suggestions to your text...');
            
            try {
                const improvedText = await callOpenAI([
                    {
                        role: "system",
                        content: "You are an expert editor. Apply the provided suggestions to improve the given text. Return ONLY the revised text, maintaining the original style and voice while implementing the suggested improvements."
                    },
                    {
                        role: "user",
                        content: `Original text:\n${currentText}\n\nSuggestions to apply:\n${suggestions}\n\nPlease provide the improved version:`
                    }
                ]);

                // Apply the changes
                if (selectedText) {
                    // Replace selected text
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    editor.value = editor.value.substring(0, start) + improvedText + editor.value.substring(end);
                } else {
                    // Replace entire content
                    editor.value = improvedText;
                }

                // Update word count and save new state
                updateWordCount();
                saveEditState();
                
                hideLoading();
                modal.remove();
                
                showNotification(`✨ ${title} suggestions applied successfully!`, 'success');

            } catch (error) {
                console.error('Error applying suggestions:', error);
                hideLoading();
                showNotification('Failed to apply suggestions. Please try again.', 'error');
            }
        }
        
        // Utility Functions
        function getSelectedText(element) {
            const start = element.selectionStart;
            const end = element.selectionEnd;
            return start !== end ? element.value.substring(start, end) : '';
        }
        
        function replaceSelectedText(element, newText) {
            const start = element.selectionStart;
            const end = element.selectionEnd;
            const currentText = element.value;
            
            element.value = currentText.substring(0, start) + newText + currentText.substring(end);
            
            // Position cursor at end of replaced text
            element.selectionStart = element.selectionEnd = start + newText.length;
            element.focus();
        }
        
        // Enhanced word counting function
        function countWords(text) {
            if (!text || typeof text !== 'string') return 0;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            return text.trim() === '' ? 0 : words.length;
        }
        
        function updateWordCount() {
            const editor = document.getElementById('storyEditor');
            const text = editor.value;
            const wordCount = countWords(text);
            
            const wordCountElement = document.getElementById('wordCount');
            if (wordCountElement) {
                wordCountElement.textContent = `${wordCount.toLocaleString()} words`;
                
                // Update color based on target
                const target = storyData.settings?.wordsPerChapter || 1000;
                if (wordCount >= target) {
                    wordCountElement.style.color = '#10b981'; // green
                } else if (wordCount >= target * 0.7) {
                    wordCountElement.style.color = '#f59e0b'; // yellow
                } else {
                    wordCountElement.style.color = '#78e3fe'; // cyan
                }
            }
        }
        
        // Enhanced history management
        function saveToHistory() {
            const editor = document.getElementById('storyEditor');
            const currentState = editor.value;
            
            // Don't save if it's the same as the last state
            if (editHistory.length > 0 && editHistory[historyIndex] === currentState) {
                return;
            }
            
            // Remove future history if we're not at the end
            if (historyIndex < editHistory.length - 1) {
                editHistory = editHistory.slice(0, historyIndex + 1);
            }
            
            // Add new state to history
            editHistory.push(currentState);
            
            // Limit history size
            if (editHistory.length > maxHistorySize) {
                editHistory.shift();
            } else {
                historyIndex++;
            }
            
            updateHistoryButtons();
        }
        
        function undoEdit() {
            if (historyIndex > 0) {
                historyIndex--;
                const editor = document.getElementById('storyEditor');
                if (editor) {
                    editor.value = editHistory[historyIndex] || '';
                    updateWordCount();
                }
                updateUndoRedoButtons();
                showNotification('⏪ Changes undone', 'info');
            }
        }
        
        function redoEdit() {
            if (historyIndex < editHistory.length - 1) {
                historyIndex++;
                const editor = document.getElementById('storyEditor');
                if (editor) {
                    editor.value = editHistory[historyIndex] || '';
                    updateWordCount();
                }
                updateUndoRedoButtons();
                showNotification('⏩ Changes redone', 'info');
            }
        }
        
        function saveStory() {
            const editor = document.getElementById('storyEditor');
            const content = editor.value;
            
            // Save to localStorage with timestamp
            const saveData = {
                content: content,
                storyData: storyData,
                timestamp: new Date().toISOString(),
                wordCount: countWords(content)
            };
            
            localStorage.setItem('authorr_story_save', JSON.stringify(saveData));
            localStorage.setItem('authorr_story_content', content);
            localStorage.setItem('authorr_story_data', JSON.stringify(storyData));
            
            // Visual feedback
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
            saveBtn.classList.add('success-border');
            
            showStatusMessage(`Story saved! (${countWords(content)} words)`);
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('success-border');
            }, 2000);
        }
        
        function setupAutoSave() {
            const editor = document.getElementById('storyEditor');
            if (editor) {
                let autoSaveTimer;
                
                editor.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        if (document.getElementById('autoSave').checked) {
                            saveStory();
                        }
                    }, 30000);
                });
            }
        }
        
        // Status messaging system
        function showStatusMessage(message) {
            // Create or update status message element
            let statusEl = document.getElementById('statusMessage');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'statusMessage';
                statusEl.className = 'fixed bottom-4 right-4 bg-cyan-400 text-black px-4 py-2 rounded-lg font-semibold z-50 transition-all duration-300';
                document.body.appendChild(statusEl);
            }
            
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.opacity = '1';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // Narration Functions
        function transferStoryToNarration() {
            const editor = document.getElementById('storyEditor');
            const content = editor.value;
            
            if (content.trim()) {
                storyData.currentContent = content;
                
                // Update preview text with first paragraph
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const previewText = sentences.slice(0, 2).join('. ') + '.';
                document.getElementById('previewText').value = previewText;
                
                showStatusMessage('Story transferred to narration page');
            }
        }
        
        async function previewVoice() {
            const previewText = document.getElementById('previewText').value;
            const selectedVoice = document.getElementById('voiceSelection').value;
            
            if (!previewText.trim()) {
                alert('Please enter text to preview.');
                return;
            }
            
            showLoading(`Generating voice preview with ${selectedVoice}...`);
            
            try {
                await simulateVoicePreview(previewText, selectedVoice);
                hideLoading();
                showStatusMessage(`Voice preview for "${selectedVoice}" generated successfully!`);
            } catch (error) {
                console.error('Voice preview error:', error);
                alert('Failed to generate voice preview. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateVoicePreview(text, voice) {
            // Simulate TTS API call
            await new Promise(resolve => setTimeout(resolve, 2500));
            console.log(`Generated preview with voice: ${voice}, text: ${text.substring(0, 50)}...`);
        }
        
        async function generateNarration() {
            const content = storyData.currentContent || document.getElementById('storyEditor').value;
            const selectedVoice = document.getElementById('voiceSelection').value;
            const speechRate = document.getElementById('speechRate').value;
            const audioFormat = document.getElementById('audioFormat').value;
            
            if (!content.trim()) {
                alert('No story content found. Please create content in the workspace first.');
                return;
            }
            
            document.getElementById('narrationProgress').classList.remove('hidden');
            showProgressBar();
            
            try {
                await simulateFullNarrationGeneration(content, selectedVoice, speechRate, audioFormat);
                displayEnhancedAudioResults(selectedVoice, audioFormat);
                showStatusMessage('Full narration generated successfully!');
            } catch (error) {
                console.error('Narration generation error:', error);
                alert('Failed to generate narration. Please try again.');
            } finally {
                document.getElementById('narrationProgress').classList.add('hidden');
            }
        }
        
        async function simulateFullNarrationGeneration(content, voice, rate, format) {
            // Simulate progress through content
            const chapters = storyData.chapters.length || 5;
            
            for (let i = 0; i < chapters; i++) {
                const progress = ((i + 1) / chapters) * 100;
                updateProgressBar(progress);
                updateLoadingText(`Generating audio for chapter ${i + 1} of ${chapters} with ${voice} voice...`);
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        }
        
        function showProgressBar() {
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
        }
        
        function updateProgressBar(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
        }
        
        function displayEnhancedAudioResults(voice, format) {
            const resultsContainer = document.getElementById('audioResults');
            const chapterCount = storyData.chapters.length || 5;
            
            let resultsHTML = `
                <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                    <h3 class="font-semibold mb-3">Generated Audio Files (${voice} voice, ${format} format)</h3>
                    <div class="space-y-2">
            `;
            
            for (let i = 1; i <= chapterCount; i++) {
                resultsHTML += `
                    <div class="flex justify-between items-center p-2 bg-theme-secondary rounded">
                        <span>Chapter ${i} - ${storyData.chapters[i-1]?.title || `Part ${i}`}</span>
                        <div class="space-x-2">
                            <button class="btn-secondary px-2 py-1 rounded text-xs">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="btn-primary px-2 py-1 rounded text-xs">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                `;
            }
            
            resultsHTML += `
                    </div>
                    <div class="mt-4 text-center">
                        <button class="btn-primary px-6 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>Download All Audio Files
                        </button>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // Book Cover Generation
        async function generateCover() {
            const style = document.getElementById('coverStyle').value;
            const description = document.getElementById('coverDescription').value;
            const title = document.getElementById('bookTitle').value || storyData.title || 'Untitled Book';
            
            if (!description.trim() && !title) {
                alert('Please enter a cover description or book title.');
                return;
            }
            
            showLoading('Creating HD book cover with DALL-E 3...');
            
            try {
                const coverUrl = await simulateEnhancedCoverGeneration(style, description, title);
                displayGeneratedCover(coverUrl);
                hideLoading();
                showStatusMessage('Professional book cover generated!');
            } catch (error) {
                console.error('Cover generation error:', error);
                alert('Failed to generate book cover. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedCoverGeneration(style, description, title) {
            // Simulate DALL-E 3 API call
            await new Promise(resolve => setTimeout(resolve, 4000));
            
            // Create a more realistic placeholder that reflects the inputs
            const encodedTitle = encodeURIComponent(title);
            const styleColors = {
                'modern': '78e3fe/000000',
                'classic': '8B4513/F5F5DC',
                'mysterious': '2F2F2F/FF6B6B',
                'romantic': 'FFB6C1/8B008B',
                'fantasy': '4B0082/FFD700',
                'scifi': '191970/00FFFF',
                'horror': '8B0000/000000',
                'children': 'FF69B4/FFFF00'
            };
            
            const colors = styleColors[style] || '78e3fe/000000';
            return `https://via.placeholder.com/400x600/${colors}?text=${encodedTitle}`;
        }
        
        function displayGeneratedCover(imageUrl) {
            const coverPreview = document.getElementById('coverPreview');
            const generatedCover = document.getElementById('generatedCover');
            
            generatedCover.src = imageUrl;
            generatedCover.alt = `Generated book cover for ${storyData.title || 'your book'}`;
            coverPreview.classList.remove('hidden');
        }
        
        async function regenerateCover() {
            showStatusMessage('Regenerating book cover...');
            generateCover();
        }
        
        function downloadCover() {
            const coverImage = document.getElementById('generatedCover');
            const link = document.createElement('a');
            link.href = coverImage.src;
            link.download = `${storyData.title || 'Book'}_Cover.png`;
            link.click();
            showStatusMessage('Book cover download initiated');
        }
        
        // Configuration Functions
        async function testApiConnection() {
            const apiKey = document.getElementById('openaiKey').value;
            
            if (!apiKey.trim()) {
                alert('Please enter your OpenAI API key.');
                return;
            }
            
            showLoading('Testing OpenAI API connection...');
            
            try {
                // Simulate API test
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Save API key
                localStorage.setItem('openaiApiKey', apiKey);
                
                hideLoading();
                showStatusMessage('API connection successful! Key saved.');
            } catch (error) {
                console.error('API test error:', error);
                alert('API connection failed. Please check your key and try again.');
                hideLoading();
            }
        }
        
        // Helper Functions
        function getAllChaptersText() {
            // Get all chapters from storyData
            if (storyData.chapters && storyData.chapters.length > 0) {
                return storyData.chapters.map((chapter, index) => {
                    const title = chapter.title || `Chapter ${index + 1}`;
                    const content = chapter.content || '';
                    return `=== ${title} ===\n\n${content}`;
                }).join('\n\n');
            }
            
            // Fallback to current editor content if no chapters exist
            const editor = document.getElementById('storyEditor');
            return editor ? editor.value : '';
        }
        
        function hasMultipleChapters() {
            return storyData.chapters && storyData.chapters.length > 1;
        }
        
        // Utility Functions
        function showLoading(text = 'Processing...', animationType = 'book') {
            document.getElementById('loadingText').textContent = text;
            
            const bookLoader = document.querySelector('.book-loader');
            const spinnerLoader = document.querySelector('.loading-spinner');
            
            if (animationType === 'book') {
                bookLoader.style.display = 'block';
                spinnerLoader.style.display = 'none';
            } else {
                bookLoader.style.display = 'none';
                spinnerLoader.style.display = 'block';
            }
            
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        // Initialize word count tracking and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const editor = document.getElementById('storyEditor');
                if (editor) {
                    // Real-time word count updates
                    editor.addEventListener('input', updateWordCount);
                    editor.addEventListener('keyup', updateWordCount);
                    editor.addEventListener('paste', () => setTimeout(updateWordCount, 10));
                    
                    // Initialize history with empty state
                    saveToHistory();
                    updateHistoryButtons();
                    
                    // Load any saved content
                    const savedContent = localStorage.getItem('authorr_story_content');
                    if (savedContent) {
                        editor.value = savedContent;
                        updateWordCount();
                        showStatusMessage('Previously saved content restored');
                    }
                }
                
                // Load saved story data
                const savedData = localStorage.getItem('authorr_story_data');
                if (savedData) {
                    try {
                        storyData = JSON.parse(savedData);
                        if (storyData.title) {
                            document.getElementById('bookTitle').value = storyData.title;
                        }
                    } catch (e) {
                        console.warn('Failed to load saved story data:', e);
                    }
                }
            }, 100);
        });

        // Real-time Word Count functionality
        function setupWordCount() {
            const storyOutline = document.getElementById('storyOutline');
            const wordCountDisplay = document.getElementById('outlineWordCount');
            
            if (storyOutline && wordCountDisplay) {
                storyOutline.addEventListener('input', function() {
                    const text = this.value.trim();
                    const wordCount = text === '' ? 0 : text.split(/\s+/).length;
                    wordCountDisplay.textContent = `${wordCount} words`;
                });
            }
        }

        // Voice Cloning Station Functions
        function handleVoiceDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            handleVoiceFiles(files);
        }
        
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function handleVoiceFiles(files) {
            const validTypes = ['audio/mp3', 'audio/wav', 'audio/m4a'];
            const validFiles = Array.from(files).filter(file => 
                validTypes.includes(file.type) || 
                validTypes.some(type => file.name.toLowerCase().endsWith(type.split('/')[1]))
            );
            
            if (validFiles.length > 0) {
                console.log('Voice files selected:', validFiles.map(f => f.name));
                showNotification(`${validFiles.length} voice sample(s) selected for cloning`, 'success');
            } else {
                showNotification('Please select valid audio files (.mp3, .wav, .m4a)', 'error');
            }
        }
        
        function initiateVoiceClone() {
            const uploadInput = document.getElementById('voiceUpload');
            const files = uploadInput.files;
            
            if (files.length === 0) {
                showNotification('Please select voice samples first', 'error');
                return;
            }
            
            // Show progress animation
            const progressDiv = document.getElementById('cloningProgress');
            const progressBar = document.getElementById('cloningBar');
            const progressPercent = document.getElementById('cloningPercent');
            
            progressDiv.classList.remove('hidden');
            
            // Simulate cloning progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        showNotification('Voice clone created successfully!', 'success');
                    }, 1000);
                }
            }, 500);
        }
        
        // Setup word count monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            const voiceUpload = document.getElementById('voiceUpload');
            if (voiceUpload) {
                voiceUpload.addEventListener('change', function() {
                    handleVoiceFiles(this.files);
                });
            }
            
            // Setup word count monitoring
            setupWordCount();
        });

        // Platform Template Functions
        const platformDimensions = {
            'audible': { width: 2400, height: 2400, name: 'Audible' },
            'spotify': { width: 3000, height: 3000, name: 'Spotify' },
            'apple': { width: 3000, height: 3000, name: 'Apple Podcasts' },
            'google': { width: 2400, height: 2400, name: 'Google Play' },
            'overdrive': { width: 1800, height: 2700, name: 'OverDrive' },
            'universal': { width: 2400, height: 2400, name: 'Universal' }
        };

        function selectPlatformTemplate(platform) {
            const platformSelect = document.getElementById('selectedPlatform');
            const dimensionDisplay = document.getElementById('dimensionDisplay');
            
            if (platformSelect) {
                platformSelect.value = platform;
            }
            
            const dimensions = platformDimensions[platform];
            if (dimensionDisplay && dimensions) {
                dimensionDisplay.textContent = `${dimensions.width}×${dimensions.height}px`;
            }
            
            // Visual feedback
            document.querySelectorAll('.platform-template').forEach(btn => {
                btn.classList.remove('border-cyan-400', 'bg-cyan-900');
            });
            
            const selectedBtn = document.querySelector(`[onclick="selectPlatformTemplate('${platform}')"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('border-cyan-400', 'bg-cyan-900');
            }
            
            showNotification(`Selected ${dimensions.name} template (${dimensions.width}×${dimensions.height}px)`, 'success');
        }

        // OpenAI DALL-E Cover Generation Functions
        async function generateAICover() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key in the Config section first', 'error');
                return;
            }

            const title = document.getElementById('coverTitle')?.value?.trim();
            const author = document.getElementById('coverAuthor')?.value?.trim();
            const subtitle = document.getElementById('coverSubtitle')?.value?.trim();
            const description = document.getElementById('coverDescription')?.value?.trim();
            const style = document.getElementById('coverStyle')?.value || 'modern';
            const artStyle = document.getElementById('artStyle')?.value || 'digital-art';
            const platform = document.getElementById('selectedPlatform')?.value || 'universal';
            const quality = document.getElementById('imageQuality')?.value || 'hd';

            if (!title) {
                showNotification('Please enter a book title', 'error');
                return;
            }

            if (!description) {
                showNotification('Please provide a visual description for the cover', 'error');
                return;
            }

            // Show progress
            const progressDiv = document.getElementById('coverGenerationProgress');
            const progressBar = document.getElementById('coverProgressBar');
            const stepText = document.getElementById('generationStep');
            const progressMessage = document.getElementById('progressMessage');
            
            progressDiv.classList.remove('hidden');
            
            const steps = [
                'Analyzing design requirements...',
                'Processing with DALL-E AI...',
                'Generating high-quality artwork...',
                'Optimizing for platform requirements...',
                'Finalizing cover design...'
            ];

            let currentStep = 0;
            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    stepText.textContent = steps[currentStep];
                    progressBar.style.width = `${(currentStep + 1) * 20}%`;
                    currentStep++;
                }
            }, 2000);

            // Build comprehensive prompt
            const platformInfo = platformDimensions[platform];
            const prompt = buildCoverPrompt(title, author, subtitle, description, style, artStyle, platformInfo);

            try {
                progressMessage.textContent = 'Connecting to OpenAI DALL-E API...';
                
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: quality === 'hd' ? '1792x1024' : '1024x1024',
                        quality: quality,
                        style: 'vivid'
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                clearInterval(stepInterval);
                progressBar.style.width = '100%';
                stepText.textContent = 'Cover generated successfully!';

                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    displayGeneratedCover(imageUrl, platform);
                }, 1500);

            } catch (error) {
                clearInterval(stepInterval);
                progressDiv.classList.add('hidden');
                console.error('Cover generation error:', error);
                showNotification(`Failed to generate cover: ${error.message}`, 'error');
            }
        }

        function buildCoverPrompt(title, author, subtitle, description, style, artStyle, platformInfo) {
            let prompt = `Create a professional book cover in ${artStyle} style with ${style} aesthetic. `;
            prompt += `The book title is "${title}" by ${author}. `;
            
            if (subtitle) {
                prompt += `Subtitle: "${subtitle}". `;
            }
            
            prompt += `Visual description: ${description}. `;
            prompt += `The cover should be optimized for ${platformInfo.name} (${platformInfo.width}x${platformInfo.height} pixels). `;
            prompt += `Include clear, readable typography for the title and author name. `;
            prompt += `The design should be eye-catching, professional, and genre-appropriate. `;
            prompt += `Ensure high contrast and readability at thumbnail sizes. `;
            prompt += `No explicit content, copyright violations, or text overlay issues.`;

            return prompt;
        }

        function displayGeneratedCover(imageUrl, platform) {
            const coverPreview = document.getElementById('coverPreview');
            const generatedCover = document.getElementById('generatedCover');
            const placeholderPreview = document.getElementById('placeholderPreview');
            const dimensionDisplay = document.getElementById('dimensionDisplay');
            
            generatedCover.src = imageUrl;
            
            const dimensions = platformDimensions[platform];
            if (dimensionDisplay && dimensions) {
                dimensionDisplay.textContent = `${dimensions.width}×${dimensions.height}px`;
            }
            
            placeholderPreview.classList.add('hidden');
            coverPreview.classList.remove('hidden');
            
            showNotification('AI book cover generated successfully!', 'success');
        }

        async function regenerateAICover() {
            showNotification('Regenerating cover with new AI variations...', 'info');
            setTimeout(() => {
                generateAICover();
            }, 500);
        }

        async function createVariations() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            const generatedCover = document.getElementById('generatedCover');
            if (!generatedCover.src) {
                showNotification('Please generate a cover first', 'error');
                return;
            }

            showNotification('Creating AI variations of your cover...', 'info');
            
            try {
                // Note: DALL-E 3 doesn't support variations, so we'll regenerate with slight prompt modifications
                const variations = [];
                const basePrompt = document.getElementById('coverDescription')?.value || '';
                
                const promptVariations = [
                    basePrompt + ' with warmer color palette',
                    basePrompt + ' with cooler tones',
                    basePrompt + ' with different composition'
                ];

                // Generate multiple variations (simplified for demo)
                for (let i = 0; i < 2; i++) {
                    // Simulate variation generation
                    setTimeout(() => {
                        addCoverVariation(generatedCover.src, i + 1);
                    }, (i + 1) * 1000);
                }
                
                document.getElementById('coverVariations').classList.remove('hidden');
                
            } catch (error) {
                console.error('Variation generation error:', error);
                showNotification('Failed to create variations', 'error');
            }
        }

        function addCoverVariation(imageUrl, index) {
            const variationsGrid = document.getElementById('variationsGrid');
            const variationDiv = document.createElement('div');
            variationDiv.className = 'cover-variation p-2 rounded-lg border border-theme cursor-pointer hover:border-cyan-400 transition-colors';
            variationDiv.innerHTML = `
                <img src="${imageUrl}" alt="Cover Variation ${index}" class="w-full rounded">
                <button onclick="selectVariation(this)" class="w-full mt-2 btn-secondary text-xs py-1">
                    Use This Version
                </button>
            `;
            variationsGrid.appendChild(variationDiv);
        }

        function selectVariation(button) {
            const img = button.parentElement.querySelector('img');
            const mainCover = document.getElementById('generatedCover');
            mainCover.src = img.src;
            showNotification('Cover variation selected!', 'success');
        }

        function downloadCover() {
            const coverImg = document.getElementById('generatedCover');
            if (!coverImg.src) {
                showNotification('No cover to download', 'error');
                return;
            }

            const platform = document.getElementById('selectedPlatform')?.value || 'universal';
            const title = document.getElementById('coverTitle')?.value || 'book-cover';
            
            downloadImage(coverImg.src, `${title}-${platform}-cover.png`);
            showNotification('Cover downloaded successfully!', 'success');
        }

        function downloadForPlatform(type) {
            const coverImg = document.getElementById('generatedCover');
            if (!coverImg.src) {
                showNotification('No cover to download', 'error');
                return;
            }

            const title = document.getElementById('coverTitle')?.value || 'book-cover';
            const filename = type === 'print' ? 
                `${title}-print-ready.png` : 
                `${title}-web-optimized.png`;
            
            downloadImage(coverImg.src, filename);
            showNotification(`${type === 'print' ? 'Print-ready' : 'Web-optimized'} cover downloaded!`, 'success');
        }

        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setCoverAsMain() {
            const coverImg = document.getElementById('generatedCover');
            if (coverImg.src) {
                // Store the cover URL for use in other parts of the app
                localStorage.setItem('mainBookCover', coverImg.src);
                showNotification('Cover set as main book cover!', 'success');
            }
        }

        // Helper function to get OpenAI API key
        function getOpenAIApiKey() {
            const storedKey = localStorage.getItem('openaiApiKey');
            if (!storedKey || storedKey.startsWith('••••')) {
                return null;
            }
            return storedKey;
        }

        // OpenAI GPT-4 Writing Assistance Functions
        async function generateChapterPlan() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key in Config section first', 'error');
                return;
            }

            const title = document.getElementById('bookTitle')?.value?.trim();
            const outline = document.getElementById('storyOutline')?.value?.trim();
            const genre = document.getElementById('genre')?.value || 'fiction-literary';
            const tone = document.getElementById('tone')?.value || 'professional';
            const chapterCount = parseInt(document.getElementById('chapterCount')?.value || 10);
            const wordsPerChapter = parseInt(document.getElementById('wordsPerChapter')?.value || 1000);

            if (!title || !outline) {
                showNotification('Please fill in the book title and story outline', 'error');
                return;
            }

            showNotification('Generating AI chapter plan...', 'info');
            
            const prompt = `Create a detailed chapter plan for a ${genre} book titled "${title}".

Story Outline: ${outline}
Tone: ${tone}
Number of chapters: ${chapterCount}
Target words per chapter: ${wordsPerChapter}

Generate a comprehensive chapter plan with:
1. Chapter titles
2. Brief chapter summaries (2-3 sentences each)
3. Key plot points and character development
4. Pacing and story arc progression

IMPORTANT: Respond with ONLY valid JSON, no markdown formatting or explanations.

JSON Structure:
{
  "chapters": [
    {
      "number": 1,
      "title": "Chapter Title",
      "summary": "Chapter summary...",
      "keyPoints": ["Point 1", "Point 2"],
      "wordCount": ${wordsPerChapter}
    }
  ]
}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content: "You are a professional book planning assistant. Create detailed, engaging chapter plans that follow proper story structure and pacing. Always respond with valid JSON only, no markdown formatting or code blocks."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices[0].message.content;
                
                // Clean the response - remove markdown formatting
                content = content.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
                
                // Additional cleaning for common AI response issues
                content = content.replace(/^Here's.*?:/gi, '').trim();
                content = content.replace(/^Based on.*?:/gi, '').trim();
                
                let chapterPlan;
                try {
                    chapterPlan = JSON.parse(content);
                } catch (parseError) {
                    console.error('JSON parsing failed, raw content:', content);
                    throw new Error('Invalid JSON response from AI. Please try again.');
                }
                
                displayChapterPlan(chapterPlan);
                showNotification('Chapter plan generated successfully!', 'success');
                
            } catch (error) {
                console.error('Chapter generation error:', error);
                showNotification(`Failed to generate chapters: ${error.message}`, 'error');
            }
        }

        function displayChapterPlan(chapterPlan) {
            const chaptersContainer = document.getElementById('chapterPlan');
            if (!chaptersContainer) {
                console.error('Chapter plan container not found');
                return;
            }

            chaptersContainer.innerHTML = '';
            storyData.chapters = chapterPlan.chapters;

            chapterPlan.chapters.forEach(chapter => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-card bg-theme-primary p-4 rounded-lg border border-theme';
                chapterDiv.id = `chapter-${chapter.number}`;
                chapterDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg editable-title" contenteditable="true" data-chapter="${chapter.number}">${chapter.number}. ${chapter.title}</h3>
                        <span class="text-xs text-theme-secondary">${chapter.wordCount} words</span>
                    </div>
                    <p class="text-sm text-theme-secondary mb-2 editable-summary" contenteditable="true" data-chapter="${chapter.number}">${chapter.summary}</p>
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${chapter.keyPoints.map(point => 
                            `<span class="text-xs bg-cyan-900 text-cyan-300 px-2 py-1 rounded">${point}</span>`
                        ).join('')}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="generateChapterContent(${chapter.number})" class="btn-primary text-xs px-3 py-1 rounded">
                            <i class="fas fa-sync mr-1"></i>Regenerate Chapter
                        </button>
                        <button onclick="editChapter(${chapter.number})" class="btn-secondary text-xs px-3 py-1 rounded">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                    </div>
                `;
                chaptersContainer.appendChild(chapterDiv);
            });
            
            // Enable the Generate All Chapters and Combine All buttons
            const generateAllBtn = document.getElementById('generateAllBtn');
            if (generateAllBtn) {
                generateAllBtn.disabled = false;
                generateAllBtn.classList.remove('opacity-50');
            }
            
            const combineAllBtn = document.getElementById('combineAllBtn');
            if (combineAllBtn) {
                combineAllBtn.disabled = false;
                combineAllBtn.classList.remove('opacity-50');
            }
        }

        // OpenAI TTS (Text-to-Speech) Functions
        async function generateFullNarration() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            if (!storyData.chapters || storyData.chapters.length === 0) {
                showNotification('Please generate chapter content first', 'error');
                return;
            }

            const voice = document.getElementById('voiceSelection')?.value || 'alloy';
            const speed = parseFloat(document.getElementById('speechRate')?.value || 1.0);
            
            showNotification('Starting AI narration generation...', 'info');
            
            const progressDiv = document.getElementById('narrationProgress');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            progressDiv.classList.remove('hidden');
            
            try {
                const audioFiles = [];
                
                for (let i = 0; i < storyData.chapters.length; i++) {
                    const chapter = storyData.chapters[i];
                    
                    progressPercent.textContent = `${Math.round((i / storyData.chapters.length) * 100)}%`;
                    progressBar.style.width = `${(i / storyData.chapters.length) * 100}%`;
                    
                    if (chapter.content) {
                        const audioBlob = await generateChapterAudio(chapter.content, voice, speed, apiKey);
                        audioFiles.push({
                            chapter: i + 1,
                            title: chapter.title,
                            audioBlob: audioBlob,
                            url: URL.createObjectURL(audioBlob)
                        });
                        
                        displayAudioResult(audioFiles[audioFiles.length - 1]);
                    }
                }
                
                progressPercent.textContent = '100%';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    showNotification('All chapters narrated successfully!', 'success');
                }, 1000);
                
            } catch (error) {
                progressDiv.classList.add('hidden');
                console.error('Narration error:', error);
                showNotification(`Narration failed: ${error.message}`, 'error');
            }
        }

        async function generateChapterAudio(text, voice, speed, apiKey) {
            const response = await fetch('https://api.openai.com/v1/audio/speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "tts-1-hd",
                    input: text,
                    voice: voice,
                    speed: speed
                })
            });

            if (!response.ok) {
                throw new Error(`TTS API Error: ${response.status}`);
            }

            return await response.blob();
        }

        function displayAudioResult(audioData) {
            const resultsContainer = document.getElementById('audioResults');
            const audioDiv = document.createElement('div');
            audioDiv.className = 'audio-result bg-theme-primary p-4 rounded-lg border border-theme';
            audioDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold">Chapter ${audioData.chapter}: ${audioData.title}</h4>
                    <span class="text-xs text-theme-secondary">Generated</span>
                </div>
                <audio controls class="w-full mb-2">
                    <source src="${audioData.url}" type="audio/mpeg">
                </audio>
                <div class="flex space-x-2">
                    <button onclick="downloadAudio('${audioData.url}', 'chapter-${audioData.chapter}')" class="btn-secondary text-xs px-3 py-1 rounded">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                    <button onclick="regenerateChapterAudio(${audioData.chapter})" class="btn-secondary text-xs px-3 py-1 rounded">
                        <i class="fas fa-sync mr-1"></i>Regenerate
                    </button>
                </div>
            `;
            resultsContainer.appendChild(audioDiv);
        }

        function downloadAudio(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.mp3`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enhanced Chapter Content Generation
        async function generateChapterContent(chapterNumber) {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            const chapter = storyData.chapters.find(c => c.number === chapterNumber);
            if (!chapter) return;

            showNotification(`Generating content for Chapter ${chapterNumber}...`, 'info');

            const prompt = `Write the full content for this chapter of the book "${storyData.title}".

Chapter ${chapter.number}: ${chapter.title}
Summary: ${chapter.summary}
Key Points: ${chapter.keyPoints.join(', ')}
Target Word Count: ${chapter.wordCount}
Genre: ${document.getElementById('genre')?.value}
Tone: ${document.getElementById('tone')?.value}

Write engaging, well-structured prose that:
1. Follows the chapter summary and incorporates all key points
2. Maintains consistent tone and style
3. Includes dialogue, descriptions, and narrative flow
4. Meets the target word count
5. Ends with a natural transition to the next chapter

Format as clean, readable text ready for narration.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system", 
                                content: "You are a professional author and storyteller. Write compelling, well-crafted chapter content that engages readers and flows naturally."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status}`);
                }

                const data = await response.json();
                chapter.content = data.choices[0].message.content;
                
                updateChapterDisplay(chapterNumber);
                showNotification(`Chapter ${chapterNumber} content generated!`, 'success');
                
            } catch (error) {
                console.error('Content generation error:', error);
                showNotification(`Failed to generate content: ${error.message}`, 'error');
            }
        }

        function updateChapterDisplay(chapterNumber) {
            const chapterCards = document.querySelectorAll('.chapter-card');
            const targetCard = chapterCards[chapterNumber - 1];
            
            if (targetCard) {
                const generateBtn = targetCard.querySelector('button');
                generateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Content Ready';
                generateBtn.classList.remove('btn-primary');
                generateBtn.classList.add('btn-success');
                generateBtn.disabled = true;
            }
        }

        // Config Page Functions
        function saveSettings() {
            const apiKey = document.getElementById('openaiKey')?.value?.trim();
            const elevenlabsKey = document.getElementById('elevenlabsKey')?.value?.trim();
            const model = document.getElementById('modelSelection')?.value;
            const autoSave = document.getElementById('autoSave')?.checked;
            
            if (apiKey) {
                localStorage.setItem('openaiApiKey', apiKey);
            }
            if (elevenlabsKey) {
                localStorage.setItem('elevenlabsApiKey', elevenlabsKey);
            }
            if (model) {
                localStorage.setItem('selectedModel', model);
            }
            localStorage.setItem('autoSave', autoSave);
            
            showNotification('Settings saved successfully!', 'success');
            
            // Mask the API keys display for security
            const keyInput = document.getElementById('openaiKey');
            if (keyInput && apiKey) {
                keyInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + apiKey.slice(-4);
            }
            
            const elevenlabsInput = document.getElementById('elevenlabsKey');
            if (elevenlabsInput && elevenlabsKey) {
                elevenlabsInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + elevenlabsKey.slice(-4);
            }
        }

        function loadSettings() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const elevenlabsKey = localStorage.getItem('elevenlabsApiKey');
            const model = localStorage.getItem('selectedModel');
            const autoSave = localStorage.getItem('autoSave');
            
            if (apiKey) {
                const keyInput = document.getElementById('openaiKey');
                if (keyInput) {
                    keyInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + apiKey.slice(-4);
                }
            }
            
            if (elevenlabsKey) {
                const elevenlabsInput = document.getElementById('elevenlabsKey');
                if (elevenlabsInput) {
                    elevenlabsInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + elevenlabsKey.slice(-4);
                }
            }
            
            if (model) {
                const modelSelect = document.getElementById('modelSelection');
                if (modelSelect) {
                    modelSelect.value = model;
                }
            }
            
            if (autoSave !== null) {
                const autoSaveCheckbox = document.getElementById('autoSave');
                if (autoSaveCheckbox) {
                    autoSaveCheckbox.checked = autoSave === 'true';
                }
            }
        }

        async function testApiConnection() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please enter your OpenAI API key first', 'error');
                return;
            }

            showNotification('Testing API connection...', 'info');

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('✅ API connection successful!', 'success');
                } else {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                showNotification(`❌ API connection failed: ${error.message}`, 'error');
            }
        }

        // Text Drag & Drop Functions
        function handleTextDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            const text = event.dataTransfer.getData('text/plain');
            
            if (files.length > 0) {
                // Handle file drop
                const file = files[0];
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const textArea = document.getElementById('cloneTextInput');
                        if (textArea) {
                            textArea.value = e.target.result;
                            updateCharCount();
                        }
                        showNotification(`Text file "${file.name}" loaded successfully!`, 'success');
                    };
                    reader.readAsText(file);
                } else {
                    showNotification('Please drop a .txt file', 'error');
                }
            } else if (text) {
                // Handle text drop
                const textArea = document.getElementById('cloneTextInput');
                if (textArea) {
                    textArea.value = text;
                    updateCharCount();
                }
                showNotification('Text added successfully!', 'success');
            }
        }

        function updateCharCount() {
            const textArea = document.getElementById('cloneTextInput');
            const charCount = document.getElementById('textCharCount');
            
            if (textArea && charCount) {
                const text = textArea.value;
                charCount.textContent = `${text.length} characters`;
            }
        }

        async function previewCloneText() {
            const text = document.getElementById('cloneTextInput')?.value?.trim();
            if (!text) {
                showNotification('Please enter some text to preview', 'error');
                return;
            }

            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            showNotification('Generating voice preview...', 'info');

            try {
                const voice = document.getElementById('voiceSelection')?.value || 'alloy';
                const speed = parseFloat(document.getElementById('speechRate')?.value || 1.0);
                
                const audioBlob = await generateChapterAudio(text, voice, speed, apiKey);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Play the preview
                const audio = new Audio(audioUrl);
                audio.play();
                
                showNotification('Voice preview generated successfully!', 'success');
            } catch (error) {
                showNotification(`Preview failed: ${error.message}`, 'error');
            }
        }

        // Voice Preview Functions
        async function previewSelectedVoice() {
            const voiceSelect = document.getElementById('voiceSelection');
            const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
            
            if (!selectedOption) {
                showNotification('Please select a voice first', 'error');
                return;
            }

            const provider = selectedOption.dataset.provider;
            const voiceId = selectedOption.dataset.voice;
            const voiceName = selectedOption.textContent;
            
            const previewText = `Hello, this is a preview of the ${voiceName} voice. This voice will be used to narrate your audiobook with professional quality and clarity.`;

            showNotification(`Generating ${voiceName} voice preview...`, 'info');

            try {
                let audioBlob;
                
                if (provider === 'openai') {
                    const apiKey = getOpenAIApiKey();
                    if (!apiKey) {
                        showNotification('Please configure your OpenAI API key first', 'error');
                        return;
                    }
                    audioBlob = await generateChapterAudio(previewText, voiceId, 1.0, apiKey);
                } else if (provider === 'elevenlabs') {
                    const apiKey = getElevenLabsApiKey();
                    if (!apiKey) {
                        showNotification('Please configure your ElevenLabs API key first', 'error');
                        return;
                    }
                    audioBlob = await generateElevenLabsAudio(previewText, voiceId, apiKey);
                } else {
                    showNotification('Unknown voice provider', 'error');
                    return;
                }

                const audioUrl = URL.createObjectURL(audioBlob);
                
                const previewPlayer = document.getElementById('voicePreviewPlayer');
                const audioSource = document.getElementById('voicePreviewSource');
                
                audioSource.src = audioUrl;
                previewPlayer.classList.remove('hidden');
                
                // Auto-play the preview
                const audioElement = previewPlayer.querySelector('audio');
                audioElement.load();
                audioElement.play();
                
                showNotification(`${voiceName} voice preview ready!`, 'success');
            } catch (error) {
                showNotification(`Voice preview failed: ${error.message}`, 'error');
            }
        }

        // Recording Functions
        let mediaRecorder;
        let recordedChunks = [];

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const recordedAudio = document.getElementById('recordedAudio');
                    const audioSource = document.getElementById('recordedAudioSource');
                    
                    audioSource.src = audioUrl;
                    recordedAudio.classList.remove('hidden');
                    
                    // Stop all tracks to release the microphone
                    stream.getTracks().forEach(track => track.stop());
                    
                    showNotification('Recording saved successfully!', 'success');
                };

                mediaRecorder.start();
                
                // Update UI
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.remove('hidden');
                document.getElementById('recordingWave').classList.remove('hidden');
                
                showNotification('Recording started...', 'info');
                
            } catch (error) {
                showNotification(`Recording failed: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
                // Update UI
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingIndicator').classList.add('hidden');
                document.getElementById('recordingWave').classList.add('hidden');
            }
        }

        // Enhanced getOpenAIApiKey function
        function getOpenAIApiKey() {
            const storedKey = localStorage.getItem('openaiApiKey');
            if (storedKey && storedKey.startsWith('••••')) {
                // If the key is masked, we need the user to re-enter it
                showNotification('Please re-enter your API key in the Config section', 'error');
                return null;
            }
            return storedKey;
        }

        // ElevenLabs API key function
        function getElevenLabsApiKey() {
            const storedKey = localStorage.getItem('elevenlabsApiKey');
            if (storedKey && storedKey.startsWith('••••')) {
                // If the key is masked, we need the user to re-enter it
                return null;
            }
            return storedKey;
        }

        // ============ ELEVENLABS API INTEGRATION ============

        async function fetchElevenLabsVoices() {
            const apiKey = getElevenLabsApiKey();
            if (!apiKey) {
                return [];
            }

            try {
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    method: 'GET',
                    headers: {
                        'xi-api-key': apiKey,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('ElevenLabs API error:', response.status);
                    return [];
                }

                const data = await response.json();
                return data.voices || [];
            } catch (error) {
                console.error('Failed to fetch ElevenLabs voices:', error);
                return [];
            }
        }

        async function generateElevenLabsAudio(text, voiceId, apiKey) {
            const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                method: 'POST',
                headers: {
                    'xi-api-key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    model_id: "eleven_monolingual_v1",
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.75
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`ElevenLabs API Error: ${response.status}`);
            }

            return await response.blob();
        }

        async function populateVoiceOptions() {
            const voiceSelect = document.getElementById('voiceSelection');
            if (!voiceSelect) return;

            // Clear existing options
            voiceSelect.innerHTML = '';

            // Add OpenAI voices
            const openaiVoices = [
                { id: 'openai_alloy', name: 'Alloy - Balanced, Clear', provider: 'openai', voice: 'alloy' },
                { id: 'openai_echo', name: 'Echo - Male, Authoritative', provider: 'openai', voice: 'echo' },
                { id: 'openai_fable', name: 'Fable - Warm, Storytelling', provider: 'openai', voice: 'fable' },
                { id: 'openai_onyx', name: 'Onyx - Deep, Professional', provider: 'openai', voice: 'onyx' },
                { id: 'openai_nova', name: 'Nova - Female, Engaging', provider: 'openai', voice: 'nova' },
                { id: 'openai_shimmer', name: 'Shimmer - Soft, Gentle', provider: 'openai', voice: 'shimmer' }
            ];

            // Add OpenAI section header
            const openaiOptgroup = document.createElement('optgroup');
            openaiOptgroup.label = '🤖 OpenAI Voices';
            voiceSelect.appendChild(openaiOptgroup);

            openaiVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = voice.name;
                option.dataset.provider = voice.provider;
                option.dataset.voice = voice.voice;
                openaiOptgroup.appendChild(option);
            });

            // Add ElevenLabs voices if API key is available
            const elevenlabsVoices = await fetchElevenLabsVoices();
            if (elevenlabsVoices.length > 0) {
                const elevenlabsOptgroup = document.createElement('optgroup');
                elevenlabsOptgroup.label = '🎭 ElevenLabs Voices';
                voiceSelect.appendChild(elevenlabsOptgroup);

                elevenlabsVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = `elevenlabs_${voice.voice_id}`;
                    option.textContent = `${voice.name} - ${voice.labels?.accent || 'Professional'}`;
                    option.dataset.provider = 'elevenlabs';
                    option.dataset.voice = voice.voice_id;
                    elevenlabsOptgroup.appendChild(option);
                });
            }

            // Select first OpenAI voice by default
            if (voiceSelect.options.length > 0) {
                voiceSelect.selectedIndex = 0;
            }
        }

        // ============ DIALOGUE-SPECIFIC VOICE ASSIGNMENT ============

        let dialogueData = {
            characters: [],
            dialogueSections: [],
            voiceAssignments: {}
        };

        // Content status functions
        function refreshContentStatus() {
            updateContentStatus();
        }
        
        function updateContentStatus() {
            const statusIcon = document.getElementById('contentStatusIcon');
            const statusText = document.getElementById('contentStatusText');
            const previewToggle = document.getElementById('contentPreviewToggle');
            
            // Get content from multiple sources
            const editorContent = document.getElementById('storyEditor')?.value || '';
            const currentContent = storyData.currentContent || '';
            const combinedContent = storyData.combinedContent || '';
            
            // Determine which content to use (priority: combined > current > editor)
            let content = combinedContent || currentContent || editorContent;
            const contentSource = combinedContent ? 'Combined Chapters' : 
                                 currentContent ? 'Current Story' : 
                                 editorContent ? 'Story Editor' : 'None';
            
            if (!content.trim()) {
                statusIcon.className = 'w-3 h-3 rounded-full bg-red-400';
                statusText.textContent = 'No story content found. Please create or combine chapters first.';
                previewToggle.classList.add('hidden');
                return;
            }
            
            const wordCount = content.trim().split(/\s+/).length;
            const charCount = content.length;
            const hasDialogue = content.includes('"') || content.match(/^[A-Z][a-z]*:/m);
            
            statusIcon.className = 'w-3 h-3 rounded-full bg-green-400';
            statusText.innerHTML = `
                <div><strong>Source:</strong> ${contentSource}</div>
                <div><strong>Length:</strong> ${wordCount} words, ${charCount} characters</div>
                <div><strong>Dialogue:</strong> ${hasDialogue ? '✅ Detected' : '❌ None found'}</div>
            `;
            previewToggle.classList.remove('hidden');
            
            // Store the content for dialogue scanning
            storyData.currentContent = content;
        }
        
        function toggleContentPreview() {
            const preview = document.getElementById('contentPreview');
            const previewText = document.getElementById('contentPreviewText');
            
            if (preview.classList.contains('hidden')) {
                const content = storyData.currentContent || '';
                if (content) {
                    // Show first 1000 characters
                    const truncated = content.length > 1000 ? content.substring(0, 1000) + '\n\n... [Content truncated. Full content will be used for dialogue scanning.]' : content;
                    previewText.textContent = truncated;
                    preview.classList.remove('hidden');
                }
            } else {
                preview.classList.add('hidden');
            }
        }

        async function scanForDialogue() {
            // First update content status
            updateContentStatus();
            
            const content = storyData.currentContent || document.getElementById('storyEditor')?.value || '';
            
            if (!content.trim()) {
                showNotification('No story content found. Please create a story first.', 'warning');
                return;
            }

            showLoading('Scanning story for dialogue and characters...');
            
            // Add detailed debug information
            console.log('=== DIALOGUE SCANNING DEBUG ===');
            console.log('Content length:', content.length);
            console.log('First 500 characters:', content.substring(0, 500));
            console.log('Has quotes:', content.includes('"'));
            console.log('Has colons:', content.includes(':'));

            try {
                let characters = new Set();
                let dialogueSections = [];
                
                // Split into lines for processing
                const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                console.log('Total lines to process:', lines.length);
                
                // Enhanced dialogue detection patterns
                const patterns = {
                    // Character: "Dialogue"
                    characterColon: /^([A-Z][a-zA-Z\s]+?):\s*["""]([^"""]+?)["""](.*)$/,
                    // [Character]: "Dialogue"  
                    characterBracket: /^\[([^\]]+)\]:\s*["""]([^"""]+?)["""](.*)$/,
                    // CAPS: "Dialogue"
                    characterCaps: /^([A-Z][A-Z\s]{1,20}):\s*["""]([^"""]+?)["""](.*)$/,
                    // "Dialogue" (standalone)
                    standaloneQuote: /^["""]([^"""]+?)["""](.*)$/,
                    // Text with "dialogue" in middle
                    embeddedQuote: /^(.*?)["""]([^"""]+?)["""](.*)$/
                };
                
                let lineNumber = 0;
                for (const line of lines) {
                    lineNumber++;
                    
                    // Try each pattern
                    for (const [patternName, pattern] of Object.entries(patterns)) {
                        const match = line.match(pattern);
                        if (match) {
                            console.log(`Line ${lineNumber} matched ${patternName}:`, match);
                            
                            let character, dialogueText, beforeText, afterText;
                            
                            switch(patternName) {
                                case 'characterColon':
                                case 'characterBracket':
                                case 'characterCaps':
                                    character = match[1].trim();
                                    dialogueText = match[2].trim();
                                    afterText = match[3] ? match[3].trim() : '';
                                    break;
                                    
                                case 'standaloneQuote':
                                    character = 'Unknown Speaker';
                                    dialogueText = match[1].trim();
                                    afterText = match[2] ? match[2].trim() : '';
                                    break;
                                    
                                case 'embeddedQuote':
                                    character = 'Unknown Speaker';
                                    dialogueText = match[2].trim();
                                    beforeText = match[1] ? match[1].trim() : '';
                                    afterText = match[3] ? match[3].trim() : '';
                                    break;
                            }
                            
                            if (dialogueText && dialogueText.length > 0) {
                                characters.add(character);
                                
                                dialogueSections.push({
                                    character: character,
                                    text: dialogueText,
                                    line: lineNumber,
                                    type: character === 'Unknown Speaker' ? 'untagged' : 'character_tagged',
                                    beforeText: beforeText || '',
                                    afterText: afterText || '',
                                    fullLine: line,
                                    startIndex: content.indexOf(line),
                                    endIndex: content.indexOf(line) + line.length
                                });
                                
                                console.log(`Added dialogue: ${character} -> "${dialogueText}"`);
                            }
                            break; // Found a match, stop trying other patterns for this line
                        }
                    }
                }
                
                console.log('Characters found:', Array.from(characters));
                console.log('Dialogue sections found:', dialogueSections.length);
                
                // If no characters found, try AI detection
                if (characters.size === 0 && dialogueSections.length === 0) {
                    console.log('No dialogue detected, trying AI character detection...');
                    try {
                        const aiCharacters = await detectCharacters(content);
                        console.log('AI detected characters:', aiCharacters);
                        aiCharacters.forEach(char => {
                            if (char && char.trim()) {
                                characters.add(char.trim());
                            }
                        });
                    } catch (aiError) {
                        console.log('AI character detection failed:', aiError);
                    }
                }
                
                // Store results
                dialogueData.characters = Array.from(characters);
                dialogueData.dialogueSections = dialogueSections;
                
                console.log('Final results:');
                console.log('- Characters:', dialogueData.characters);
                console.log('- Dialogue sections:', dialogueData.dialogueSections.length);
                
                hideLoading();
                
                if (dialogueData.characters.length === 0 && dialogueSections.length === 0) {
                    showNotification(`No dialogue found. Content analysis:\n- Lines processed: ${lines.length}\n- Contains quotes: ${content.includes('"') || content.includes('"')}\n- Contains colons: ${content.includes(':')}`, 'warning');
                    
                    // Show debug dialog
                    showDialogueDebugModal(content, lines);
                    return;
                }
                
                displayDialogueResults();
                showNotification(`✅ Scan complete! Found ${dialogueData.characters.length} characters and ${dialogueSections.length} dialogue sections`, 'success');

            } catch (error) {
                console.error('Dialogue scanning error:', error);
                hideLoading();
                showNotification(`Failed to scan dialogue: ${error.message}`, 'error');
            }
        }
        
        function showDialogueDebugModal(content, lines) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-theme-secondary rounded-xl max-w-4xl max-h-[80vh] w-full flex flex-col border-2 border-theme">
                    <div class="flex items-center justify-between p-6 border-b border-theme">
                        <h3 class="text-xl font-bold text-yellow-400">
                            <i class="fas fa-bug mr-2"></i>Dialogue Scanning Debug
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-theme-secondary hover:text-theme-primary">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="space-y-4">
                            <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                                <h4 class="font-medium text-cyan-400 mb-2">Content Statistics:</h4>
                                <div class="text-sm text-theme-secondary space-y-1">
                                    <div>Total length: ${content.length} characters</div>
                                    <div>Total lines: ${lines.length}</div>
                                    <div>Contains quotes (""): ${content.includes('"') ? 'Yes' : 'No'}</div>
                                    <div>Contains smart quotes (""): ${content.includes('"') || content.includes('"') ? 'Yes' : 'No'}</div>
                                    <div>Contains colons (:): ${content.includes(':') ? 'Yes' : 'No'}</div>
                                </div>
                            </div>
                            <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                                <h4 class="font-medium text-cyan-400 mb-2">Content Preview (First 10 lines):</h4>
                                <pre class="text-xs text-theme-secondary whitespace-pre-wrap bg-theme-secondary p-2 rounded">${lines.slice(0, 10).join('\n')}</pre>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t border-theme">
                        <div class="text-sm text-theme-secondary mb-3">
                            <strong>Expected dialogue formats:</strong><br>
                            • Character: "Hello there!"<br>
                            • [John]: "How are you?"<br>
                            • MARY: "I'm fine, thanks!"<br>
                            • "Standalone dialogue"
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="btn-primary px-6 py-2 rounded-lg w-full">
                            Close Debug Info
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function detectCharacters(content) {
            try {
                const analysis = await callOpenAI([
                    {
                        role: "system",
                        content: "You are a literary analysis expert. Identify all character names mentioned in the given text. Return only the names as a JSON array, like [\"John\", \"Mary\", \"Dr. Smith\"]. Focus on main speaking characters."
                    },
                    {
                        role: "user",
                        content: `Analyze this text and identify all character names:\n\n${content.substring(0, 2000)}`
                    }
                ]);

                const characters = JSON.parse(analysis);
                return Array.isArray(characters) ? characters : [];
            } catch (error) {
                console.error('Character detection error:', error);
                return ['Character 1', 'Character 2']; // Fallback
            }
        }

        function displayDialogueResults() {
            const dialogueAssignments = document.getElementById('dialogueAssignments');
            const dialoguePreview = document.getElementById('dialoguePreview');
            const characterVoiceList = document.getElementById('characterVoiceList');
            const dialogueList = document.getElementById('dialogueList');

            // Show the sections
            dialogueAssignments.classList.remove('hidden');
            dialoguePreview.classList.remove('hidden');

            // Clear previous results
            characterVoiceList.innerHTML = '';
            dialogueList.innerHTML = '';

            // Populate character voice assignments
            dialogueData.characters.forEach((character, index) => {
                const characterDiv = document.createElement('div');
                characterDiv.className = 'flex items-center justify-between p-3 bg-theme-secondary rounded border border-theme';
                // Get character's dialogue samples
                const characterDialogue = dialogueData.dialogueSections.filter(d => d.character === character);
                const sampleText = characterDialogue.length > 0 ? characterDialogue[0].text.substring(0, 80) + (characterDialogue[0].text.length > 80 ? '...' : '') : 'No dialogue found';
                
                characterDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${character.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <span class="font-medium text-cyan-400">${character}</span>
                                <div class="text-xs text-theme-secondary">${characterDialogue.length} dialogue section(s)</div>
                            </div>
                        </div>
                        <div class="text-xs text-theme-secondary mb-2 italic">
                            Sample: "${sampleText}"
                        </div>
                        <div class="flex items-center space-x-2">
                            <select id="voice_${index}" class="flex-1 px-3 py-2 rounded bg-theme-primary border border-theme text-sm" onchange="updateVoiceAssignment('${character}', this.value)">
                                <option value="">Select voice...</option>
                            </select>
                            <button onclick="previewCharacterVoice('${character}', 'voice_${index}')" class="px-3 py-2 bg-cyan-600 hover:bg-cyan-500 rounded text-white text-xs">
                                <i class="fas fa-play"></i> Preview
                            </button>
                        </div>
                    </div>
                `;
                characterVoiceList.appendChild(characterDiv);

                // Populate voice options for this character
                setTimeout(() => {
                    populateCharacterVoiceOptions(`voice_${index}`);
                }, 100);
            });

            // Add narrator voice assignment
            const narratorDiv = document.createElement('div');
            narratorDiv.className = 'flex items-center justify-between p-3 bg-theme-secondary rounded border border-theme';
            // Get narrator text sample
            const content = storyData.currentContent || document.getElementById('storyEditor')?.value || '';
            const narratorSample = content.replace(/"[^"]*"/g, '').trim().substring(0, 100) + (content.length > 100 ? '...' : '');
            
            narratorDiv.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            N
                        </div>
                        <div class="flex-1">
                            <span class="font-medium text-orange-400">Narrator</span>
                            <div class="text-xs text-theme-secondary">For all narrative text</div>
                        </div>
                    </div>
                    <div class="text-xs text-theme-secondary mb-2 italic">
                        Sample: "${narratorSample}"
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="voice_narrator" class="flex-1 px-3 py-2 rounded bg-theme-primary border border-theme text-sm" onchange="updateVoiceAssignment('Narrator', this.value)">
                            <option value="">Select voice...</option>
                        </select>
                        <button onclick="previewCharacterVoice('Narrator', 'voice_narrator')" class="px-3 py-2 bg-orange-600 hover:bg-orange-500 rounded text-white text-xs">
                            <i class="fas fa-play"></i> Preview
                        </button>
                    </div>
                </div>
            `;
            characterVoiceList.appendChild(narratorDiv);
            
            setTimeout(() => {
                populateCharacterVoiceOptions('voice_narrator');
            }, 100);

            // Populate dialogue preview
            dialogueData.dialogueSections.slice(0, 10).forEach((dialogue, index) => {
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'p-2 bg-theme-secondary rounded text-sm border-l-4 border-cyan-500';
                dialogueDiv.innerHTML = `
                    <div class="font-medium text-cyan-400">${dialogue.character} (Line ${dialogue.line}):</div>
                    <div class="text-theme-primary mt-1">"${dialogue.text}"</div>
                    ${dialogue.type === 'untagged' ? '<div class="text-xs text-yellow-400 mt-1">⚠ Untagged dialogue - may need manual assignment</div>' : ''}
                `;
                dialogueList.appendChild(dialogueDiv);
            });

            if (dialogueData.dialogueSections.length > 10) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'text-center text-sm text-theme-secondary';
                moreDiv.textContent = `... and ${dialogueData.dialogueSections.length - 10} more dialogue sections`;
                dialogueList.appendChild(moreDiv);
            }

            // Enable multi-voice button
            document.getElementById('multiVoiceBtn').disabled = false;
        }

        function populateCharacterVoiceOptions(selectId) {
            const select = document.getElementById(selectId);
            const mainVoiceSelect = document.getElementById('voiceSelection');
            
            if (!select || !mainVoiceSelect) return;

            // Copy options from main voice selector
            select.innerHTML = '<option value="">Select voice...</option>';
            
            Array.from(mainVoiceSelect.children).forEach(child => {
                if (child.tagName === 'OPTGROUP') {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = child.label;
                    Array.from(child.children).forEach(option => {
                        const newOption = document.createElement('option');
                        newOption.value = option.value;
                        newOption.textContent = option.textContent;
                        newOption.dataset.provider = option.dataset.provider;
                        newOption.dataset.voice = option.dataset.voice;
                        optgroup.appendChild(newOption);
                    });
                    select.appendChild(optgroup);
                }
            });
        }

        function updateVoiceAssignment(character, voiceValue) {
            if (voiceValue) {
                dialogueData.voiceAssignments[character] = voiceValue;
                console.log(`Assigned ${voiceValue} to ${character}`);
            } else {
                delete dialogueData.voiceAssignments[character];
            }
        }

        async function generateMultiVoiceNarration() {
            const assignments = dialogueData.voiceAssignments;
            const characters = dialogueData.characters;
            
            if (Object.keys(assignments).length === 0) {
                showNotification('Please assign voices to characters first.', 'warning');
                return;
            }

            if (!assignments['Narrator']) {
                showNotification('Please assign a narrator voice.', 'warning');
                return;
            }

            showLoading('Generating multi-voice narration...');
            
            try {
                const content = storyData.currentContent || document.getElementById('storyEditor')?.value || '';
                if (!content.trim()) {
                    throw new Error('No story content to narrate');
                }

                // Store the plan for actual narration generation
                storyData.voiceAssignments = assignments;
                storyData.dialogueSections = dialogueData.dialogueSections;
                
                const audioSegments = [];
                
                // Simplified approach: Create segments by splitting on dialogue patterns
                const lines = content.split('\n').filter(line => line.trim());
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if this line contains dialogue
                    const characterMatch = line.match(/^(?:\[([^\]]+)\]|([A-Z][A-Z\s]*[A-Z])|([A-Z][a-z]+)):\s*"([^"]+)"/);
                    
                    if (characterMatch) {
                        // This is character dialogue
                        const character = characterMatch[1] || characterMatch[2] || characterMatch[3];
                        const dialogueText = characterMatch[4];
                        
                        audioSegments.push({
                            type: 'dialogue',
                            text: dialogueText,
                            voice: assignments[character] || assignments['Narrator'],
                            character: character
                        });
                        
                        // Add any remaining narrative part of the line
                        const narrativePart = line.replace(/^(?:\[([^\]]+)\]|([A-Z][A-Z\s]*[A-Z])|([A-Z][a-z]+)):\s*"([^"]+)"\s*/, '').trim();
                        if (narrativePart) {
                            audioSegments.push({
                                type: 'narrator',
                                text: narrativePart,
                                voice: assignments['Narrator'],
                                character: 'Narrator'
                            });
                        }
                    } else if (line.includes('"')) {
                        // Handle quoted dialogue without character tags
                        const quotes = line.match(/"([^"]+)"/g);
                        if (quotes) {
                            let remainingLine = line;
                            quotes.forEach(quote => {
                                const beforeQuote = remainingLine.substring(0, remainingLine.indexOf(quote)).trim();
                                if (beforeQuote) {
                                    audioSegments.push({
                                        type: 'narrator',
                                        text: beforeQuote,
                                        voice: assignments['Narrator'],
                                        character: 'Narrator'
                                    });
                                }
                                
                                const dialogueText = quote.replace(/"/g, '');
                                audioSegments.push({
                                    type: 'dialogue',
                                    text: dialogueText,
                                    voice: assignments['Unknown Speaker'] || assignments['Narrator'],
                                    character: 'Unknown Speaker'
                                });
                                
                                remainingLine = remainingLine.substring(remainingLine.indexOf(quote) + quote.length);
                            });
                            
                            // Add remaining text after quotes
                            if (remainingLine.trim()) {
                                audioSegments.push({
                                    type: 'narrator',
                                    text: remainingLine.trim(),
                                    voice: assignments['Narrator'],
                                    character: 'Narrator'
                                });
                            }
                        }
                    } else {
                        // Pure narrative line
                        audioSegments.push({
                            type: 'narrator',
                            text: line,
                            voice: assignments['Narrator'],
                            character: 'Narrator'
                        });
                    }
                }
                
                // Show detailed progress
                console.log('=== MULTI-VOICE GENERATION DEBUG ===');
                console.log('Audio segments to generate:', audioSegments.length);
                console.log('Voice assignments:', assignments);
                
                updateLoadingText(`Preparing ${audioSegments.length} audio segments...`);
                const audioFiles = [];
                const failedSegments = [];
                
                // Add progress tracking
                for (let i = 0; i < audioSegments.length; i++) {
                    const segment = audioSegments[i];
                    const progress = Math.round(((i + 1) / audioSegments.length) * 100);
                    
                    updateLoadingText(`🎙️ Generating ${segment.character} (${i + 1}/${audioSegments.length}) - ${progress}%`);
                    console.log(`Processing segment ${i + 1}: ${segment.character} - "${segment.text.substring(0, 50)}..."`);
                    
                    try {
                        const audioBlob = await generateSegmentAudio(segment);
                        if (audioBlob) {
                            audioFiles.push({
                                blob: audioBlob,
                                segment: segment,
                                index: i
                            });
                            console.log(`✅ Success: Generated audio for ${segment.character}`);
                        } else {
                            throw new Error('No audio blob returned');
                        }
                    } catch (segmentError) {
                        console.error(`❌ Failed: Segment ${i} (${segment.character}):`, segmentError);
                        failedSegments.push({
                            index: i,
                            character: segment.character,
                            error: segmentError.message,
                            text: segment.text.substring(0, 100)
                        });
                        
                        // Show individual warnings but continue
                        setTimeout(() => {
                            showNotification(`⚠️ Failed: ${segment.character} - ${segmentError.message}`, 'warning');
                        }, 100);
                    }
                    
                    // Small delay to prevent API rate limiting
                    if (i < audioSegments.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                console.log('=== GENERATION RESULTS ===');
                console.log(`✅ Successful: ${audioFiles.length}`);
                console.log(`❌ Failed: ${failedSegments.length}`);
                console.log('Failed segments:', failedSegments);
                
                if (audioFiles.length === 0) {
                    const errorDetails = failedSegments.map(f => `${f.character}: ${f.error}`).join(', ');
                    throw new Error(`No audio segments were generated successfully. Errors: ${errorDetails}`);
                }
                
                // Display results with summary
                displayMultiVoiceResults(audioFiles, assignments, failedSegments);
                hideLoading();
                
                // Show comprehensive results notification
                if (failedSegments.length === 0) {
                    showNotification(`✅ Perfect! All ${audioFiles.length} audio segments generated successfully!`, 'success');
                } else {
                    showNotification(`⚠️ Partial success: ${audioFiles.length} segments generated, ${failedSegments.length} failed. Check results below.`, 'warning');
                }
                
            } catch (error) {
                console.error('Multi-voice generation error:', error);
                showNotification(`Failed to generate multi-voice narration: ${error.message}`, 'error');
                hideLoading();
            }
        }

        async function generateSegmentAudio(segment) {
            const voiceInfo = segment.voice.split('_');
            const provider = voiceInfo[0];
            const voiceId = voiceInfo[1];
            
            if (provider === 'openai') {
                return await generateOpenAIAudio(segment.text, voiceId);
            } else if (provider === 'elevenlabs') {
                const apiKey = getElevenLabsApiKey();
                if (!apiKey) {
                    throw new Error('ElevenLabs API key not configured');
                }
                return await generateElevenLabsAudio(segment.text, voiceId, apiKey);
            } else {
                throw new Error(`Unknown voice provider: ${provider}`);
            }
        }

        async function generateOpenAIAudio(text, voice) {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                throw new Error('OpenAI API key not configured');
            }

            const response = await fetch('https://api.openai.com/v1/audio/speech', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'tts-1-hd',
                    input: text,
                    voice: voice,
                    response_format: 'mp3'
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI TTS API Error: ${response.status}`);
            }

            return await response.blob();
        }

        function displayMultiVoiceResults(audioFiles, assignments, failedSegments = []) {
            const narrationResults = document.getElementById('narrationResults');
            if (!narrationResults) return;

            let resultsHTML = `
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h3 class="text-xl font-bold mb-4 text-green-400">
                        <i class="fas fa-theater-masks mr-2"></i>Multi-Voice Narration Generated
                    </h3>
                    
                    <div class="mb-4 p-3 bg-theme-primary rounded-lg border border-theme">
                        <h4 class="font-semibold mb-2 text-cyan-400">Voice Assignments Used:</h4>
                        <div class="text-sm space-y-1">
            `;
            
            Object.entries(assignments).forEach(([character, voice]) => {
                const voiceDisplay = voice.replace('openai_', 'OpenAI: ').replace('elevenlabs_', 'ElevenLabs: ');
                resultsHTML += `<div>• <span class="text-cyan-300">${character}:</span> ${voiceDisplay}</div>`;
            });
            
            resultsHTML += `
                        </div>
                    </div>
                    
                    <div class="space-y-3 max-h-60 overflow-y-auto">
            `;
            
            audioFiles.forEach((audioFile, index) => {
                const audioUrl = URL.createObjectURL(audioFile.blob);
                const segment = audioFile.segment;
                const truncatedText = segment.text.length > 100 ? segment.text.substring(0, 100) + '...' : segment.text;
                
                resultsHTML += `
                    <div class="bg-theme-primary p-3 rounded-lg border border-theme">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="font-medium text-cyan-400">${segment.character} (${segment.type})</div>
                                <div class="text-xs text-theme-secondary mt-1">"${truncatedText}"</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <audio controls class="flex-1 h-8">
                                <source src="${audioUrl}" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                            <button onclick="downloadAudio('${audioUrl}', '${segment.character}_${index + 1}.mp3')" 
                                    class="text-cyan-400 hover:text-cyan-300 p-1">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += `
                    </div>
            `;
            
            // Add failed segments section if any
            if (failedSegments.length > 0) {
                resultsHTML += `
                    <div class="mt-4 bg-red-900 bg-opacity-20 border border-red-600 rounded-lg p-4">
                        <h4 class="font-medium text-red-400 mb-2">⚠️ Failed Segments (${failedSegments.length}):</h4>
                        <div class="text-sm text-red-300 space-y-1">
                `;
                failedSegments.forEach(failed => {
                    resultsHTML += `<div>• ${failed.character}: ${failed.error}</div>`;
                });
                resultsHTML += `
                        </div>
                    </div>
                `;
            }
            
            resultsHTML += `
                    <div class="mt-4 text-center">
                        <div class="bg-theme-primary p-3 rounded-lg mb-3 text-sm">
                            📊 <strong>Generation Summary:</strong> ${audioFiles.length} successful, ${failedSegments.length} failed
                        </div>
                        <button onclick="downloadAllMultiVoiceAudio()" class="btn-primary px-6 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>Download All Audio Segments
                        </button>
                    </div>
                </div>
            `;
            
            narrationResults.innerHTML = resultsHTML;
        }

        // Combine All Chapters function
        async function combineAllChapters() {
            if (!storyData.chapters || storyData.chapters.length === 0) {
                showNotification('No chapters found. Please generate chapters first.', 'warning');
                return;
            }
            
            showLoading('Combining all chapters into one document...');
            
            try {
                let combinedContent = '';
                let hasContent = false;
                
                // Add book title
                const bookTitle = document.getElementById('bookTitle')?.value || storyData.title || 'Untitled Book';
                combinedContent += `# ${bookTitle}\n\n`;
                
                // Combine all chapters
                for (let i = 0; i < storyData.chapters.length; i++) {
                    const chapter = storyData.chapters[i];
                    
                    // Add chapter header
                    combinedContent += `## Chapter ${chapter.number}: ${chapter.title}\n\n`;
                    
                    // Add chapter content if it exists
                    if (chapter.content && chapter.content.trim()) {
                        combinedContent += chapter.content + '\n\n';
                        hasContent = true;
                    } else {
                        // Generate chapter content if it doesn't exist
                        updateLoadingText(`Generating content for Chapter ${chapter.number}...`);
                        try {
                            const content = await generateSingleChapterContent(chapter);
                            if (content && content.trim()) {
                                combinedContent += content + '\n\n';
                                hasContent = true;
                                // Store generated content
                                chapter.content = content;
                            } else {
                                combinedContent += `[Chapter ${chapter.number} content will be generated here]\n\n`;
                            }
                        } catch (error) {
                            console.error(`Failed to generate Chapter ${chapter.number}:`, error);
                            combinedContent += `[Error generating Chapter ${chapter.number}: ${error.message}]\n\n`;
                        }
                    }
                }
                
                if (!hasContent) {
                    throw new Error('No chapter content available to combine');
                }
                
                // Store the combined content
                storyData.combinedContent = combinedContent;
                storyData.currentContent = combinedContent;
                
                // Display in the story editor
                const storyEditor = document.getElementById('storyEditor');
                if (storyEditor) {
                    storyEditor.value = combinedContent;
                    updateWordCount(); // Update word count display
                }
                
                hideLoading();
                showNotification(`Successfully combined ${storyData.chapters.length} chapters! Ready for narration.`, 'success');
                
                // Show preview modal
                showCombinedPreview(combinedContent, bookTitle);
                
            } catch (error) {
                console.error('Combine chapters error:', error);
                hideLoading();
                showNotification(`Failed to combine chapters: ${error.message}`, 'error');
            }
        }
        
        function showCombinedPreview(content, title) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-theme-secondary rounded-xl max-w-4xl max-h-[80vh] w-full flex flex-col border-2 border-theme">
                    <div class="flex items-center justify-between p-6 border-b border-theme">
                        <h3 class="text-xl font-bold text-cyan-400">
                            <i class="fas fa-book mr-2"></i>Combined Book Preview: ${title}
                        </h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-theme-secondary hover:text-theme-primary">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                            <pre class="whitespace-pre-wrap text-sm font-mono text-theme-primary">${content.substring(0, 5000)}${content.length > 5000 ? '\n\n... [Content truncated for preview. Full content is available in the editor.]' : ''}</pre>
                        </div>
                    </div>
                    <div class="p-6 border-t border-theme">
                        <div class="flex space-x-3 justify-center">
                            <button onclick="downloadCombinedBook()" class="btn-primary px-6 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i>Download as Text File
                            </button>
                            <button onclick="showPage('narration'); this.closest('.fixed').remove()" class="btn-secondary px-6 py-2 rounded-lg">
                                <i class="fas fa-microphone mr-2"></i>Create Narration
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="btn-gray px-6 py-2 rounded-lg">
                                Close Preview
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function downloadCombinedBook() {
            const content = storyData.combinedContent || storyData.currentContent;
            const title = document.getElementById('bookTitle')?.value || storyData.title || 'Untitled Book';
            
            if (!content) {
                showNotification('No combined content to download', 'error');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}_Complete_Book.txt`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('Combined book downloaded!', 'success');
        }

        // Character voice preview function
        async function previewCharacterVoice(characterName, selectId) {
            const selectElement = document.getElementById(selectId);
            const voiceValue = selectElement?.value;
            
            if (!voiceValue) {
                showNotification('Please select a voice first.', 'warning');
                return;
            }
            
            // Get sample text for this character
            let previewText;
            if (characterName === 'Narrator') {
                const content = storyData.currentContent || document.getElementById('storyEditor')?.value || '';
                previewText = content.replace(/"[^"]*"/g, '').trim().substring(0, 100);
                if (!previewText) previewText = "This is a sample of the narrator's voice speaking the story text.";
            } else {
                const characterDialogue = dialogueData.dialogueSections.find(d => d.character === characterName);
                previewText = characterDialogue ? characterDialogue.text : `Hello, this is ${characterName} speaking.`;
            }
            
            // Parse provider and voice ID
            const [provider, voiceId] = voiceValue.split('_');
            
            try {
                showLoading(`Previewing ${characterName}'s voice...`);
                
                let audioBlob;
                if (provider === 'openai') {
                    audioBlob = await generateOpenAIAudio(previewText, voiceId);
                } else if (provider === 'elevenlabs') {
                    const apiKey = getElevenLabsApiKey();
                    if (!apiKey) {
                        showNotification('Please configure your ElevenLabs API key first', 'error');
                        hideLoading();
                        return;
                    }
                    audioBlob = await generateElevenLabsAudio(previewText, voiceId, apiKey);
                }
                
                if (audioBlob) {
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.onloadeddata = () => {
                        hideLoading();
                        audio.play();
                        showNotification(`Playing ${characterName}'s voice preview`, 'success');
                    };
                    
                    audio.onerror = () => {
                        hideLoading();
                        showNotification('Failed to play voice preview', 'error');
                    };
                } else {
                    hideLoading();
                    showNotification('Failed to generate voice preview', 'error');
                }
                
            } catch (error) {
                console.error('Voice preview error:', error);
                hideLoading();
                showNotification(`Failed to preview voice: ${error.message}`, 'error');
            }
        }

        // Multi-voice audio download functions
        function downloadAllMultiVoiceAudio() {
            const audioElements = document.querySelectorAll('#narrationResults audio');
            audioElements.forEach((audio, index) => {
                const audioUrl = audio.querySelector('source').src;
                const character = audio.closest('.bg-theme-primary').querySelector('.text-cyan-400').textContent.split(' (')[0];
                downloadAudio(audioUrl, `${character}_segment_${index + 1}.mp3`);
            });
            showNotification(`Downloading ${audioElements.length} audio segments...`, 'success');
        }

        function downloadAudio(audioUrl, filename) {
            const link = document.createElement('a');
            link.href = audioUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            
            // Populate voice options when page loads
            setTimeout(() => {
                populateVoiceOptions();
                updateContentStatus(); // Check content status on load
            }, 1000);
            
            // Add text area listener for character count
            const textArea = document.getElementById('cloneTextInput');
            if (textArea) {
                textArea.addEventListener('input', updateCharCount);
            }
        });

        // Notification System
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            // Set colors based on type
            const colors = {
                'success': 'bg-green-600 text-white border-green-500',
                'error': 'bg-red-600 text-white border-red-500',
                'warning': 'bg-yellow-600 text-white border-yellow-500',
                'info': 'bg-blue-600 text-white border-blue-500'
            };
            
            const icons = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${icons[type] || icons.info} mr-3"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
