<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTHORR AI - AI-Powered Audiobook Creation Platform</title>
    <meta name="description" content="Create professional audiobooks with AI-powered writing, chapter generation, and text-to-speech narration. AUTHORR AI - Your complete audiobook creation solution.">
    <meta name="keywords" content="audiobook creation, AI writing, text to speech, book generation, storytelling, AI narration">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* AUTHORR AI Brand Colors - Cyan, Silver, Black, White */
        :root {
          --brand-cyan: #78e3fe;
          --brand-cyan-hover: #5dd8fc;
          --brand-silver: #C0C0C0;
          --brand-black: #000000;
          --brand-white: #FFFFFF;
          --brand-cyan-glow: 0 0 15px rgba(120, 227, 254, 0.6), 0 0 30px rgba(120, 227, 254, 0.3);
          --brand-silver-glow: 0 0 10px rgba(192, 192, 192, 0.8), 0 0 20px rgba(192, 192, 192, 0.4);
        }
        
        .authorr-brand-text {
          background: linear-gradient(135deg, #78e3fe, #5dd8fc);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          text-shadow: 0 0 10px rgba(120, 227, 254, 0.3);
          font-weight: 800;
          letter-spacing: 0.05em;
        }
        
        .logo-image {
          filter: drop-shadow(0 0 10px rgba(120, 227, 254, 0.4));
          animation: logoPulse 3s ease-in-out infinite alternate;
        }
        
        @keyframes logoPulse {
          0% { filter: drop-shadow(0 0 10px rgba(120, 227, 254, 0.4)); }
          100% { filter: drop-shadow(0 0 15px rgba(120, 227, 254, 0.6)); }
        }
        
        /* AI Writing Tools Button Styling - BLACK BACKGROUND, WHITE TEXT, GOLD GLOW */
        .ai-writing-tool-btn {
          background: #000000 !important;
          color: #ffffff !important;
          border: 2px solid #ffd700 !important;
          box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3) !important;
          font-weight: 600;
          transition: all 0.3s ease;
        }
        
        .ai-writing-tool-btn:hover {
          background: #1a1a1a !important;
          border-color: #ffed4a !important;
          box-shadow: 0 0 15px rgba(255, 215, 0, 0.7), 0 0 30px rgba(255, 215, 0, 0.4) !important;
          transform: translateY(-1px);
        }
        
        /* Theme Support */
        .theme-light {
          --bg-primary: #ffffff;
          --bg-secondary: #f8fafc;
          --text-primary: #1a202c;
          --text-secondary: #4a5568;
          --border-color: #e2e8f0;
        }
        
        .theme-dark {
          --bg-primary: #1a202c;
          --bg-secondary: #2d3748;
          --text-primary: #ffffff;
          --text-secondary: #cbd5e0;
          --border-color: #4a5568;
        }
        
        body {
          background-color: var(--bg-primary);
          color: var(--text-primary);
        }
        
        .bg-theme-primary { background-color: var(--bg-primary); }
        .bg-theme-secondary { background-color: var(--bg-secondary); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .border-theme { border-color: var(--border-color); }
        
        /* Navigation Styling */
        .nav-item {
          color: white !important;
          border: 2px solid transparent;
          transition: all 0.3s ease;
        }
        
        .nav-item:hover, .nav-item.active {
          border-color: var(--brand-cyan);
          box-shadow: var(--brand-cyan-glow);
          background: rgba(120, 227, 254, 0.1);
        }
        
        /* Glow Effects */
        .cyan-glow { box-shadow: var(--brand-cyan-glow); }
        .silver-glow { box-shadow: var(--brand-silver-glow); }
        
        /* Form Enhancements */
        .form-field {
          border: 2px solid var(--border-color);
          transition: all 0.3s ease;
        }
        
        .form-field:focus {
          border-color: var(--brand-cyan);
          box-shadow: 0 0 10px rgba(120, 227, 254, 0.3);
          outline: none;
        }
        
        /* Button Styles */
        .btn-primary {
          background: linear-gradient(135deg, var(--brand-cyan), var(--brand-cyan-hover));
          color: white;
          border: none;
          transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: var(--brand-cyan-glow);
        }
        
        .btn-secondary {
          background: var(--brand-silver);
          color: var(--brand-black);
          border: 2px solid var(--brand-silver);
          transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
          background: transparent;
          color: var(--brand-silver);
          box-shadow: var(--brand-silver-glow);
        }
        
        /* Loading Animation */
        .loading-spinner {
          border: 3px solid rgba(120, 227, 254, 0.3);
          border-radius: 50%;
          border-top: 3px solid var(--brand-cyan);
          width: 30px;
          height: 30px;
          animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* Word Count Display */
        .word-count {
          position: absolute;
          bottom: 10px;
          right: 15px;
          background: rgba(120, 227, 254, 0.1);
          color: var(--brand-cyan);
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
        }
        
        /* Editable Elements */
        .editable-title:focus, .editable-summary:focus {
          background-color: rgba(120, 227, 254, 0.1) !important;
          border-radius: 4px;
          padding: 2px;
          outline: 2px solid var(--brand-cyan);
        }
        
        /* Chapter Status */
        .chapter-status {
          font-size: 10px;
          margin-top: 4px;
          padding: 2px 6px;
          border-radius: 12px;
          text-align: center;
        }
        
        .status-ready { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
        .status-generating { background: rgba(251, 191, 36, 0.2); color: #d97706; }
        .status-complete { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
        
        /* Error States */
        .error-border { border-color: #ef4444 !important; }
        .error-text { color: #ef4444; }
        
        /* Success States */
        .success-border { border-color: #10b981 !important; }
        .success-text { color: #10b981; }
        
        /* Sound Wave Animation */
        .sound-wave-container {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
          background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(34, 197, 94, 0.1));
          border-radius: 12px;
          border: 1px solid rgba(6, 182, 212, 0.3);
          max-width: 50%;
          margin: 0 auto;
        }
        
        .sound-wave {
          display: flex;
          align-items: center;
          gap: 4px;
        }
        
        .wave-bar {
          width: 8px;
          height: 20px;
          background: linear-gradient(to top, #06b6d4, #10b981);
          border-radius: 4px;
          animation: wave 1.5s ease-in-out infinite;
          transform-origin: bottom;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { animation-delay: 0.3s; }
        .wave-bar:nth-child(7) { animation-delay: 0.2s; }
        .wave-bar:nth-child(8) { animation-delay: 0.1s; }
        
        @keyframes wave {
          0%, 100% { 
            transform: scaleY(1);
            background: linear-gradient(to top, #06b6d4, #10b981);
          }
          50% { 
            transform: scaleY(3);
            background: linear-gradient(to top, #0891b2, #059669, #10b981);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
          }
        }
        
        /* Cloning Station Effects */
        .cloning-station {
          position: relative;
          overflow: hidden;
        }
        
        .cloning-station::before {
          content: '';
          position: absolute;
          top: -2px;
          left: -2px;
          right: -2px;
          bottom: -2px;
          background: linear-gradient(45deg, transparent, rgba(6, 182, 212, 0.3), transparent, rgba(16, 185, 129, 0.3), transparent);
          border-radius: 14px;
          animation: borderGlow 3s linear infinite;
          z-index: -1;
        }
        
        @keyframes borderGlow {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        /* Recording Sound Wave Animation */
        .recording-wave-container {
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 10px;
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
          border-radius: 8px;
          border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .recording-wave {
          display: flex;
          align-items: center;
          gap: 2px;
        }
        
        .recording-bar {
          width: 4px;
          height: 10px;
          background: linear-gradient(to top, #ef4444, #f59e0b);
          border-radius: 2px;
          animation: recordingWave 0.8s ease-in-out infinite;
        }
        
        .recording-bar:nth-child(1) { animation-delay: 0s; }
        .recording-bar:nth-child(2) { animation-delay: 0.1s; }
        .recording-bar:nth-child(3) { animation-delay: 0.2s; }
        .recording-bar:nth-child(4) { animation-delay: 0.1s; }
        .recording-bar:nth-child(5) { animation-delay: 0s; }
        
        @keyframes recordingWave {
          0%, 100% { 
            height: 10px;
            background: linear-gradient(to top, #ef4444, #f59e0b);
          }
          50% { 
            height: 25px;
            background: linear-gradient(to top, #dc2626, #d97706, #f59e0b);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
          }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .mobile-stack { flex-direction: column; }
          .mobile-full { width: 100%; }
          .mobile-text-sm { font-size: 14px; }
          .sound-wave-container { padding: 15px; }
          .wave-bar { width: 6px; height: 16px; }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Navigation -->
    <nav class="bg-black border-b-2 border-cyan-400 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <img src="https://page.gensparksite.com/v1/base64_upload/5ec0a971230da95148e537dd473d0fb1" alt="AUTHORR AI Logo" class="w-12 h-12 logo-image">
                    <h1 class="text-3xl font-bold authorr-brand-text">AUTHORR AI</h1>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <button onclick="showPage('dashboard')" class="nav-item px-4 py-2 rounded-lg font-semibold active">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </button>
                    <button onclick="showPage('workspace')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-edit mr-2"></i>Workspace
                    </button>
                    <button onclick="showPage('narration')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-microphone mr-2"></i>Narration
                    </button>
                    <button onclick="showPage('covers')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-image mr-2"></i>Covers
                    </button>
                    <button onclick="showPage('export')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="showPage('config')" class="nav-item px-4 py-2 rounded-lg font-semibold">
                        <i class="fas fa-cog mr-2"></i>Config
                    </button>
                </div>
                <button onclick="toggleTheme()" class="text-cyan-400 hover:text-cyan-300 text-xl">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
        <div class="container mx-auto px-4 py-8">
            <!-- Hero Section -->
            <div class="text-center mb-12">
                <div class="flex justify-center items-center mb-6">
                    <img src="https://page.gensparksite.com/v1/base64_upload/5ec0a971230da95148e537dd473d0fb1" alt="AUTHORR AI Logo" class="w-20 h-20 logo-image mr-4">
                    <h1 class="text-6xl font-bold authorr-brand-text">AUTHORR AI</h1>
                </div>
                <p class="text-xl text-theme-secondary mb-8 max-w-3xl mx-auto">
                    Transform your stories into professional audiobooks with AI-powered writing, chapter generation, 
                    and high-quality text-to-speech narration. Create, edit, and publish audiobooks in minutes.
                </p>
                <button onclick="showPage('workspace')" class="btn-primary px-8 py-4 rounded-lg text-lg font-semibold">
                    <i class="fas fa-rocket mr-2"></i>Start Creating Your Audiobook
                </button>
            </div>

            <!-- Features Grid -->
            <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">AI-Powered Writing</h3>
                    <p class="text-theme-secondary">
                        Generate engaging chapters, stories, and content with advanced GPT-4o-mini integration. 
                        Choose from multiple genres, tones, and writing styles.
                    </p>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">Professional Narration</h3>
                    <p class="text-theme-secondary">
                        Convert your text to high-quality speech with OpenAI's TTS-1-HD. Choose from 6 professional 
                        voices including Alloy, Echo, Fable, Onyx, Nova, and Shimmer.
                    </p>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme hover:border-cyan-400 transition-all duration-300 cyan-glow">
                    <div class="text-cyan-400 text-3xl mb-4">
                        <i class="fas fa-image"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-3">AI Book Covers</h3>
                    <p class="text-theme-secondary">
                        Generate stunning book covers with DALL-E 3 in HD quality (1024x1792). 
                        Create professional artwork that matches your story's theme.
                    </p>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="grid md:grid-cols-4 gap-6 mb-12">
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">25</div>
                    <div class="text-theme-secondary">Max Chapters</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">3000</div>
                    <div class="text-theme-secondary">Max Words/Chapter</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">6</div>
                    <div class="text-theme-secondary">AI Voices</div>
                </div>
                <div class="text-center bg-theme-secondary p-6 rounded-xl">
                    <div class="text-3xl font-bold text-cyan-400 mb-2">∞</div>
                    <div class="text-theme-secondary">Possibilities</div>
                </div>
            </div>

            <!-- Quick Start Guide -->
            <div class="bg-theme-secondary p-8 rounded-xl border-2 border-theme">
                <h2 class="text-2xl font-bold mb-6 text-center">
                    <i class="fas fa-play-circle text-cyan-400 mr-2"></i>
                    Quick Start Guide
                </h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">1</div>
                        <h3 class="font-semibold mb-2">Plan Your Story</h3>
                        <p class="text-sm text-theme-secondary">Choose genre, set chapter count, and define your story parameters</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">2</div>
                        <h3 class="font-semibold mb-2">Generate Content</h3>
                        <p class="text-sm text-theme-secondary">Use AI writing tools to create engaging chapters and storylines</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">3</div>
                        <h3 class="font-semibold mb-2">Create Narration</h3>
                        <p class="text-sm text-theme-secondary">Convert to speech with professional AI voices and generate covers</p>
                    </div>
                    <div class="text-center">
                        <div class="bg-cyan-400 text-black rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3 font-bold text-xl">4</div>
                        <h3 class="font-semibold mb-2">Export & Publish</h3>
                        <p class="text-sm text-theme-secondary">Download your complete audiobook and share with the world</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace Page -->
    <div id="workspace" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-edit text-cyan-400 mr-3"></i>
                    Audiobook Workspace
                </h1>
                <button onclick="showPage('narration')" id="continueToNarration" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-arrow-right mr-2"></i>Continue to Narration
                </button>
            </div>

            <!-- Story Planning Form -->
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <!-- Left Column: Story Parameters -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-cogs text-cyan-400 mr-2"></i>
                        Story Parameters
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Book Title</label>
                            <input type="text" id="bookTitle" placeholder="Enter your book title" 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Chapter Selection</label>
                                <select id="chapterCount" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="3">3 Chapters</option>
                                    <option value="5">5 Chapters</option>
                                    <option value="7">7 Chapters</option>
                                    <option value="10" selected>10 Chapters</option>
                                    <option value="15">15 Chapters</option>
                                    <option value="20">20 Chapters</option>
                                    <option value="25">25 Chapters</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2">Words per Chapter</label>
                                <select id="wordsPerChapter" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="250">250 words (~1 min audio)</option>
                                    <option value="500">500 words (~2 min audio)</option>
                                    <option value="750">750 words (~3 min audio)</option>
                                    <option value="1000" selected>1000 words (~4 min audio)</option>
                                    <option value="1250">1250 words (~5 min audio)</option>
                                    <option value="1500">1500 words (~6 min audio)</option>
                                    <option value="2000">2000 words (~8 min audio)</option>
                                    <option value="2500">2500 words (~10 min audio)</option>
                                    <option value="3000">3000 words (~12 min audio)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Genre & Subgenre</label>
                            <select id="genre" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="fiction-literary">Fiction - Literary</option>
                                <option value="fiction-mystery">Fiction - Mystery/Thriller</option>
                                <option value="fiction-romance">Fiction - Romance</option>
                                <option value="fiction-scifi">Fiction - Science Fiction</option>
                                <option value="fiction-fantasy">Fiction - Fantasy</option>
                                <option value="fiction-horror">Fiction - Horror</option>
                                <option value="fiction-historical">Fiction - Historical</option>
                                <option value="nonfiction-biography">Non-Fiction - Biography</option>
                                <option value="nonfiction-selfhelp">Non-Fiction - Self-Help</option>
                                <option value="nonfiction-business">Non-Fiction - Business</option>
                                <option value="nonfiction-history">Non-Fiction - History</option>
                                <option value="children-adventure">Children's - Adventure</option>
                                <option value="children-educational">Children's - Educational</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Tone & Voice</label>
                            <select id="tone" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="professional">Professional</option>
                                <option value="casual">Casual & Conversational</option>
                                <option value="dramatic">Dramatic & Intense</option>
                                <option value="humorous">Humorous & Light</option>
                                <option value="inspiring">Inspiring & Motivational</option>
                                <option value="mysterious">Mysterious & Suspenseful</option>
                                <option value="romantic">Romantic & Emotional</option>
                                <option value="educational">Educational & Informative</option>
                                <option value="adventurous">Adventurous & Exciting</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Story Outline</label>
                            <div class="relative">
                                <textarea id="storyOutline" placeholder="Describe your story concept, main characters, and plot outline..." 
                                          class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-24 resize-none"></textarea>
                                <div class="absolute bottom-2 right-3 text-xs text-cyan-400 bg-black bg-opacity-50 px-2 py-1 rounded">
                                    <span id="outlineWordCount">0 words</span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="generateChapterPlan()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                            <i class="fas fa-magic mr-2"></i>Generate Chapter Plan
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Chapter Plan -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-list-ol text-cyan-400 mr-2"></i>
                            Chapter Plan
                        </h2>
                        <button onclick="generateAllChapters()" id="generateAllBtn" class="btn-secondary px-4 py-2 rounded-lg text-sm font-semibold" disabled>
                            <i class="fas fa-bolt mr-1"></i>Generate All Stories
                        </button>
                    </div>
                    
                    <div id="chapterPlan" class="space-y-3 h-80 overflow-y-auto">
                        <div class="text-center text-theme-secondary py-8">
                            <i class="fas fa-lightbulb text-4xl mb-3 opacity-50"></i>
                            <p>Generate a chapter plan to get started</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Text Editor Section -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">
                        <i class="fas fa-pen-fancy text-cyan-400 mr-2"></i>
                        Story Editor
                    </h2>
                    <div class="flex items-center space-x-3">
                        <div class="word-count" id="wordCount">0 words</div>
                        <button onclick="undoEdit()" id="undoBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        <button onclick="redoEdit()" id="redoBtn" class="btn-secondary px-3 py-1 rounded text-sm" disabled>
                            <i class="fas fa-redo"></i> Redo
                        </button>
                        <button onclick="saveStory()" id="saveBtn" class="btn-primary px-3 py-1 rounded text-sm">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
                
                <!-- AI Writing Tools -->
                <div class="flex flex-wrap gap-2 mb-4 p-3 bg-theme-primary rounded-lg border border-theme">
                    <button onclick="expandStory()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-expand-alt mr-1"></i>Expand
                    </button>
                    <button onclick="improveStory()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-magic mr-1"></i>Improve
                    </button>
                    <button onclick="addDialogue()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-comments mr-1"></i>Add Dialogue
                    </button>
                    <button onclick="addDescription()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-paint-brush mr-1"></i>Add Description
                    </button>
                    <button onclick="createTransition()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-arrow-right mr-1"></i>Transition
                    </button>
                    <button onclick="addConflict()" class="ai-writing-tool-btn px-3 py-1 rounded text-sm">
                        <i class="fas fa-bolt mr-1"></i>Add Conflict
                    </button>
                </div>
                
                <div class="relative">
                    <textarea id="storyEditor" placeholder="Start writing your story here, or use the AI writing tools to generate content..." 
                              class="w-full px-4 py-3 rounded-lg form-field bg-theme-primary text-theme-primary h-96 resize-none"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Narration Page -->
    <div id="narration" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">
                    <i class="fas fa-microphone text-cyan-400 mr-3"></i>
                    Audio Narration
                </h1>
                <button onclick="showPage('export')" class="btn-primary px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-download mr-2"></i>Export Audiobook
                </button>
            </div>

            <!-- Animated Sound Wave -->
            <div class="sound-wave-container mb-8">
                <div class="sound-wave">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Voice Selection & Controls -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-volume-up text-cyan-400 mr-2"></i>
                        Voice & Audio Settings
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Voice Actors</label>
                            <select id="voiceSelection" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="alloy">Alloy - Balanced, Clear</option>
                                <option value="echo">Echo - Male, Authoritative</option>
                                <option value="fable">Fable - Warm, Storytelling</option>
                                <option value="onyx">Onyx - Deep, Professional</option>
                                <option value="nova">Nova - Female, Engaging</option>
                                <option value="shimmer">Shimmer - Soft, Gentle</option>
                            </select>
                            <button onclick="previewSelectedVoice()" class="btn-secondary w-full mt-2 py-2 rounded-lg text-sm">
                                <i class="fas fa-play mr-2"></i>Preview Voice
                            </button>
                            <div id="voicePreviewPlayer" class="hidden mt-2">
                                <audio controls class="w-full">
                                    <source id="voicePreviewSource" src="" type="audio/mpeg">
                                </audio>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Speech Rate</label>
                                <select id="speechRate" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="0.75">Slow (0.75x)</option>
                                    <option value="1.0" selected>Normal (1.0x)</option>
                                    <option value="1.25">Fast (1.25x)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2">Audio Format</label>
                                <select id="audioFormat" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="mp3" selected>MP3 (Recommended)</option>
                                    <option value="opus">OPUS (High Quality)</option>
                                    <option value="aac">AAC (Apple Compatible)</option>
                                    <option value="flac">FLAC (Lossless)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Preview Text</label>
                            <textarea id="previewText" placeholder="Enter text to preview the selected voice..." 
                                      class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-20 resize-none"></textarea>
                        </div>
                        
                        <button onclick="previewVoice()" class="btn-secondary w-full py-2 rounded-lg font-semibold">
                            <i class="fas fa-play mr-2"></i>Preview Voice
                        </button>
                        
                        <div class="border-t border-theme pt-4">
                            <button onclick="generateNarration()" class="btn-primary w-full py-3 rounded-lg font-semibold">
                                <i class="fas fa-microphone mr-2"></i>Generate Full Narration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- High-Tech Voice Cloning Station -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme cloning-station">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-dna text-cyan-400 mr-2 animate-pulse"></i>
                        Voice Cloning Station
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="bg-theme-primary p-4 rounded-lg border border-cyan-500">
                            <div class="flex items-center mb-2">
                                <div class="w-3 h-3 rounded-full bg-green-400 mr-2 animate-pulse"></div>
                                <span class="text-sm font-semibold text-cyan-400">Neural Voice Matrix</span>
                            </div>
                            <p class="text-xs text-theme-secondary mb-3">Upload voice samples to create custom AI narrator profiles</p>
                            
                            <!-- Audio Upload Section -->
                            <div class="border-dashed border-2 border-cyan-500 p-4 rounded-lg text-center hover:border-cyan-300 transition-colors cursor-pointer" 
                                 ondrop="handleVoiceDrop(event)" ondragover="allowDrop(event)" onclick="document.getElementById('voiceUpload').click()">
                                <i class="fas fa-microphone text-cyan-400 text-2xl mb-2"></i>
                                <p class="text-sm text-cyan-300">Drag & drop audio files or click to browse</p>
                                <input type="file" id="voiceUpload" accept=".mp3,.wav,.m4a" multiple class="hidden">
                            </div>
                            
                            <!-- Text Input Section -->
                            <div class="border-dashed border-2 border-purple-500 p-4 rounded-lg hover:border-purple-300 transition-colors" 
                                 ondrop="handleTextDrop(event)" ondragover="allowDrop(event)">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-file-text text-purple-400 mr-2"></i>
                                    <span class="text-sm font-semibold text-purple-400">Text Input & Preview</span>
                                </div>
                                <textarea id="cloneTextInput" placeholder="Drag & drop text files here or type/paste your text for voice cloning preview..." 
                                          class="w-full px-3 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-20 resize-none text-sm"></textarea>
                                <div class="flex justify-between items-center mt-2 text-xs text-theme-secondary">
                                    <span id="textCharCount">0 characters</span>
                                    <button onclick="previewCloneText()" class="btn-secondary px-3 py-1 rounded text-xs">
                                        <i class="fas fa-play mr-1"></i>Preview
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Recording Section -->
                            <div class="border-2 border-red-500 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-record-vinyl text-red-400 mr-2"></i>
                                        <span class="text-sm font-semibold text-red-400">Live Recording</span>
                                    </div>
                                    <div id="recordingIndicator" class="hidden flex items-center">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"></div>
                                        <span class="text-xs text-red-400">Recording...</span>
                                    </div>
                                </div>
                                
                                <!-- Mini Recording Sound Wave -->
                                <div id="recordingWave" class="hidden recording-wave-container mb-3">
                                    <div class="recording-wave">
                                        <div class="recording-bar"></div>
                                        <div class="recording-bar"></div>
                                        <div class="recording-bar"></div>
                                        <div class="recording-bar"></div>
                                        <div class="recording-bar"></div>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button id="recordBtn" onclick="startRecording()" class="btn-primary flex-1 py-2 rounded-lg text-sm">
                                        <i class="fas fa-microphone mr-1"></i>Record
                                    </button>
                                    <button id="stopBtn" onclick="stopRecording()" disabled class="btn-secondary flex-1 py-2 rounded-lg text-sm opacity-50">
                                        <i class="fas fa-stop mr-1"></i>Stop
                                    </button>
                                </div>
                                
                                <div id="recordedAudio" class="hidden mt-3">
                                    <audio controls class="w-full">
                                        <source id="recordedAudioSource" src="" type="audio/wav">
                                    </audio>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold">Clone Quality</span>
                                <div class="flex space-x-1">
                                    <div class="w-2 h-4 bg-green-400 rounded animate-pulse"></div>
                                    <div class="w-2 h-4 bg-green-400 rounded animate-pulse" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-4 bg-yellow-400 rounded animate-pulse" style="animation-delay: 0.2s"></div>
                                    <div class="w-2 h-4 bg-gray-600 rounded"></div>
                                    <div class="w-2 h-4 bg-gray-600 rounded"></div>
                                </div>
                            </div>
                            
                            <select id="cloneModel" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="enhanced">Enhanced Neural Model</option>
                                <option value="standard">Standard Clone</option>
                                <option value="premium">Premium Voice Synthesis</option>
                            </select>
                        </div>
                        
                        <button onclick="initiateVoiceClone()" class="btn-primary w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500">
                            <i class="fas fa-flask mr-2"></i>Initialize Voice Clone
                        </button>
                        
                        <div id="cloningProgress" class="hidden mt-4">
                            <div class="bg-theme-primary p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-cyan-400">Neural Processing...</span>
                                    <span class="text-xs text-theme-secondary" id="cloningPercent">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="cloningBar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audio Progress & Results -->
            <div class="mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-headphones text-cyan-400 mr-2"></i>
                    Narration Progress
                </h2>
                
                <div id="narrationProgress" class="hidden">
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Generating Audio...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 rounded-full h-3">
                            <div id="progressBar" class="bg-cyan-400 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div id="audioResults" class="space-y-4">
                    <!-- Generated audio files will appear here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Book Covers Page -->
    <div id="covers" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-image text-cyan-400 mr-3"></i>
                AI Book Cover Generator
            </h1>

            <!-- Platform Dimension Templates -->
            <div class="mb-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-ruler text-cyan-400 mr-2"></i>
                    Platform Dimension Templates
                </h2>
                <div class="grid md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <button onclick="selectPlatformTemplate('audible')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-amazon text-orange-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Audible</div>
                            <div class="text-xs text-theme-secondary">2400×2400px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('spotify')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-spotify text-green-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Spotify</div>
                            <div class="text-xs text-theme-secondary">3000×3000px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('apple')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-apple text-gray-300 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Apple</div>
                            <div class="text-xs text-theme-secondary">3000×3000px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('google')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fab fa-google text-blue-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">Google Play</div>
                            <div class="text-xs text-theme-secondary">2400×2400px</div>
                        </div>
                    </button>
                    <button onclick="selectPlatformTemplate('overdrive')" class="platform-template p-3 rounded-lg bg-theme-primary border border-theme hover:border-cyan-400 transition-colors">
                        <div class="text-center">
                            <i class="fas fa-book text-purple-400 text-2xl mb-2"></i>
                            <div class="font-semibold text-sm">OverDrive</div>
                            <div class="text-xs text-theme-secondary">1800×2700px</div>
                        </div>
                    </button>
                </div>
                <div class="mt-4 text-sm text-theme-secondary">
                    <i class="fas fa-info-circle mr-2"></i>
                    Click a platform to auto-configure dimensions and optimization settings
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Cover Design Panel -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-palette text-cyan-400 mr-2"></i>
                        Design Your Cover
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Platform</label>
                                <select id="selectedPlatform" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="universal">Universal (Square)</option>
                                    <option value="audible">Audible (2400×2400)</option>
                                    <option value="spotify">Spotify (3000×3000)</option>
                                    <option value="apple">Apple Podcasts (3000×3000)</option>
                                    <option value="google">Google Play (2400×2400)</option>
                                    <option value="overdrive">OverDrive (1800×2700)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Cover Style</label>
                                <select id="coverStyle" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="modern">Modern & Clean</option>
                                    <option value="classic">Classic Literature</option>
                                    <option value="mysterious">Dark & Mysterious</option>
                                    <option value="romantic">Romantic & Elegant</option>
                                    <option value="fantasy">Fantasy Adventure</option>
                                    <option value="scifi">Sci-Fi Futuristic</option>
                                    <option value="horror">Horror & Thriller</option>
                                    <option value="children">Children's Colorful</option>
                                    <option value="business">Professional Business</option>
                                    <option value="memoir">Personal Memoir</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Book Title</label>
                            <input type="text" id="coverTitle" placeholder="Enter your book title..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Author Name</label>
                            <input type="text" id="coverAuthor" placeholder="Enter author name..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Subtitle (Optional)</label>
                            <input type="text" id="coverSubtitle" placeholder="Enter subtitle if any..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Visual Description</label>
                            <textarea id="coverDescription" placeholder="Describe the visual elements, mood, colors, and style for your book cover. Be specific about imagery, atmosphere, and design elements..." 
                                      class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary h-32 resize-none"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Primary Color</label>
                                <input type="color" id="primaryColor" value="#06b6d4" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Accent Color</label>
                                <input type="color" id="accentColor" value="#10b981" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Text Color</label>
                                <input type="color" id="textColor" value="#ffffff" 
                                       class="w-full h-12 rounded-lg border-2 border-theme cursor-pointer">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Image Quality</label>
                                <select id="imageQuality" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="standard">Standard (1024×1024)</option>
                                    <option value="hd" selected>HD (1792×1024)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Art Style</label>
                                <select id="artStyle" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                    <option value="photorealistic">Photorealistic</option>
                                    <option value="digital-art">Digital Art</option>
                                    <option value="illustration">Illustration</option>
                                    <option value="painting">Oil Painting</option>
                                    <option value="minimalist">Minimalist</option>
                                    <option value="vintage">Vintage</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="generateAICover()" class="btn-primary w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500">
                            <i class="fas fa-magic mr-2"></i>Generate Cover
                        </button>
                    </div>
                </div>
                
                <!-- Cover Preview Panel -->
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-eye text-cyan-400 mr-2"></i>
                        Cover Preview & Variations
                    </h2>
                    
                    <div id="coverPreviewPanel">
                        <div class="bg-theme-primary border-2 border-dashed border-theme rounded-lg p-8 mb-4 text-center" id="placeholderPreview">
                            <i class="fas fa-image text-6xl text-theme-secondary mb-4"></i>
                            <p class="text-theme-secondary">Generate your AI cover to see preview</p>
                            <p class="text-xs text-theme-secondary mt-2">Dimensions will adjust based on selected platform</p>
                        </div>
                        
                        <div id="coverPreview" class="hidden">
                            <div class="text-center mb-4">
                                <div class="inline-block relative">
                                    <img id="generatedCover" src="" alt="Generated Book Cover" class="max-w-full h-auto rounded-lg shadow-lg border-2 border-theme">
                                    <div class="absolute top-2 right-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded" id="dimensionDisplay">
                                        2400×2400px
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex justify-center space-x-2">
                                    <button onclick="regenerateAICover()" class="btn-secondary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-sync mr-1"></i>Regenerate
                                    </button>
                                    <button onclick="createVariations()" class="btn-secondary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-clone mr-1"></i>Variations
                                    </button>
                                    <button onclick="downloadCover()" class="btn-primary px-4 py-2 rounded text-sm">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="downloadForPlatform('print')" class="btn-secondary w-full py-2 rounded text-xs">
                                        <i class="fas fa-print mr-1"></i>Print Ready
                                    </button>
                                    <button onclick="downloadForPlatform('web')" class="btn-secondary w-full py-2 rounded text-xs">
                                        <i class="fas fa-globe mr-1"></i>Web Optimized
                                    </button>
                                </div>
                                
                                <button onclick="setCoverAsMain()" class="btn-primary w-full py-2 rounded text-sm">
                                    <i class="fas fa-check mr-1"></i>Use as Main Cover
                                </button>
                            </div>
                        </div>
                        
                        <!-- Cover Variations -->
                        <div id="coverVariations" class="hidden mt-6">
                            <h3 class="text-lg font-semibold mb-4">AI Generated Variations</h3>
                            <div class="grid grid-cols-2 gap-4" id="variationsGrid">
                                <!-- Variations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Generation Progress -->
            <div id="coverGenerationProgress" class="hidden mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-magic text-cyan-400 mr-2 animate-spin"></i>
                    AI Cover Generation in Progress
                </h3>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm" id="generationStep">Analyzing design preferences...</span>
                        <div class="w-6 h-6 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    
                    <div class="w-full bg-theme-primary rounded-full h-3">
                        <div id="coverProgressBar" class="bg-gradient-to-r from-cyan-500 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <div class="text-xs text-theme-secondary text-center">
                        <div id="progressMessage">Processing with OpenAI DALL-E API...</div>
                        <div class="mt-1">High-quality generation typically takes 10-30 seconds</div>
                    </div>
                </div>
            </div>

            <!-- Platform Requirements Info -->
            <div class="mt-8 bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                    Platform Requirements & Guidelines
                </h3>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-400 mb-2"><i class="fab fa-amazon mr-1"></i> Audible</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 2400×2400px minimum</li>
                            <li>• Square aspect ratio</li>
                            <li>• RGB color space</li>
                            <li>• Text must be readable at 150px</li>
                        </ul>
                    </div>
                    
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-green-400 mb-2"><i class="fab fa-spotify mr-1"></i> Spotify</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 3000×3000px recommended</li>
                            <li>• Square format required</li>
                            <li>• High contrast text</li>
                            <li>• No promotional text</li>
                        </ul>
                    </div>
                    
                    <div class="bg-theme-primary p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-300 mb-2"><i class="fab fa-apple mr-1"></i> Apple</h4>
                        <ul class="space-y-1 text-theme-secondary">
                            <li>• 3000×3000px minimum</li>
                            <li>• Square aspect ratio</li>
                            <li>• 72 DPI minimum</li>
                            <li>• Clear, legible text</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Page -->
    <div id="export" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-download text-cyan-400 mr-3"></i>
                Export Your Audiobook
            </h1>

            <!-- Export Options -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-file-archive text-cyan-400 mr-2"></i>
                        Package Options
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Complete Audiobook Package</h3>
                                <button class="btn-primary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">All audio files, cover image, and metadata in ZIP format</p>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Audio Files Only</h3>
                                <button class="btn-secondary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">MP3 files for each chapter</p>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Text Manuscript</h3>
                                <button class="btn-secondary px-4 py-1 rounded text-sm">Download</button>
                            </div>
                            <p class="text-sm text-theme-secondary">Complete story text in DOC/PDF format</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-share-alt text-cyan-400 mr-2"></i>
                        Publishing Options
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Audible Ready</h3>
                            <p class="text-sm text-theme-secondary mb-3">Format optimized for Audible submission</p>
                            <button class="btn-primary px-4 py-1 rounded text-sm w-full">Prepare for Audible</button>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Podcast Format</h3>
                            <p class="text-sm text-theme-secondary mb-3">Individual episodes with RSS feed</p>
                            <button class="btn-secondary px-4 py-1 rounded text-sm w-full">Generate Podcast</button>
                        </div>
                        
                        <div class="border border-theme p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">YouTube Series</h3>
                            <p class="text-sm text-theme-secondary mb-3">Video format with static cover image</p>
                            <button class="btn-secondary px-4 py-1 rounded text-sm w-full">Create Video Series</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Summary -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-info-circle text-cyan-400 mr-2"></i>
                    Project Summary
                </h2>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportChapterCount">10</div>
                        <div class="text-sm text-theme-secondary">Chapters</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportTotalWords">10,000</div>
                        <div class="text-sm text-theme-secondary">Total Words</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-cyan-400 mb-1" id="exportDuration">~2.5 hours</div>
                        <div class="text-sm text-theme-secondary">Audio Duration</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Page -->
    <div id="config" class="page hidden">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">
                <i class="fas fa-cog text-cyan-400 mr-3"></i>
                Configuration & Settings
            </h1>

            <!-- API Configuration -->
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-key text-cyan-400 mr-2"></i>
                        API Configuration
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">OpenAI API Key</label>
                            <input type="password" id="openaiKey" placeholder="sk-..." 
                                   class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                            <p class="text-xs text-theme-secondary mt-1">Required for AI writing and narration features</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Model Selection</label>
                            <select id="modelSelection" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="gpt-4o-mini" selected>GPT-4o-mini (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5-turbo (Faster)</option>
                                <option value="gpt-4">GPT-4 (Premium)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="testApiConnection()" class="btn-primary w-full py-2 rounded-lg font-semibold">
                                <i class="fas fa-wifi mr-2"></i>Test API Connection
                            </button>
                            <button onclick="saveSettings()" class="btn-secondary w-full py-2 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-palette text-cyan-400 mr-2"></i>
                        Appearance Settings
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Theme</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setTheme('light')" class="p-3 rounded-lg border-2 border-theme bg-white text-black">
                                    <i class="fas fa-sun mb-1"></i><br>Light
                                </button>
                                <button onclick="setTheme('dark')" class="p-3 rounded-lg border-2 border-theme bg-gray-800 text-white">
                                    <i class="fas fa-moon mb-1"></i><br>Dark
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Font Size</label>
                            <select id="fontSize" class="w-full px-4 py-2 rounded-lg form-field bg-theme-primary text-theme-primary">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Auto-save</label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoSave" checked class="mr-2">
                                <span>Automatically save work every 30 seconds</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About & Help -->
            <div class="bg-theme-secondary p-6 rounded-xl border-2 border-theme">
                <h2 class="text-xl font-bold mb-4">
                    <i class="fas fa-info text-cyan-400 mr-2"></i>
                    About AUTHORR AI
                </h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold mb-2">Platform Information</h3>
                        <ul class="text-sm space-y-1 text-theme-secondary">
                            <li>• Version: 2.5 Fixed Platform</li>
                            <li>• AI Model: GPT-4o-mini with TTS-1-HD</li>
                            <li>• Voice Options: 6 Professional AI Voices</li>
                            <li>• Image Generation: DALL-E 3 HD Quality</li>
                            <li>• Max Chapters: 25 per audiobook</li>
                            <li>• Max Words: 3,000 per chapter</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold mb-2">Support & Resources</h3>
                        <div class="space-y-2">
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-book mr-1"></i>User Guide
                            </button>
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-video mr-1"></i>Video Tutorials
                            </button>
                            <button class="btn-secondary w-full py-2 rounded text-sm">
                                <i class="fas fa-life-ring mr-1"></i>Contact Support
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-theme-secondary p-8 rounded-xl border-2 border-cyan-400 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p id="loadingText" class="text-lg font-semibold">Processing...</p>
        </div>
    </div>

    <script>
        // Global State Management
        let currentPage = 'dashboard';
        let storyData = {
            title: '',
            chapters: [],
            currentChapter: 0,
            settings: {
                chapterCount: 10,
                wordsPerChapter: 1000,
                genre: 'fiction-literary',
                tone: 'professional'
            }
        };
        
        // History management for undo/redo
        let editHistory = [];
        let historyIndex = -1;
        const maxHistorySize = 50;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateWordCount();
            setupAutoSave();
        });
        
        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            currentPage = pageId;
            
            // Transfer story data when navigating to narration
            if (pageId === 'narration') {
                transferStoryToNarration();
            }
        }
        
        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.classList.contains('theme-light')) {
                body.classList.remove('theme-light');
                body.classList.add('theme-dark');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('theme-dark');
                body.classList.add('theme-light');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }
        
        function setTheme(theme) {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.className = `theme-${theme}`;
            themeIcon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            localStorage.setItem('theme', theme);
        }
        
        function loadSettings() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Load API key if saved
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('openaiKey').value = apiKey;
            }
        }
        
        // Story Generation Functions
        async function generateChapterPlan() {
            const title = document.getElementById('bookTitle').value;
            const chapterCount = parseInt(document.getElementById('chapterCount').value);
            const wordsPerChapter = parseInt(document.getElementById('wordsPerChapter').value);
            const genre = document.getElementById('genre').value;
            const tone = document.getElementById('tone').value;
            const outline = document.getElementById('storyOutline').value;
            
            if (!title || !outline) {
                alert('Please enter a book title and story outline.');
                return;
            }
            
            showLoading('Generating comprehensive chapter plan...');
            
            try {
                // Enhanced AI API call simulation for chapter planning
                const chapterPlan = await simulateEnhancedChapterGeneration(title, chapterCount, genre, tone, outline);
                displayEnhancedChapterPlan(chapterPlan);
                
                // Update story data
                storyData.title = title;
                storyData.settings = { chapterCount, wordsPerChapter, genre, tone, outline };
                storyData.chapters = chapterPlan.map(chapter => ({ ...chapter, content: '' }));
                
                document.getElementById('generateAllBtn').disabled = false;
                hideLoading();
            } catch (error) {
                console.error('Chapter generation error:', error);
                alert('Failed to generate chapter plan. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedChapterGeneration(title, chapterCount, genre, tone, outline) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2500));
            
            const chapters = [];
            const detailedSummaries = generateDetailedSummaries(genre, tone, outline, chapterCount);
            const chapterTitles = generateChapterTitles(genre, chapterCount);
            
            for (let i = 1; i <= chapterCount; i++) {
                chapters.push({
                    number: i,
                    title: `Chapter ${i}: ${chapterTitles[i-1]}`,
                    summary: detailedSummaries[i-1],
                    wordTarget: parseInt(document.getElementById('wordsPerChapter').value),
                    editable: true,
                    status: 'ready'
                });
            }
            return chapters;
        }
        
        function generateDetailedSummaries(genre, tone, outline, chapterCount) {
            const summaries = {
                'fiction-mystery': [
                    'Introduce the detective protagonist and establish the mysterious crime that will drive the investigation forward. Set the scene and atmosphere.',
                    'The first clues emerge as the detective begins interviewing witnesses and examining evidence. Red herrings and false leads create complexity.',
                    'A breakthrough occurs when a crucial piece of evidence is discovered, but it only deepens the mystery and raises more disturbing questions.',
                    'The investigation takes a dangerous turn as someone attempts to stop the detective, suggesting the killer is still active and watching.',
                    'All the pieces of the puzzle begin to come together in a shocking revelation that changes everything the detective thought they knew.',
                    'The final confrontation between detective and killer, with the truth finally revealed and justice served in a dramatic climax.',
                    'Epilogue: The aftermath of the case and how the events have permanently changed both the detective and the community.',
                ],
                'fiction-romance': [
                    'The meet-cute: Two characters encounter each other in an unexpected and memorable way, with instant chemistry despite initial resistance.',
                    'Growing attraction develops despite external obstacles and personal misunderstandings that seem to keep them apart.',
                    'A moment of deep emotional connection brings them closer together, revealing vulnerable sides of both characters.',
                    'Major conflict arises - external pressures or internal fears threaten to tear the couple apart just as love begins to bloom.',
                    'The dark moment when all seems lost and true love appears impossible due to circumstances beyond their control.',
                    'The grand romantic gesture and heartfelt confession that overcomes all obstacles and wins back their one true love.',
                    'Happy ending with the couple united, planning their future together, and having grown as individuals through their journey.',
                ],
                'fiction-fantasy': [
                    'The ordinary world before magic enters the protagonist\'s life. Establish the character\'s mundane existence and hidden potential.',
                    'The call to adventure arrives when magical forces thrust the hero into an extraordinary quest they cannot refuse.',
                    'Meeting magical allies and discovering ancient powers or prophecies that reveal the true scope of the hero\'s destiny.',
                    'The first major challenge tests the hero\'s newfound abilities against dark forces, with mixed success and important lessons.',
                    'The ultimate confrontation with the primary antagonist in an epic battle between good and evil that will determine the fate of the realm.',
                    'Victory is achieved, but at great personal cost. The hero must make difficult sacrifices to save others and fulfill their destiny.',
                    'Return to the ordinary world, forever changed by the magical journey. The hero integrates their experiences into a new life.',
                ],
                'fiction-scifi': [
                    'Establish the futuristic or alien setting while introducing the protagonist and the scientific/technological premise.',
                    'The discovery or invention that changes everything, setting the main technological conflict into motion.',
                    'Exploring the implications and consequences of the new technology or alien contact on society and individuals.',
                    'Rising conflict as the protagonist must navigate political, ethical, or survival challenges in this new reality.',
                    'The climactic confrontation where science, technology, or first contact reaches a critical turning point.',
                    'Resolution of the technological crisis with wisdom gained about progress, humanity, or our place in the universe.',
                    'New equilibrium: How the world has changed and what the future now holds for humanity.',
                ]
            };
            
            const defaultSummaries = [
                'Setting the scene and introducing the main characters in their world, establishing the tone and central premise.',
                'The inciting incident occurs, disrupting the status quo and setting the main plot into unstoppable motion.',
                'Rising action as characters face their first major challenges, revealing personality and building relationships.',
                'Complications arise that deepen the conflict, raise the stakes, and test character resolve and relationships.',
                'The climax arrives - the turning point where everything hangs in the balance and characters face their greatest test.',
                'Falling action begins as the main conflict moves toward resolution and characters deal with consequences.',
                'Resolution and conclusion, tying up loose ends, showing character growth, and providing satisfying closure.',
            ];
            
            const genreSummaries = summaries[genre] || defaultSummaries;
            
            // Extend or customize summaries to match chapter count
            const result = [];
            for (let i = 0; i < chapterCount; i++) {
                if (i < genreSummaries.length) {
                    result.push(genreSummaries[i]);
                } else {
                    // Generate additional summaries for longer books
                    const baseIndex = i % genreSummaries.length;
                    result.push(`Chapter ${i + 1}: Continuing the ${genre.replace('-', ' ')} narrative with ${tone} tone, building toward the climactic conclusion.`);
                }
            }
            
            return result;
        }
        
        function generateChapterTitles(genre, chapterCount) {
            const titleTemplates = {
                'fiction-mystery': [
                    'The Crime Scene', 'First Clues', 'Witnesses Speak', 'Hidden Motives', 'False Leads', 
                    'Breaking Point', 'The Truth Emerges', 'Final Confrontation', 'Justice Served'
                ],
                'fiction-romance': [
                    'Unexpected Encounter', 'Growing Attraction', 'First Kiss', 'Complications', 
                    'Heartbreak', 'Realization', 'Grand Gesture', 'Forever Together'
                ],
                'fiction-fantasy': [
                    'The Calling', 'Into the Unknown', 'Ancient Powers', 'Dark Forces', 
                    'The Prophecy', 'Final Battle', 'Victory\'s Price', 'New Dawn'
                ],
                'fiction-scifi': [
                    'Discovery', 'First Contact', 'New Worlds', 'Alien Minds', 
                    'Technology\'s Edge', 'The Singularity', 'Evolution', 'Future Awakens'
                ]
            };
            
            const defaultTitles = [
                'Beginning', 'Rising Action', 'Development', 'Complication', 
                'Climax', 'Resolution', 'Conclusion'
            ];
            
            const titles = titleTemplates[genre] || defaultTitles;
            const result = [];
            
            for (let i = 0; i < chapterCount; i++) {
                if (i < titles.length) {
                    result.push(titles[i]);
                } else {
                    result.push(`Part ${i + 1}`);
                }
            }
            
            return result;
        }
        
        function displayEnhancedChapterPlan(chapters) {
            const planContainer = document.getElementById('chapterPlan');
            planContainer.innerHTML = chapters.map(chapter => `
                <div class="border border-theme p-3 rounded-lg bg-theme-primary" id="chapter-${chapter.number}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-sm editable-title" 
                            contenteditable="true" 
                            onblur="updateChapterTitle(${chapter.number}, this.textContent)"
                            data-original="${chapter.title}">${chapter.title}</h3>
                        <div class="flex space-x-1">
                            <button onclick="editChapter(${chapter.number})" class="btn-secondary px-2 py-1 rounded text-xs" title="Edit Chapter">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="generateSingleChapter(${chapter.number})" class="btn-primary px-2 py-1 rounded text-xs" title="Generate Story">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-theme-secondary mb-2 editable-summary" 
                       contenteditable="true" 
                       onblur="updateChapterSummary(${chapter.number}, this.textContent)"
                       data-original="${chapter.summary}">${chapter.summary}</p>
                    <div class="text-xs text-cyan-400 mb-1">Target: ${chapter.wordTarget} words</div>
                    <div class="chapter-status status-${chapter.status} text-xs" id="chapter-status-${chapter.number}">
                        Ready to generate story content
                    </div>
                </div>
            `).join('');
        }
        
        function updateChapterTitle(chapterNum, newTitle) {
            const chapterIndex = chapterNum - 1;
            if (storyData.chapters[chapterIndex]) {
                storyData.chapters[chapterIndex].title = newTitle.trim();
                console.log(`Updated chapter ${chapterNum} title:`, newTitle);
                showStatusMessage(`Chapter ${chapterNum} title updated`);
            }
        }
        
        function updateChapterSummary(chapterNum, newSummary) {
            const chapterIndex = chapterNum - 1;
            if (storyData.chapters[chapterIndex]) {
                storyData.chapters[chapterIndex].summary = newSummary.trim();
                console.log(`Updated chapter ${chapterNum} summary:`, newSummary);
                showStatusMessage(`Chapter ${chapterNum} summary updated`);
            }
        }
        
        function editChapter(chapterNum) {
            const chapterDiv = document.getElementById(`chapter-${chapterNum}`);
            const titleEl = chapterDiv.querySelector('.editable-title');
            const summaryEl = chapterDiv.querySelector('.editable-summary');
            
            // Highlight for editing
            titleEl.focus();
            titleEl.style.backgroundColor = 'rgba(120, 227, 254, 0.1)';
            summaryEl.style.backgroundColor = 'rgba(120, 227, 254, 0.1)';
            
            // Show edit instruction
            showStatusMessage(`Editing Chapter ${chapterNum} - Click outside when done`);
            
            // Remove highlight after editing
            setTimeout(() => {
                titleEl.style.backgroundColor = '';
                summaryEl.style.backgroundColor = '';
            }, 5000);
        }
        
        async function generateAllChapters() {
            if (!storyData.chapters.length) {
                alert('Please generate a chapter plan first.');
                return;
            }
            
            showLoading('Generating all chapter stories...');
            
            try {
                let allContent = '';
                for (let i = 0; i < storyData.chapters.length; i++) {
                    updateLoadingText(`Creating story for chapter ${i + 1} of ${storyData.chapters.length}...`);
                    
                    // Update chapter status
                    updateChapterStatus(i + 1, 'generating', 'Generating story content...');
                    
                    const content = await generateSingleChapter(i + 1);
                    storyData.chapters[i].content = content;
                    allContent += content + '\n\n';
                    
                    // Update chapter status
                    updateChapterStatus(i + 1, 'complete', `Story complete (${countWords(content)} words)`);
                    
                    // Small delay for visual feedback
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Display all content in editor
                const editor = document.getElementById('storyEditor');
                editor.value = allContent;
                updateWordCount();
                saveToHistory();
                
                hideLoading();
                showStatusMessage(`Successfully generated ${storyData.chapters.length} chapters!`);
                
            } catch (error) {
                console.error('Chapter generation error:', error);
                alert('Failed to generate all chapters. Please try again.');
                hideLoading();
            }
        }
        
        function updateChapterStatus(chapterNum, status, message) {
            const statusEl = document.getElementById(`chapter-status-${chapterNum}`);
            if (statusEl) {
                statusEl.className = `chapter-status status-${status} text-xs`;
                statusEl.textContent = message;
            }
        }
        
        async function generateSingleChapter(chapterNumber) {
            const chapterIndex = chapterNumber - 1;
            if (!storyData.chapters[chapterIndex]) return '';
            
            const chapter = storyData.chapters[chapterIndex];
            
            try {
                updateChapterStatus(chapterNumber, 'generating', 'Creating story content...');
                
                // Enhanced content generation
                const content = await simulateEnhancedContentGeneration(chapter, storyData.settings);
                storyData.chapters[chapterIndex].content = content;
                
                // If this is the current chapter being viewed, update editor
                if (storyData.currentChapter === chapterIndex) {
                    document.getElementById('storyEditor').value = content;
                    updateWordCount();
                    saveToHistory();
                }
                
                updateChapterStatus(chapterNumber, 'complete', `Complete (${countWords(content)} words)`);
                return content;
                
            } catch (error) {
                console.error('Single chapter generation error:', error);
                updateChapterStatus(chapterNumber, 'ready', 'Error - Ready to retry');
                throw error;
            }
        }
        
        async function simulateEnhancedContentGeneration(chapter, settings) {
            // Simulate AI API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const { title, summary, wordTarget } = chapter;
            const { genre, tone } = settings;
            
            // Generate more realistic content based on chapter info
            let content = `${title}\n\n`;
            
            // Generate introduction
            content += generateChapterIntroduction(summary, genre, tone) + '\n\n';
            
            // Calculate paragraphs needed (aim for 150-200 words per paragraph)
            const wordsPerParagraph = 150;
            const paragraphCount = Math.ceil(wordTarget / wordsPerParagraph);
            
            // Generate main content paragraphs
            for (let i = 0; i < paragraphCount - 1; i++) {
                content += generateContentParagraph(genre, tone, summary, i + 1) + '\n\n';
            }
            
            // Generate conclusion paragraph
            content += generateChapterConclusion(summary, genre, tone);
            
            return content.trim();
        }
        
        function generateChapterIntroduction(summary, genre, tone) {
            const intros = {
                'fiction-mystery': [
                    'The morning mist hung heavy over the crime scene as Detective Morrison arrived, coffee still steaming in her hand. What she was about to discover would change everything she thought she knew about this case.',
                    'The call came at 3:47 AM, jarring Detective Chen from a restless sleep. Another body had been found, and the pattern was becoming disturbingly clear.',
                    'Something was wrong with this picture. Detective Rodriguez stood at the edge of the scene, her trained eye catching details that others had missed.'
                ],
                'fiction-romance': [
                    'Sarah had always believed that love at first sight was a myth—until she walked into that coffee shop on a rainy Tuesday morning and saw him.',
                    'The wedding invitation fell from Emma\'s hands like autumn leaves, each word on the elegant cardstock a reminder of what she had lost.',
                    'Marcus had sworn off relationships after his last heartbreak, but when she smiled at him across the bookstore aisle, all his carefully built walls began to crumble.'
                ]
            };
            
            const defaultIntros = [
                'The chapter begins with our protagonist facing a new challenge that will test their resolve and change their perspective.',
                'As events unfold, the characters find themselves in a situation that demands courage and quick thinking.',
                'The story takes an unexpected turn as hidden truths begin to surface and relationships are put to the test.'
            ];
            
            const genreIntros = intros[genre] || defaultIntros;
            return genreIntros[Math.floor(Math.random() * genreIntros.length)];
        }
        
        function generateContentParagraph(genre, tone, summary, position) {
            const paragraphs = {
                'fiction-mystery': [
                    'The evidence pointed in multiple directions, each clue seeming to contradict the last. The detective methodically examined each piece, knowing that somewhere in this puzzle lay the truth.',
                    'Witnesses provided conflicting accounts, their memories clouded by fear and confusion. Separating fact from fiction would require patience and skill.',
                    'A breakthrough came from an unexpected source—a detail so small that others had overlooked it entirely. Sometimes the smallest threads unravel the biggest mysteries.',
                    'The investigation took a darker turn as threats began to surface. Someone was desperate to keep these secrets buried, but the truth had a way of demanding to be heard.'
                ],
                'fiction-romance': [
                    'Their conversations flowed like music, each word building a bridge between two hearts that had been waiting to find each other.',
                    'The obstacles seemed insurmountable—family expectations, career demands, and the fear of vulnerability all conspired to keep them apart.',
                    'In quiet moments together, they discovered that love wasn\'t just about grand gestures but about the small, tender moments that made life meaningful.',
                    'Misunderstandings clouded their judgment, and pride kept them from speaking the words that could heal the growing distance between them.'
                ]
            };
            
            const defaultParagraphs = [
                'The characters navigated through challenges that tested their beliefs and forced them to grow beyond their comfort zones.',
                'Relationships deepened and evolved as trust was built through shared experiences and mutual support during difficult times.',
                'Conflicts arose that revealed the true nature of each character, showing both their strengths and their vulnerabilities.',
                'Resolution began to emerge as the characters learned to work together and understand each other\'s perspectives.'
            ];
            
            const genreParagraphs = paragraphs[genre] || defaultParagraphs;
            return genreParagraphs[position % genreParagraphs.length];
        }
        
        function generateChapterConclusion(summary, genre, tone) {
            const conclusions = {
                'fiction-mystery': [
                    'As the chapter drew to a close, one crucial question remained unanswered, its significance growing like a shadow over the investigation.',
                    'The detective gathered the pieces of evidence, each one forming part of a larger picture that was finally beginning to emerge from the darkness.',
                    'With new leads to follow and fresh determination, the investigation moved forward, bringing both hope and trepidation for what lay ahead.'
                ],
                'fiction-romance': [
                    'As they parted ways that evening, both carried with them a new understanding of what their hearts truly desired.',
                    'The chapter ended with a promise—spoken or unspoken—that their story was far from over.',
                    'Love had planted seeds in their hearts, and though challenges lay ahead, they both sensed that something beautiful was beginning to grow.'
                ]
            };
            
            const defaultConclusions = [
                'The chapter concluded with new possibilities on the horizon and a sense that the characters had grown from their experiences.',
                'As events came to a temporary resolution, the stage was set for even greater challenges and opportunities ahead.',
                'The story paused here, but the journey continued, with each character carrying forward the lessons learned and the bonds formed.'
            ];
            
            const genreConclusions = conclusions[genre] || defaultConclusions;
            return genreConclusions[Math.floor(Math.random() * genreConclusions.length)];
        }
        
        // Enhanced AI Writing Tools
        async function expandStory() {
            const editor = document.getElementById('storyEditor');
            const selectedText = getSelectedText(editor);
            const currentText = selectedText || editor.value;
            
            if (!currentText.trim()) {
                alert('Please enter some text or select text to expand.');
                return;
            }
            
            showLoading('Expanding story with rich details...');
            
            try {
                const expandedText = await simulateEnhancedExpansion(currentText);
                
                if (selectedText) {
                    replaceSelectedText(editor, expandedText);
                } else {
                    editor.value = expandedText;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Story expanded successfully!');
            } catch (error) {
                console.error('Story expansion error:', error);
                alert('Failed to expand story. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedExpansion(text) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const expansions = [
                '\n\nThe atmosphere grew thick with anticipation as details previously hidden began to emerge. Every shadow seemed to hold secrets, every whisper carried weight that would influence the events to come.',
                '\n\nCharacter motivations deepened as their past experiences shaped their current actions. The complexity of human emotion painted layers of meaning into every gesture and spoken word.',
                '\n\nThe setting came alive with sensory details—the way light filtered through windows, the sound of footsteps on different surfaces, the subtle scents that triggered powerful memories.',
                '\n\nDialogue revealed subtext as characters said one thing while meaning another. The space between words held as much significance as the words themselves.'
            ];
            
            return text + expansions[Math.floor(Math.random() * expansions.length)];
        }
        
        async function improveStory() {
            const editor = document.getElementById('storyEditor');
            const selectedText = getSelectedText(editor);
            const currentText = selectedText || editor.value;
            
            if (!currentText.trim()) {
                alert('Please enter some text or select text to improve.');
                return;
            }
            
            showLoading('Enhancing story quality and flow...');
            
            try {
                const improvedText = await simulateEnhancedImprovement(currentText);
                
                if (selectedText) {
                    replaceSelectedText(editor, improvedText);
                } else {
                    editor.value = improvedText;
                }
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Story improved with enhanced writing!');
            } catch (error) {
                console.error('Story improvement error:', error);
                alert('Failed to improve story. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedImprovement(text) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            // Enhanced text improvement simulation
            return text.replace(/\b(said)\b/g, 'declared')
                      .replace(/\b(went)\b/g, 'proceeded')
                      .replace(/\b(good)\b/g, 'excellent')
                      .replace(/\b(bad)\b/g, 'troubling')
                      .replace(/\b(big)\b/g, 'substantial')
                      .replace(/\b(small)\b/g, 'delicate');
        }
        
        async function addDialogue() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Crafting meaningful dialogue...');
            
            try {
                const dialogue = await simulateEnhancedDialogue();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + dialogue + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                // Position cursor after inserted dialogue
                editor.selectionStart = editor.selectionEnd = insertionPoint + dialogue.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Dialogue added with character depth!');
            } catch (error) {
                console.error('Dialogue generation error:', error);
                alert('Failed to add dialogue. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedDialogue() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const dialogues = [
                '"I never thought I\'d see you again," she whispered, her voice carrying years of unspoken emotion.\n\nHis eyes softened as he replied, "Some connections transcend time and distance. I\'ve been waiting for this moment."',
                '"The truth isn\'t always what we want to hear," the mentor said, choosing each word carefully.\n\n"But it\'s what I need to know," the student responded with newfound determination. "I\'m ready for whatever comes next."',
                '"This changes everything we thought we knew," the detective muttered, studying the evidence.\n\n"Maybe that\'s exactly what we needed," her partner replied. "Sometimes you have to break the old patterns to see clearly."'
            ];
            return dialogues[Math.floor(Math.random() * dialogues.length)];
        }
        
        async function addDescription() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Adding vivid descriptive passages...');
            
            try {
                const description = await simulateEnhancedDescription();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + description + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + description.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Rich descriptions added to enhance atmosphere!');
            } catch (error) {
                console.error('Description generation error:', error);
                alert('Failed to add description. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedDescription() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const descriptions = [
                'The library stood like a cathedral of knowledge, its towering shelves casting long shadows in the afternoon light. Dust particles danced in golden beams, and the musty scent of aged paper whispered stories of countless readers who had walked these halls before.',
                'Rain drummed against the windows with increasing intensity, each drop creating rivulets that distorted the city lights beyond. The storm seemed to mirror the turbulence in her heart as she faced the decision that would change everything.',
                'The old mansion creaked with the weight of its secrets, every floorboard a potential betrayer of footsteps. Moonlight filtered through heavy curtains, painting silver patterns on walls that had witnessed decades of human drama.',
                'The market bustled with life—vendors calling their wares, children weaving between stalls, and the rich aroma of spices creating an intoxicating blend that spoke of distant lands and ancient traditions.'
            ];
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }
        
        async function createTransition() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Creating smooth narrative transitions...');
            
            try {
                const transition = await simulateEnhancedTransition();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + transition + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + transition.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Smooth transition created to connect story elements!');
            } catch (error) {
                console.error('Transition generation error:', error);
                alert('Failed to create transition. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedTransition() {
            await new Promise(resolve => setTimeout(resolve, 1200));
            const transitions = [
                'Time seemed to fold in on itself as the significance of recent events began to crystallize. What had seemed like separate incidents now revealed themselves as pieces of a larger, more complex puzzle.',
                'The following days blurred together in a cascade of revelations and realizations. Each new discovery built upon the last, creating momentum that carried the story forward with unstoppable force.',
                'As the sun set on that momentous day, a new chapter began—one that would test everything the characters thought they knew about themselves and each other.',
                'The shift was subtle at first, like the changing of seasons. But as hours turned to days, it became clear that nothing would ever be quite the same again.'
            ];
            return transitions[Math.floor(Math.random() * transitions.length)];
        }
        
        async function addConflict() {
            const editor = document.getElementById('storyEditor');
            const insertionPoint = editor.selectionStart;
            
            showLoading('Introducing compelling conflict elements...');
            
            try {
                const conflict = await simulateEnhancedConflict();
                
                const currentText = editor.value;
                const newText = currentText.slice(0, insertionPoint) + '\n\n' + conflict + '\n\n' + currentText.slice(insertionPoint);
                editor.value = newText;
                
                editor.selectionStart = editor.selectionEnd = insertionPoint + conflict.length + 4;
                editor.focus();
                
                updateWordCount();
                saveToHistory();
                hideLoading();
                showStatusMessage('Compelling conflict added to drive the narrative!');
            } catch (error) {
                console.error('Conflict generation error:', error);
                alert('Failed to add conflict. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedConflict() {
            await new Promise(resolve => setTimeout(resolve, 1500));
            const conflicts = [
                'An unexpected message arrived that challenged everything they believed about the situation. The implications were staggering, forcing them to question not just their assumptions, but their fundamental understanding of what was at stake.',
                'Long-buried tensions finally erupted to the surface, creating fractures in relationships that had seemed unshakeable. Trust, once broken, would not be easily repaired—if it could be repaired at all.',
                'The deadline loomed like a storm on the horizon, and with each passing hour, the options grew fewer and the consequences more severe. Difficult choices lay ahead, and there was no guarantee that everyone would emerge unscathed.',
                'Hidden agendas came to light, revealing that allies might be enemies and enemies might hold the key to salvation. In this new landscape of shifting loyalties, navigation required both courage and cunning.'
            ];
            return conflicts[Math.floor(Math.random() * conflicts.length)];
        }
        
        // Utility Functions
        function getSelectedText(element) {
            const start = element.selectionStart;
            const end = element.selectionEnd;
            return start !== end ? element.value.substring(start, end) : '';
        }
        
        function replaceSelectedText(element, newText) {
            const start = element.selectionStart;
            const end = element.selectionEnd;
            const currentText = element.value;
            
            element.value = currentText.substring(0, start) + newText + currentText.substring(end);
            
            // Position cursor at end of replaced text
            element.selectionStart = element.selectionEnd = start + newText.length;
            element.focus();
        }
        
        // Enhanced word counting function
        function countWords(text) {
            if (!text || typeof text !== 'string') return 0;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            return text.trim() === '' ? 0 : words.length;
        }
        
        function updateWordCount() {
            const editor = document.getElementById('storyEditor');
            const text = editor.value;
            const wordCount = countWords(text);
            
            const wordCountElement = document.getElementById('wordCount');
            if (wordCountElement) {
                wordCountElement.textContent = `${wordCount.toLocaleString()} words`;
                
                // Update color based on target
                const target = storyData.settings?.wordsPerChapter || 1000;
                if (wordCount >= target) {
                    wordCountElement.style.color = '#10b981'; // green
                } else if (wordCount >= target * 0.7) {
                    wordCountElement.style.color = '#f59e0b'; // yellow
                } else {
                    wordCountElement.style.color = '#78e3fe'; // cyan
                }
            }
        }
        
        // Enhanced history management
        function saveToHistory() {
            const editor = document.getElementById('storyEditor');
            const currentState = editor.value;
            
            // Don't save if it's the same as the last state
            if (editHistory.length > 0 && editHistory[historyIndex] === currentState) {
                return;
            }
            
            // Remove future history if we're not at the end
            if (historyIndex < editHistory.length - 1) {
                editHistory = editHistory.slice(0, historyIndex + 1);
            }
            
            // Add new state to history
            editHistory.push(currentState);
            
            // Limit history size
            if (editHistory.length > maxHistorySize) {
                editHistory.shift();
            } else {
                historyIndex++;
            }
            
            updateHistoryButtons();
        }
        
        function undoEdit() {
            if (historyIndex > 0) {
                historyIndex--;
                const editor = document.getElementById('storyEditor');
                editor.value = editHistory[historyIndex];
                updateWordCount();
                updateHistoryButtons();
                showStatusMessage('Undo successful');
            }
        }
        
        function redoEdit() {
            if (historyIndex < editHistory.length - 1) {
                historyIndex++;
                const editor = document.getElementById('storyEditor');
                editor.value = editHistory[historyIndex];
                updateWordCount();
                updateHistoryButtons();
                showStatusMessage('Redo successful');
            }
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= editHistory.length - 1;
        }
        
        function saveStory() {
            const editor = document.getElementById('storyEditor');
            const content = editor.value;
            
            // Save to localStorage with timestamp
            const saveData = {
                content: content,
                storyData: storyData,
                timestamp: new Date().toISOString(),
                wordCount: countWords(content)
            };
            
            localStorage.setItem('authorr_story_save', JSON.stringify(saveData));
            localStorage.setItem('authorr_story_content', content);
            localStorage.setItem('authorr_story_data', JSON.stringify(storyData));
            
            // Visual feedback
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
            saveBtn.classList.add('success-border');
            
            showStatusMessage(`Story saved! (${countWords(content)} words)`);
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('success-border');
            }, 2000);
        }
        
        function setupAutoSave() {
            const editor = document.getElementById('storyEditor');
            if (editor) {
                let autoSaveTimer;
                
                editor.addEventListener('input', () => {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        if (document.getElementById('autoSave').checked) {
                            saveStory();
                        }
                    }, 30000);
                });
            }
        }
        
        // Status messaging system
        function showStatusMessage(message) {
            // Create or update status message element
            let statusEl = document.getElementById('statusMessage');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'statusMessage';
                statusEl.className = 'fixed bottom-4 right-4 bg-cyan-400 text-black px-4 py-2 rounded-lg font-semibold z-50 transition-all duration-300';
                document.body.appendChild(statusEl);
            }
            
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.opacity = '1';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // Narration Functions
        function transferStoryToNarration() {
            const editor = document.getElementById('storyEditor');
            const content = editor.value;
            
            if (content.trim()) {
                storyData.currentContent = content;
                
                // Update preview text with first paragraph
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const previewText = sentences.slice(0, 2).join('. ') + '.';
                document.getElementById('previewText').value = previewText;
                
                showStatusMessage('Story transferred to narration page');
            }
        }
        
        async function previewVoice() {
            const previewText = document.getElementById('previewText').value;
            const selectedVoice = document.getElementById('voiceSelection').value;
            
            if (!previewText.trim()) {
                alert('Please enter text to preview.');
                return;
            }
            
            showLoading(`Generating voice preview with ${selectedVoice}...`);
            
            try {
                await simulateVoicePreview(previewText, selectedVoice);
                hideLoading();
                showStatusMessage(`Voice preview for "${selectedVoice}" generated successfully!`);
            } catch (error) {
                console.error('Voice preview error:', error);
                alert('Failed to generate voice preview. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateVoicePreview(text, voice) {
            // Simulate TTS API call
            await new Promise(resolve => setTimeout(resolve, 2500));
            console.log(`Generated preview with voice: ${voice}, text: ${text.substring(0, 50)}...`);
        }
        
        async function generateNarration() {
            const content = storyData.currentContent || document.getElementById('storyEditor').value;
            const selectedVoice = document.getElementById('voiceSelection').value;
            const speechRate = document.getElementById('speechRate').value;
            const audioFormat = document.getElementById('audioFormat').value;
            
            if (!content.trim()) {
                alert('No story content found. Please create content in the workspace first.');
                return;
            }
            
            document.getElementById('narrationProgress').classList.remove('hidden');
            showProgressBar();
            
            try {
                await simulateFullNarrationGeneration(content, selectedVoice, speechRate, audioFormat);
                displayEnhancedAudioResults(selectedVoice, audioFormat);
                showStatusMessage('Full narration generated successfully!');
            } catch (error) {
                console.error('Narration generation error:', error);
                alert('Failed to generate narration. Please try again.');
            } finally {
                document.getElementById('narrationProgress').classList.add('hidden');
            }
        }
        
        async function simulateFullNarrationGeneration(content, voice, rate, format) {
            // Simulate progress through content
            const chapters = storyData.chapters.length || 5;
            
            for (let i = 0; i < chapters; i++) {
                const progress = ((i + 1) / chapters) * 100;
                updateProgressBar(progress);
                updateLoadingText(`Generating audio for chapter ${i + 1} of ${chapters} with ${voice} voice...`);
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        }
        
        function showProgressBar() {
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
        }
        
        function updateProgressBar(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
        }
        
        function displayEnhancedAudioResults(voice, format) {
            const resultsContainer = document.getElementById('audioResults');
            const chapterCount = storyData.chapters.length || 5;
            
            let resultsHTML = `
                <div class="bg-theme-primary p-4 rounded-lg border border-theme">
                    <h3 class="font-semibold mb-3">Generated Audio Files (${voice} voice, ${format} format)</h3>
                    <div class="space-y-2">
            `;
            
            for (let i = 1; i <= chapterCount; i++) {
                resultsHTML += `
                    <div class="flex justify-between items-center p-2 bg-theme-secondary rounded">
                        <span>Chapter ${i} - ${storyData.chapters[i-1]?.title || `Part ${i}`}</span>
                        <div class="space-x-2">
                            <button class="btn-secondary px-2 py-1 rounded text-xs">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="btn-primary px-2 py-1 rounded text-xs">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                `;
            }
            
            resultsHTML += `
                    </div>
                    <div class="mt-4 text-center">
                        <button class="btn-primary px-6 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>Download All Audio Files
                        </button>
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // Book Cover Generation
        async function generateCover() {
            const style = document.getElementById('coverStyle').value;
            const description = document.getElementById('coverDescription').value;
            const title = document.getElementById('bookTitle').value || storyData.title || 'Untitled Book';
            
            if (!description.trim() && !title) {
                alert('Please enter a cover description or book title.');
                return;
            }
            
            showLoading('Creating HD book cover with DALL-E 3...');
            
            try {
                const coverUrl = await simulateEnhancedCoverGeneration(style, description, title);
                displayGeneratedCover(coverUrl);
                hideLoading();
                showStatusMessage('Professional book cover generated!');
            } catch (error) {
                console.error('Cover generation error:', error);
                alert('Failed to generate book cover. Please try again.');
                hideLoading();
            }
        }
        
        async function simulateEnhancedCoverGeneration(style, description, title) {
            // Simulate DALL-E 3 API call
            await new Promise(resolve => setTimeout(resolve, 4000));
            
            // Create a more realistic placeholder that reflects the inputs
            const encodedTitle = encodeURIComponent(title);
            const styleColors = {
                'modern': '78e3fe/000000',
                'classic': '8B4513/F5F5DC',
                'mysterious': '2F2F2F/FF6B6B',
                'romantic': 'FFB6C1/8B008B',
                'fantasy': '4B0082/FFD700',
                'scifi': '191970/00FFFF',
                'horror': '8B0000/000000',
                'children': 'FF69B4/FFFF00'
            };
            
            const colors = styleColors[style] || '78e3fe/000000';
            return `https://via.placeholder.com/400x600/${colors}?text=${encodedTitle}`;
        }
        
        function displayGeneratedCover(imageUrl) {
            const coverPreview = document.getElementById('coverPreview');
            const generatedCover = document.getElementById('generatedCover');
            
            generatedCover.src = imageUrl;
            generatedCover.alt = `Generated book cover for ${storyData.title || 'your book'}`;
            coverPreview.classList.remove('hidden');
        }
        
        async function regenerateCover() {
            showStatusMessage('Regenerating book cover...');
            generateCover();
        }
        
        function downloadCover() {
            const coverImage = document.getElementById('generatedCover');
            const link = document.createElement('a');
            link.href = coverImage.src;
            link.download = `${storyData.title || 'Book'}_Cover.png`;
            link.click();
            showStatusMessage('Book cover download initiated');
        }
        
        // Configuration Functions
        async function testApiConnection() {
            const apiKey = document.getElementById('openaiKey').value;
            
            if (!apiKey.trim()) {
                alert('Please enter your OpenAI API key.');
                return;
            }
            
            showLoading('Testing OpenAI API connection...');
            
            try {
                // Simulate API test
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Save API key
                localStorage.setItem('openai_api_key', apiKey);
                
                hideLoading();
                showStatusMessage('API connection successful! Key saved.');
            } catch (error) {
                console.error('API test error:', error);
                alert('API connection failed. Please check your key and try again.');
                hideLoading();
            }
        }
        
        // Utility Functions
        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        // Initialize word count tracking and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const editor = document.getElementById('storyEditor');
                if (editor) {
                    // Real-time word count updates
                    editor.addEventListener('input', updateWordCount);
                    editor.addEventListener('keyup', updateWordCount);
                    editor.addEventListener('paste', () => setTimeout(updateWordCount, 10));
                    
                    // Initialize history with empty state
                    saveToHistory();
                    updateHistoryButtons();
                    
                    // Load any saved content
                    const savedContent = localStorage.getItem('authorr_story_content');
                    if (savedContent) {
                        editor.value = savedContent;
                        updateWordCount();
                        showStatusMessage('Previously saved content restored');
                    }
                }
                
                // Load saved story data
                const savedData = localStorage.getItem('authorr_story_data');
                if (savedData) {
                    try {
                        storyData = JSON.parse(savedData);
                        if (storyData.title) {
                            document.getElementById('bookTitle').value = storyData.title;
                        }
                    } catch (e) {
                        console.warn('Failed to load saved story data:', e);
                    }
                }
            }, 100);
        });

        // Real-time Word Count functionality
        function setupWordCount() {
            const storyOutline = document.getElementById('storyOutline');
            const wordCountDisplay = document.getElementById('outlineWordCount');
            
            if (storyOutline && wordCountDisplay) {
                storyOutline.addEventListener('input', function() {
                    const text = this.value.trim();
                    const wordCount = text === '' ? 0 : text.split(/\s+/).length;
                    wordCountDisplay.textContent = `${wordCount} words`;
                });
            }
        }

        // Voice Cloning Station Functions
        function handleVoiceDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            handleVoiceFiles(files);
        }
        
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function handleVoiceFiles(files) {
            const validTypes = ['audio/mp3', 'audio/wav', 'audio/m4a'];
            const validFiles = Array.from(files).filter(file => 
                validTypes.includes(file.type) || 
                validTypes.some(type => file.name.toLowerCase().endsWith(type.split('/')[1]))
            );
            
            if (validFiles.length > 0) {
                console.log('Voice files selected:', validFiles.map(f => f.name));
                showNotification(`${validFiles.length} voice sample(s) selected for cloning`, 'success');
            } else {
                showNotification('Please select valid audio files (.mp3, .wav, .m4a)', 'error');
            }
        }
        
        function initiateVoiceClone() {
            const uploadInput = document.getElementById('voiceUpload');
            const files = uploadInput.files;
            
            if (files.length === 0) {
                showNotification('Please select voice samples first', 'error');
                return;
            }
            
            // Show progress animation
            const progressDiv = document.getElementById('cloningProgress');
            const progressBar = document.getElementById('cloningBar');
            const progressPercent = document.getElementById('cloningPercent');
            
            progressDiv.classList.remove('hidden');
            
            // Simulate cloning progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        showNotification('Voice clone created successfully!', 'success');
                    }, 1000);
                }
            }, 500);
        }
        
        // Setup word count monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            const voiceUpload = document.getElementById('voiceUpload');
            if (voiceUpload) {
                voiceUpload.addEventListener('change', function() {
                    handleVoiceFiles(this.files);
                });
            }
            
            // Setup word count monitoring
            setupWordCount();
        });

        // Platform Template Functions
        const platformDimensions = {
            'audible': { width: 2400, height: 2400, name: 'Audible' },
            'spotify': { width: 3000, height: 3000, name: 'Spotify' },
            'apple': { width: 3000, height: 3000, name: 'Apple Podcasts' },
            'google': { width: 2400, height: 2400, name: 'Google Play' },
            'overdrive': { width: 1800, height: 2700, name: 'OverDrive' },
            'universal': { width: 2400, height: 2400, name: 'Universal' }
        };

        function selectPlatformTemplate(platform) {
            const platformSelect = document.getElementById('selectedPlatform');
            const dimensionDisplay = document.getElementById('dimensionDisplay');
            
            if (platformSelect) {
                platformSelect.value = platform;
            }
            
            const dimensions = platformDimensions[platform];
            if (dimensionDisplay && dimensions) {
                dimensionDisplay.textContent = `${dimensions.width}×${dimensions.height}px`;
            }
            
            // Visual feedback
            document.querySelectorAll('.platform-template').forEach(btn => {
                btn.classList.remove('border-cyan-400', 'bg-cyan-900');
            });
            
            const selectedBtn = document.querySelector(`[onclick="selectPlatformTemplate('${platform}')"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('border-cyan-400', 'bg-cyan-900');
            }
            
            showNotification(`Selected ${dimensions.name} template (${dimensions.width}×${dimensions.height}px)`, 'success');
        }

        // OpenAI DALL-E Cover Generation Functions
        async function generateAICover() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key in the Config section first', 'error');
                return;
            }

            const title = document.getElementById('coverTitle')?.value?.trim();
            const author = document.getElementById('coverAuthor')?.value?.trim();
            const subtitle = document.getElementById('coverSubtitle')?.value?.trim();
            const description = document.getElementById('coverDescription')?.value?.trim();
            const style = document.getElementById('coverStyle')?.value || 'modern';
            const artStyle = document.getElementById('artStyle')?.value || 'digital-art';
            const platform = document.getElementById('selectedPlatform')?.value || 'universal';
            const quality = document.getElementById('imageQuality')?.value || 'hd';

            if (!title) {
                showNotification('Please enter a book title', 'error');
                return;
            }

            if (!description) {
                showNotification('Please provide a visual description for the cover', 'error');
                return;
            }

            // Show progress
            const progressDiv = document.getElementById('coverGenerationProgress');
            const progressBar = document.getElementById('coverProgressBar');
            const stepText = document.getElementById('generationStep');
            const progressMessage = document.getElementById('progressMessage');
            
            progressDiv.classList.remove('hidden');
            
            const steps = [
                'Analyzing design requirements...',
                'Processing with DALL-E AI...',
                'Generating high-quality artwork...',
                'Optimizing for platform requirements...',
                'Finalizing cover design...'
            ];

            let currentStep = 0;
            const stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    stepText.textContent = steps[currentStep];
                    progressBar.style.width = `${(currentStep + 1) * 20}%`;
                    currentStep++;
                }
            }, 2000);

            // Build comprehensive prompt
            const platformInfo = platformDimensions[platform];
            const prompt = buildCoverPrompt(title, author, subtitle, description, style, artStyle, platformInfo);

            try {
                progressMessage.textContent = 'Connecting to OpenAI DALL-E API...';
                
                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: quality === 'hd' ? '1792x1024' : '1024x1024',
                        quality: quality,
                        style: 'vivid'
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const imageUrl = data.data[0].url;

                clearInterval(stepInterval);
                progressBar.style.width = '100%';
                stepText.textContent = 'Cover generated successfully!';

                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    displayGeneratedCover(imageUrl, platform);
                }, 1500);

            } catch (error) {
                clearInterval(stepInterval);
                progressDiv.classList.add('hidden');
                console.error('Cover generation error:', error);
                showNotification(`Failed to generate cover: ${error.message}`, 'error');
            }
        }

        function buildCoverPrompt(title, author, subtitle, description, style, artStyle, platformInfo) {
            let prompt = `Create a professional book cover in ${artStyle} style with ${style} aesthetic. `;
            prompt += `The book title is "${title}" by ${author}. `;
            
            if (subtitle) {
                prompt += `Subtitle: "${subtitle}". `;
            }
            
            prompt += `Visual description: ${description}. `;
            prompt += `The cover should be optimized for ${platformInfo.name} (${platformInfo.width}x${platformInfo.height} pixels). `;
            prompt += `Include clear, readable typography for the title and author name. `;
            prompt += `The design should be eye-catching, professional, and genre-appropriate. `;
            prompt += `Ensure high contrast and readability at thumbnail sizes. `;
            prompt += `No explicit content, copyright violations, or text overlay issues.`;

            return prompt;
        }

        function displayGeneratedCover(imageUrl, platform) {
            const coverPreview = document.getElementById('coverPreview');
            const generatedCover = document.getElementById('generatedCover');
            const placeholderPreview = document.getElementById('placeholderPreview');
            const dimensionDisplay = document.getElementById('dimensionDisplay');
            
            generatedCover.src = imageUrl;
            
            const dimensions = platformDimensions[platform];
            if (dimensionDisplay && dimensions) {
                dimensionDisplay.textContent = `${dimensions.width}×${dimensions.height}px`;
            }
            
            placeholderPreview.classList.add('hidden');
            coverPreview.classList.remove('hidden');
            
            showNotification('AI book cover generated successfully!', 'success');
        }

        async function regenerateAICover() {
            showNotification('Regenerating cover with new AI variations...', 'info');
            setTimeout(() => {
                generateAICover();
            }, 500);
        }

        async function createVariations() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            const generatedCover = document.getElementById('generatedCover');
            if (!generatedCover.src) {
                showNotification('Please generate a cover first', 'error');
                return;
            }

            showNotification('Creating AI variations of your cover...', 'info');
            
            try {
                // Note: DALL-E 3 doesn't support variations, so we'll regenerate with slight prompt modifications
                const variations = [];
                const basePrompt = document.getElementById('coverDescription')?.value || '';
                
                const promptVariations = [
                    basePrompt + ' with warmer color palette',
                    basePrompt + ' with cooler tones',
                    basePrompt + ' with different composition'
                ];

                // Generate multiple variations (simplified for demo)
                for (let i = 0; i < 2; i++) {
                    // Simulate variation generation
                    setTimeout(() => {
                        addCoverVariation(generatedCover.src, i + 1);
                    }, (i + 1) * 1000);
                }
                
                document.getElementById('coverVariations').classList.remove('hidden');
                
            } catch (error) {
                console.error('Variation generation error:', error);
                showNotification('Failed to create variations', 'error');
            }
        }

        function addCoverVariation(imageUrl, index) {
            const variationsGrid = document.getElementById('variationsGrid');
            const variationDiv = document.createElement('div');
            variationDiv.className = 'cover-variation p-2 rounded-lg border border-theme cursor-pointer hover:border-cyan-400 transition-colors';
            variationDiv.innerHTML = `
                <img src="${imageUrl}" alt="Cover Variation ${index}" class="w-full rounded">
                <button onclick="selectVariation(this)" class="w-full mt-2 btn-secondary text-xs py-1">
                    Use This Version
                </button>
            `;
            variationsGrid.appendChild(variationDiv);
        }

        function selectVariation(button) {
            const img = button.parentElement.querySelector('img');
            const mainCover = document.getElementById('generatedCover');
            mainCover.src = img.src;
            showNotification('Cover variation selected!', 'success');
        }

        function downloadCover() {
            const coverImg = document.getElementById('generatedCover');
            if (!coverImg.src) {
                showNotification('No cover to download', 'error');
                return;
            }

            const platform = document.getElementById('selectedPlatform')?.value || 'universal';
            const title = document.getElementById('coverTitle')?.value || 'book-cover';
            
            downloadImage(coverImg.src, `${title}-${platform}-cover.png`);
            showNotification('Cover downloaded successfully!', 'success');
        }

        function downloadForPlatform(type) {
            const coverImg = document.getElementById('generatedCover');
            if (!coverImg.src) {
                showNotification('No cover to download', 'error');
                return;
            }

            const title = document.getElementById('coverTitle')?.value || 'book-cover';
            const filename = type === 'print' ? 
                `${title}-print-ready.png` : 
                `${title}-web-optimized.png`;
            
            downloadImage(coverImg.src, filename);
            showNotification(`${type === 'print' ? 'Print-ready' : 'Web-optimized'} cover downloaded!`, 'success');
        }

        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setCoverAsMain() {
            const coverImg = document.getElementById('generatedCover');
            if (coverImg.src) {
                // Store the cover URL for use in other parts of the app
                localStorage.setItem('mainBookCover', coverImg.src);
                showNotification('Cover set as main book cover!', 'success');
            }
        }

        // Helper function to get OpenAI API key
        function getOpenAIApiKey() {
            return localStorage.getItem('openaiApiKey') || '';
        }

        // OpenAI GPT-4 Writing Assistance Functions
        async function generateChapterPlan() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key in Config section first', 'error');
                return;
            }

            const title = document.getElementById('bookTitle')?.value?.trim();
            const outline = document.getElementById('storyOutline')?.value?.trim();
            const genre = document.getElementById('genre')?.value || 'fiction-literary';
            const tone = document.getElementById('tone')?.value || 'professional';
            const chapterCount = parseInt(document.getElementById('chapterCount')?.value || 10);
            const wordsPerChapter = parseInt(document.getElementById('wordsPerChapter')?.value || 1000);

            if (!title || !outline) {
                showNotification('Please fill in the book title and story outline', 'error');
                return;
            }

            showNotification('Generating AI chapter plan...', 'info');
            
            const prompt = `Create a detailed chapter plan for a ${genre} book titled "${title}".

Story Outline: ${outline}
Tone: ${tone}
Number of chapters: ${chapterCount}
Target words per chapter: ${wordsPerChapter}

Generate a comprehensive chapter plan with:
1. Chapter titles
2. Brief chapter summaries (2-3 sentences each)
3. Key plot points and character development
4. Pacing and story arc progression

IMPORTANT: Respond with ONLY valid JSON, no markdown formatting or explanations.

JSON Structure:
{
  "chapters": [
    {
      "number": 1,
      "title": "Chapter Title",
      "summary": "Chapter summary...",
      "keyPoints": ["Point 1", "Point 2"],
      "wordCount": ${wordsPerChapter}
    }
  ]
}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content: "You are a professional book planning assistant. Create detailed, engaging chapter plans that follow proper story structure and pacing. Always respond with valid JSON only, no markdown formatting or code blocks."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status}`);
                }

                const data = await response.json();
                let content = data.choices[0].message.content;
                
                // Clean the response - remove markdown formatting
                content = content.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
                
                // Additional cleaning for common AI response issues
                content = content.replace(/^Here's.*?:/gi, '').trim();
                content = content.replace(/^Based on.*?:/gi, '').trim();
                
                let chapterPlan;
                try {
                    chapterPlan = JSON.parse(content);
                } catch (parseError) {
                    console.error('JSON parsing failed, raw content:', content);
                    throw new Error('Invalid JSON response from AI. Please try again.');
                }
                
                displayChapterPlan(chapterPlan);
                showNotification('Chapter plan generated successfully!', 'success');
                
            } catch (error) {
                console.error('Chapter generation error:', error);
                showNotification(`Failed to generate chapters: ${error.message}`, 'error');
            }
        }

        function displayChapterPlan(chapterPlan) {
            const chaptersContainer = document.getElementById('chaptersContainer');
            if (!chaptersContainer) return;

            chaptersContainer.innerHTML = '';
            storyData.chapters = chapterPlan.chapters;

            chapterPlan.chapters.forEach(chapter => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-card bg-theme-primary p-4 rounded-lg border border-theme';
                chapterDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg">${chapter.number}. ${chapter.title}</h3>
                        <span class="text-xs text-theme-secondary">${chapter.wordCount} words</span>
                    </div>
                    <p class="text-sm text-theme-secondary mb-2">${chapter.summary}</p>
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${chapter.keyPoints.map(point => 
                            `<span class="text-xs bg-cyan-900 text-cyan-300 px-2 py-1 rounded">${point}</span>`
                        ).join('')}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="generateChapterContent(${chapter.number})" class="btn-primary text-xs px-3 py-1 rounded">
                            <i class="fas fa-magic mr-1"></i>Generate Content
                        </button>
                        <button onclick="editChapter(${chapter.number})" class="btn-secondary text-xs px-3 py-1 rounded">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                    </div>
                `;
                chaptersContainer.appendChild(chapterDiv);
            });
        }

        // OpenAI TTS (Text-to-Speech) Functions
        async function generateFullNarration() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            if (!storyData.chapters || storyData.chapters.length === 0) {
                showNotification('Please generate chapter content first', 'error');
                return;
            }

            const voice = document.getElementById('voiceSelection')?.value || 'alloy';
            const speed = parseFloat(document.getElementById('speechRate')?.value || 1.0);
            
            showNotification('Starting AI narration generation...', 'info');
            
            const progressDiv = document.getElementById('narrationProgress');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            progressDiv.classList.remove('hidden');
            
            try {
                const audioFiles = [];
                
                for (let i = 0; i < storyData.chapters.length; i++) {
                    const chapter = storyData.chapters[i];
                    
                    progressPercent.textContent = `${Math.round((i / storyData.chapters.length) * 100)}%`;
                    progressBar.style.width = `${(i / storyData.chapters.length) * 100}%`;
                    
                    if (chapter.content) {
                        const audioBlob = await generateChapterAudio(chapter.content, voice, speed, apiKey);
                        audioFiles.push({
                            chapter: i + 1,
                            title: chapter.title,
                            audioBlob: audioBlob,
                            url: URL.createObjectURL(audioBlob)
                        });
                        
                        displayAudioResult(audioFiles[audioFiles.length - 1]);
                    }
                }
                
                progressPercent.textContent = '100%';
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    showNotification('All chapters narrated successfully!', 'success');
                }, 1000);
                
            } catch (error) {
                progressDiv.classList.add('hidden');
                console.error('Narration error:', error);
                showNotification(`Narration failed: ${error.message}`, 'error');
            }
        }

        async function generateChapterAudio(text, voice, speed, apiKey) {
            const response = await fetch('https://api.openai.com/v1/audio/speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "tts-1-hd",
                    input: text,
                    voice: voice,
                    speed: speed
                })
            });

            if (!response.ok) {
                throw new Error(`TTS API Error: ${response.status}`);
            }

            return await response.blob();
        }

        function displayAudioResult(audioData) {
            const resultsContainer = document.getElementById('audioResults');
            const audioDiv = document.createElement('div');
            audioDiv.className = 'audio-result bg-theme-primary p-4 rounded-lg border border-theme';
            audioDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold">Chapter ${audioData.chapter}: ${audioData.title}</h4>
                    <span class="text-xs text-theme-secondary">Generated</span>
                </div>
                <audio controls class="w-full mb-2">
                    <source src="${audioData.url}" type="audio/mpeg">
                </audio>
                <div class="flex space-x-2">
                    <button onclick="downloadAudio('${audioData.url}', 'chapter-${audioData.chapter}')" class="btn-secondary text-xs px-3 py-1 rounded">
                        <i class="fas fa-download mr-1"></i>Download
                    </button>
                    <button onclick="regenerateChapterAudio(${audioData.chapter})" class="btn-secondary text-xs px-3 py-1 rounded">
                        <i class="fas fa-sync mr-1"></i>Regenerate
                    </button>
                </div>
            `;
            resultsContainer.appendChild(audioDiv);
        }

        function downloadAudio(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}.mp3`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Enhanced Chapter Content Generation
        async function generateChapterContent(chapterNumber) {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            const chapter = storyData.chapters.find(c => c.number === chapterNumber);
            if (!chapter) return;

            showNotification(`Generating content for Chapter ${chapterNumber}...`, 'info');

            const prompt = `Write the full content for this chapter of the book "${storyData.title}".

Chapter ${chapter.number}: ${chapter.title}
Summary: ${chapter.summary}
Key Points: ${chapter.keyPoints.join(', ')}
Target Word Count: ${chapter.wordCount}
Genre: ${document.getElementById('genre')?.value}
Tone: ${document.getElementById('tone')?.value}

Write engaging, well-structured prose that:
1. Follows the chapter summary and incorporates all key points
2. Maintains consistent tone and style
3. Includes dialogue, descriptions, and narrative flow
4. Meets the target word count
5. Ends with a natural transition to the next chapter

Format as clean, readable text ready for narration.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system", 
                                content: "You are a professional author and storyteller. Write compelling, well-crafted chapter content that engages readers and flows naturally."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API Error: ${response.status}`);
                }

                const data = await response.json();
                chapter.content = data.choices[0].message.content;
                
                updateChapterDisplay(chapterNumber);
                showNotification(`Chapter ${chapterNumber} content generated!`, 'success');
                
            } catch (error) {
                console.error('Content generation error:', error);
                showNotification(`Failed to generate content: ${error.message}`, 'error');
            }
        }

        function updateChapterDisplay(chapterNumber) {
            const chapterCards = document.querySelectorAll('.chapter-card');
            const targetCard = chapterCards[chapterNumber - 1];
            
            if (targetCard) {
                const generateBtn = targetCard.querySelector('button');
                generateBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Content Ready';
                generateBtn.classList.remove('btn-primary');
                generateBtn.classList.add('btn-success');
                generateBtn.disabled = true;
            }
        }

        // Config Page Functions
        function saveSettings() {
            const apiKey = document.getElementById('openaiKey')?.value?.trim();
            const model = document.getElementById('modelSelection')?.value;
            const autoSave = document.getElementById('autoSave')?.checked;
            
            if (apiKey) {
                localStorage.setItem('openaiApiKey', apiKey);
            }
            if (model) {
                localStorage.setItem('selectedModel', model);
            }
            localStorage.setItem('autoSave', autoSave);
            
            showNotification('Settings saved successfully!', 'success');
            
            // Mask the API key display for security
            const keyInput = document.getElementById('openaiKey');
            if (keyInput && apiKey) {
                keyInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + apiKey.slice(-4);
            }
        }

        function loadSettings() {
            const apiKey = localStorage.getItem('openaiApiKey');
            const model = localStorage.getItem('selectedModel');
            const autoSave = localStorage.getItem('autoSave');
            
            if (apiKey) {
                const keyInput = document.getElementById('openaiKey');
                if (keyInput) {
                    keyInput.value = '••••••••••••••••••••••••••••••••••••••••••••••••••••' + apiKey.slice(-4);
                }
            }
            
            if (model) {
                const modelSelect = document.getElementById('modelSelection');
                if (modelSelect) {
                    modelSelect.value = model;
                }
            }
            
            if (autoSave !== null) {
                const autoSaveCheckbox = document.getElementById('autoSave');
                if (autoSaveCheckbox) {
                    autoSaveCheckbox.checked = autoSave === 'true';
                }
            }
        }

        async function testApiConnection() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please enter your OpenAI API key first', 'error');
                return;
            }

            showNotification('Testing API connection...', 'info');

            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('✅ API connection successful!', 'success');
                } else {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                showNotification(`❌ API connection failed: ${error.message}`, 'error');
            }
        }

        // Text Drag & Drop Functions
        function handleTextDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            const text = event.dataTransfer.getData('text/plain');
            
            if (files.length > 0) {
                // Handle file drop
                const file = files[0];
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const textArea = document.getElementById('cloneTextInput');
                        if (textArea) {
                            textArea.value = e.target.result;
                            updateCharCount();
                        }
                        showNotification(`Text file "${file.name}" loaded successfully!`, 'success');
                    };
                    reader.readAsText(file);
                } else {
                    showNotification('Please drop a .txt file', 'error');
                }
            } else if (text) {
                // Handle text drop
                const textArea = document.getElementById('cloneTextInput');
                if (textArea) {
                    textArea.value = text;
                    updateCharCount();
                }
                showNotification('Text added successfully!', 'success');
            }
        }

        function updateCharCount() {
            const textArea = document.getElementById('cloneTextInput');
            const charCount = document.getElementById('textCharCount');
            
            if (textArea && charCount) {
                const text = textArea.value;
                charCount.textContent = `${text.length} characters`;
            }
        }

        async function previewCloneText() {
            const text = document.getElementById('cloneTextInput')?.value?.trim();
            if (!text) {
                showNotification('Please enter some text to preview', 'error');
                return;
            }

            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            showNotification('Generating voice preview...', 'info');

            try {
                const voice = document.getElementById('voiceSelection')?.value || 'alloy';
                const speed = parseFloat(document.getElementById('speechRate')?.value || 1.0);
                
                const audioBlob = await generateChapterAudio(text, voice, speed, apiKey);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Play the preview
                const audio = new Audio(audioUrl);
                audio.play();
                
                showNotification('Voice preview generated successfully!', 'success');
            } catch (error) {
                showNotification(`Preview failed: ${error.message}`, 'error');
            }
        }

        // Voice Preview Functions
        async function previewSelectedVoice() {
            const apiKey = getOpenAIApiKey();
            if (!apiKey) {
                showNotification('Please configure your OpenAI API key first', 'error');
                return;
            }

            const voice = document.getElementById('voiceSelection')?.value || 'alloy';
            const previewText = `Hello, this is a preview of the ${voice} voice. This voice will be used to narrate your audiobook with professional quality and clarity.`;

            showNotification(`Generating ${voice} voice preview...`, 'info');

            try {
                const audioBlob = await generateChapterAudio(previewText, voice, 1.0, apiKey);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const previewPlayer = document.getElementById('voicePreviewPlayer');
                const audioSource = document.getElementById('voicePreviewSource');
                
                audioSource.src = audioUrl;
                previewPlayer.classList.remove('hidden');
                
                // Auto-play the preview
                const audioElement = previewPlayer.querySelector('audio');
                audioElement.load();
                audioElement.play();
                
                showNotification(`${voice} voice preview ready!`, 'success');
            } catch (error) {
                showNotification(`Voice preview failed: ${error.message}`, 'error');
            }
        }

        // Recording Functions
        let mediaRecorder;
        let recordedChunks = [];

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const recordedAudio = document.getElementById('recordedAudio');
                    const audioSource = document.getElementById('recordedAudioSource');
                    
                    audioSource.src = audioUrl;
                    recordedAudio.classList.remove('hidden');
                    
                    // Stop all tracks to release the microphone
                    stream.getTracks().forEach(track => track.stop());
                    
                    showNotification('Recording saved successfully!', 'success');
                };

                mediaRecorder.start();
                
                // Update UI
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.remove('hidden');
                document.getElementById('recordingWave').classList.remove('hidden');
                
                showNotification('Recording started...', 'info');
                
            } catch (error) {
                showNotification(`Recording failed: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                
                // Update UI
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingIndicator').classList.add('hidden');
                document.getElementById('recordingWave').classList.add('hidden');
            }
        }

        // Enhanced getOpenAIApiKey function
        function getOpenAIApiKey() {
            const storedKey = localStorage.getItem('openaiApiKey');
            if (storedKey && storedKey.startsWith('••••')) {
                // If the key is masked, we need the user to re-enter it
                showNotification('Please re-enter your API key in the Config section', 'error');
                return null;
            }
            return storedKey;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            
            // Add text area listener for character count
            const textArea = document.getElementById('cloneTextInput');
            if (textArea) {
                textArea.addEventListener('input', updateCharCount);
            }
        });

        // Notification System
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            // Set colors based on type
            const colors = {
                'success': 'bg-green-600 text-white border-green-500',
                'error': 'bg-red-600 text-white border-red-500',
                'warning': 'bg-yellow-600 text-white border-yellow-500',
                'info': 'bg-blue-600 text-white border-blue-500'
            };
            
            const icons = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${icons[type] || icons.info} mr-3"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
